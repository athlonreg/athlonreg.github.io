<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Canvas&#39;s Blog</title>
  
  <subtitle>å¥—é™†çš„åšå®¢</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.cloudops.ml/"/>
  <updated>2019-08-11T14:04:48.905Z</updated>
  <id>https://blog.cloudops.ml/</id>
  
  <author>
    <name>Canvas/å¥—é™†</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Openldap æ•°æ®è¿ç§»</title>
    <link href="https://blog.cloudops.ml/Openldap-backup-and-recovery-data.html"/>
    <id>https://blog.cloudops.ml/Openldap-backup-and-recovery-data.html</id>
    <published>2019-08-11T14:03:49.000Z</published>
    <updated>2019-08-11T14:04:48.905Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slapcat &gt; ldapbak.ldif            // å¯¼å‡º</span></span><br><span class="line"><span class="comment"># systemctl stop slapd              // åœæ­¢æœåŠ¡</span></span><br><span class="line"><span class="comment"># rm -rf /var/lib/ldap/*            // åˆ é™¤åŸæœ‰æ•°æ®</span></span><br><span class="line"><span class="comment"># slapadd -l ldapbak.ldif           // å¯¼å…¥æ•°æ®</span></span><br><span class="line"><span class="comment"># chown -R ldap:ldap /var/lib/ldap  // ä¿®å¤æƒé™</span></span><br><span class="line"><span class="comment"># systemctl start slapd             // å¯åŠ¨æœåŠ¡</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      Openldap æ•°æ®è¿ç§»
    
    </summary>
    
      <category term="openldap" scheme="https://blog.cloudops.ml/categories/openldap/"/>
    
      <category term="æ•°æ®è¿ç§»" scheme="https://blog.cloudops.ml/categories/openldap/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    
    
      <category term="openldap" scheme="https://blog.cloudops.ml/tags/openldap/"/>
    
      <category term="æ•°æ®è¿ç§»" scheme="https://blog.cloudops.ml/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7 Docker é•œåƒä½¿ç”¨ systemd æœåŠ¡</title>
    <link href="https://blog.cloudops.ml/Centos7-docker-image-with-systemd.html"/>
    <id>https://blog.cloudops.ml/Centos7-docker-image-with-systemd.html</id>
    <published>2019-08-11T14:00:16.000Z</published>
    <updated>2019-08-11T14:01:56.518Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">ENV container docker</span><br><span class="line">RUN (<span class="built_in">cd</span> /lib/systemd/system/sysinit.target.wants/; <span class="keyword">for</span> i <span class="keyword">in</span> *; <span class="keyword">do</span> [ <span class="variable">$i</span> == \</span><br><span class="line">systemd-tmpfiles-setup.service ] || rm -f <span class="variable">$i</span>; <span class="keyword">done</span>); \</span><br><span class="line">rm -f /lib/systemd/system/multi-user.target.wants/*;\</span><br><span class="line">rm -f /etc/systemd/system/*.wants/*;\</span><br><span class="line">rm -f /lib/systemd/system/<span class="built_in">local</span>-fs.target.wants/*; \</span><br><span class="line">rm -f /lib/systemd/system/sockets.target.wants/*udev*; \</span><br><span class="line">rm -f /lib/systemd/system/sockets.target.wants/*initctl*; \</span><br><span class="line">rm -f /lib/systemd/system/basic.target.wants/*;\</span><br><span class="line">rm -f /lib/systemd/system/anaconda.target.wants/*;</span><br><span class="line">VOLUME [ <span class="string">"/sys/fs/cgroup"</span> ]</span><br><span class="line">CMD [<span class="string">"/usr/sbin/init"</span>]</span><br></pre></td></tr></table></figure><h1 id="Build-Command"><a href="#Build-Command" class="headerlink" title="Build Command"></a>Build Command</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker build --rm -t zhanghl/centos7.6.1810 /path/of/Dockerfile</span></span><br></pre></td></tr></table></figure><h1 id="Example-Apache-Systemd-Service-To-Run"><a href="#Example-Apache-Systemd-Service-To-Run" class="headerlink" title="Example Apache Systemd Service To Run"></a>Example Apache Systemd Service To Run</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker run -it -d --privileged -v /sys/fs/cgroup:/sys/fs/cgroup --name centos7 -p 80:80 centos7.6.1810:latest /usr/sbin/init</span></span><br><span class="line"><span class="comment"># docker exec -it centos /bin/bash</span></span><br><span class="line">docker<span class="comment"># yum -y install httpd</span></span><br><span class="line">docker<span class="comment"># systemctl start httpd</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      CentOS7 Docker é•œåƒä½¿ç”¨ systemd æœåŠ¡
    
    </summary>
    
      <category term="Docker" scheme="https://blog.cloudops.ml/categories/Docker/"/>
    
    
      <category term="docker" scheme="https://blog.cloudops.ml/tags/docker/"/>
    
      <category term="centos" scheme="https://blog.cloudops.ml/tags/centos/"/>
    
      <category term="systemd" scheme="https://blog.cloudops.ml/tags/systemd/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat SonarQube Gerrit è®¾ç½® systemd æœåŠ¡</title>
    <link href="https://blog.cloudops.ml/Systemd-service-file-of-sonar-gerrit-and-tomcat.html"/>
    <id>https://blog.cloudops.ml/Systemd-service-file-of-sonar-gerrit-and-tomcat.html</id>
    <published>2019-08-11T13:55:08.000Z</published>
    <updated>2019-08-11T13:58:53.329Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/lib/systemd/system/tomcat.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Tomcat</span><br><span class="line">After=network.target</span><br><span class="line">  </span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/tomcat/bin/startup.sh</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/tomcat/bin/shutdown.sh</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">RemainAfterExit=yes</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="SonarQube"><a href="#SonarQube" class="headerlink" title="SonarQube"></a>SonarQube</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/lib/systemd/system/sonar.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=SonarQube</span><br><span class="line">After=network.target</span><br><span class="line">  </span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/sonarqube-7.5/bin/linux-x86-64/sonar.sh start</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/sonarqube-7.5/bin/linux-x86-64/sonar.sh stop</span><br><span class="line">ExecReload=/usr/<span class="built_in">local</span>/sonarqube-7.5/bin/linux-x86-64/sonar.sh restart</span><br><span class="line">User=sonar</span><br><span class="line">Group=sonar</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=sonarqube</span><br></pre></td></tr></table></figure><h2 id="Gerrit-Code-Review"><a href="#Gerrit-Code-Review" class="headerlink" title="Gerrit Code Review"></a>Gerrit Code Review</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/lib/systemd/system/gerrit.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Gerrit Code Review</span><br><span class="line">After=network.target httpd.service</span><br><span class="line">  </span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/review_site/bin/gerrit.sh start</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/review_site/bin/gerrit.sh stop</span><br><span class="line">ExecReload=/usr/<span class="built_in">local</span>/review_site/bin/gerrit.sh restart</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      Tomcat SonarQube Gerrit è®¾ç½® systemd æœåŠ¡
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="systemd" scheme="https://blog.cloudops.ml/tags/systemd/"/>
    
      <category term="tomcat" scheme="https://blog.cloudops.ml/tags/tomcat/"/>
    
      <category term="sonar" scheme="https://blog.cloudops.ml/tags/sonar/"/>
    
      <category term="sonarqube" scheme="https://blog.cloudops.ml/tags/sonarqube/"/>
    
      <category term="gerrit" scheme="https://blog.cloudops.ml/tags/gerrit/"/>
    
  </entry>
  
  <entry>
    <title>Nginx å¼€å¯ç›®å½•æµè§ˆåŠŸèƒ½</title>
    <link href="https://blog.cloudops.ml/Nginx-enable-directory-browser-function.html"/>
    <id>https://blog.cloudops.ml/Nginx-enable-directory-browser-function.html</id>
    <published>2019-08-11T13:53:09.000Z</published>
    <updated>2019-08-11T13:54:22.629Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><blockquote><p>ç¼–è¾‘ nginx é…ç½®æ–‡ä»¶</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ http ä¸‹é¢åŠ å…¥ä»¥ä¸‹é…ç½®</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">autoindex on;</span><br><span class="line">autoindex_exact_size off;</span><br><span class="line">autoindex_localtime on;</span><br></pre></td></tr></table></figure><blockquote><p>å®Œæ•´é…ç½®å®ä¾‹</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"># For more information on configuration, see:</span><br><span class="line">#   * Official English Documentation: http://nginx.org/en/docs/</span><br><span class="line">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span><br><span class="line"></span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"># Load dynamic modules. See /usr/share/nginx/README.dynamic.</span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size off;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       81 default_server;</span><br><span class="line">        listen       [::]:81 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"># Settings for a TLS enabled server.</span><br><span class="line">#</span><br><span class="line">#    server &#123;</span><br><span class="line">#        listen       443 ssl http2 default_server;</span><br><span class="line">#        listen       [::]:443 ssl http2 default_server;</span><br><span class="line">#        server_name  _;</span><br><span class="line">#        root         /usr/share/nginx/html;</span><br><span class="line">#</span><br><span class="line">#        ssl_certificate &quot;/etc/pki/nginx/server.crt&quot;;</span><br><span class="line">#        ssl_certificate_key &quot;/etc/pki/nginx/private/server.key&quot;;</span><br><span class="line">#        ssl_session_cache shared:SSL:1m;</span><br><span class="line">#        ssl_session_timeout  10m;</span><br><span class="line">#        ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">#        ssl_prefer_server_ciphers on;</span><br><span class="line">#</span><br><span class="line">#        # Load configuration files for the default server block.</span><br><span class="line">#        include /etc/nginx/default.d/*.conf;</span><br><span class="line">#</span><br><span class="line">#        location / &#123;</span><br><span class="line">#        &#125;</span><br><span class="line">#</span><br><span class="line">#        error_page 404 /404.html;</span><br><span class="line">#            location = /40x.html &#123;</span><br><span class="line">#        &#125;</span><br><span class="line">#</span><br><span class="line">#        error_page 500 502 503 504 /50x.html;</span><br><span class="line">#            location = /50x.html &#123;</span><br><span class="line">#        &#125;</span><br><span class="line">#    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      Nginx å¼€å¯ç›®å½•æµè§ˆåŠŸèƒ½
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="nginx" scheme="https://blog.cloudops.ml/tags/nginx/"/>
    
      <category term="ç›®å½•æµè§ˆ" scheme="https://blog.cloudops.ml/tags/%E7%9B%AE%E5%BD%95%E6%B5%8F%E8%A7%88/"/>
    
  </entry>
  
  <entry>
    <title>ä¿®å¤ Hexo å¾®åšå›¾åºŠå›¾ç‰‡é“¾æ¥å¤±æ•ˆé—®é¢˜</title>
    <link href="https://blog.cloudops.ml/Fix-the-pictures-can-not-show-in-hexo-with-sina-weibo-picbed.html"/>
    <id>https://blog.cloudops.ml/Fix-the-pictures-can-not-show-in-hexo-with-sina-weibo-picbed.html</id>
    <published>2019-08-11T13:49:22.000Z</published>
    <updated>2019-08-11T13:51:10.341Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><blockquote><p>ä¿®æ”¹ä¸»é¢˜ head æ–‡ä»¶</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /Users/canvas/athlonreg/themes/next/layout/_partials/head/head.swig</span></span><br></pre></td></tr></table></figure><blockquote><p>æ·»åŠ å¦‚ä¸‹è¡Œ</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"referrer"</span> <span class="attr">content</span>=<span class="string">"no-referrer"</span> /&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>å¦‚å›¾æ‰€ç¤º</p></blockquote><p><img src="https://ws1.sinaimg.cn/large/006yd6wMly1g4dszk5a0mj31eo0gegq3.jpg" alt></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      ä¿®å¤ Hexo å¾®åšå›¾åºŠå›¾ç‰‡é“¾æ¥å¤±æ•ˆé—®é¢˜
    
    </summary>
    
      <category term="å­¦ä¹ " scheme="https://blog.cloudops.ml/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="å›¾åºŠ" scheme="https://blog.cloudops.ml/tags/%E5%9B%BE%E5%BA%8A/"/>
    
  </entry>
  
  <entry>
    <title>æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ˜¯è™šæ‹Ÿæœºè¿˜æ˜¯å®ä½“æœº</title>
    <link href="https://blog.cloudops.ml/Check-current-system-is-vm-or-real.html"/>
    <id>https://blog.cloudops.ml/Check-current-system-is-vm-or-real.html</id>
    <published>2019-08-11T13:47:02.000Z</published>
    <updated>2019-08-11T13:47:57.445Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmidecode -s system-product-name</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ˜¯è™šæ‹Ÿæœºè¿˜æ˜¯å®ä½“æœº
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>è®¾ç½® postgresql é€šè¿‡å¯†ç ç™»å½•</title>
    <link href="https://blog.cloudops.ml/Setup-postgresql-login-by-password.html"/>
    <id>https://blog.cloudops.ml/Setup-postgresql-login-by-password.html</id>
    <published>2019-08-11T13:44:43.000Z</published>
    <updated>2019-08-11T13:46:06.264Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><blockquote><p>ä¿®æ”¹æ–‡ä»¶ pg_hba.conf</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">local all all md5</span><br><span class="line">host  all all 127.0.0.1/32 md5</span><br><span class="line">host all all 192.168.45.0/32 md5</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      è®¾ç½® postgresql é€šè¿‡å¯†ç ç™»å½•
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="postgresql" scheme="https://blog.cloudops.ml/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>CentOS éƒ¨ç½²é…ç½® Redmine</title>
    <link href="https://blog.cloudops.ml/Deploy-redmine-on-CentOS7.html"/>
    <id>https://blog.cloudops.ml/Deploy-redmine-on-CentOS7.html</id>
    <published>2019-08-11T13:38:16.000Z</published>
    <updated>2019-08-11T13:43:12.923Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="å®‰è£…-Ruby-2-4"><a href="#å®‰è£…-Ruby-2-4" class="headerlink" title="å®‰è£… Ruby 2.4"></a>å®‰è£… Ruby 2.4</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc-c++ patch readline readline-devel zlib zlib-devel libyaml-devel libffi-devel openssl-devel make bzip2 autoconf automake libtool bison ImageMagick-devel  ImageMagick</span><br><span class="line">yum -y install centos-release-scl-rh</span><br><span class="line">yum -y install rh-ruby24 </span><br><span class="line">scl <span class="built_in">enable</span> rh-ruby24 bash</span><br><span class="line">ruby -v </span><br><span class="line">yum -y install rh-ruby24-rubygems rh-ruby24-ruby-devel</span><br><span class="line">gem <span class="built_in">source</span> -l</span><br><span class="line">gem sources -a http://mirrors.aliyun.com/rubygems/</span><br><span class="line">gem sources --remove  https://rubygems.org/</span><br><span class="line">gem <span class="built_in">source</span> -u</span><br><span class="line">gem <span class="built_in">source</span> -l</span><br></pre></td></tr></table></figure><h2 id="è®¾ç½®æ•°æ®åº“"><a href="#è®¾ç½®æ•°æ®åº“" class="headerlink" title="è®¾ç½®æ•°æ®åº“"></a>è®¾ç½®æ•°æ®åº“</h2><blockquote><p>å»ºç«‹ç›¸åº”æ•°æ®åº“</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;redmine&apos;@&apos;%&apos; identified by &apos;123456&apos; ;</span><br><span class="line">mysql&gt; create database redmine;</span><br><span class="line">mysql&gt; grant all on redmine.* to &apos;redmine&apos;@&apos;%&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…-redmine"><a href="#å®‰è£…-redmine" class="headerlink" title="å®‰è£… redmine"></a>å®‰è£… redmine</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span></span><br><span class="line">wget https://www.redmine.org/releases/redmine-4.0.4.tar.gz</span><br><span class="line">tar zxvf redmine-4.0.4.tar.gz</span><br><span class="line">mv redmine-4.0.4 redmine</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export REDMINE=/usr/local/redmine"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$REDMINE</span></span><br><span class="line">cp config/database.yml.example config/database.yml</span><br></pre></td></tr></table></figure><blockquote><p>é…ç½® redmineï¼Œä¿®æ”¹ $REDMINE/config/database.yml</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">production:</span></span><br><span class="line"><span class="attr">  adapter:</span> <span class="string">mysql2</span></span><br><span class="line"><span class="attr">  database:</span> <span class="string">redmine</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">redmine</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">"123456"</span></span><br></pre></td></tr></table></figure><h2 id="å®‰è£…-GEMS-ä¾èµ–"><a href="#å®‰è£…-GEMS-ä¾èµ–" class="headerlink" title="å®‰è£… GEMS ä¾èµ–"></a>å®‰è£… GEMS ä¾èµ–</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$REDMINE</span></span><br><span class="line">gem install bundler</span><br><span class="line">bundle install --without development <span class="built_in">test</span> production</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆä¼šè¯å­˜å‚¨ç§˜é’¥ä»¤ç‰Œ"><a href="#ç”Ÿæˆä¼šè¯å­˜å‚¨ç§˜é’¥ä»¤ç‰Œ" class="headerlink" title="ç”Ÿæˆä¼šè¯å­˜å‚¨ç§˜é’¥ä»¤ç‰Œ"></a>ç”Ÿæˆä¼šè¯å­˜å‚¨ç§˜é’¥ä»¤ç‰Œ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle <span class="built_in">exec</span> rake generate_secret_token</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆæ•°æ®åº“ç»“æ„"><a href="#ç”Ÿæˆæ•°æ®åº“ç»“æ„" class="headerlink" title="ç”Ÿæˆæ•°æ®åº“ç»“æ„"></a>ç”Ÿæˆæ•°æ®åº“ç»“æ„</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAILS_ENV=production REDMINE_LANG=zh bundle <span class="built_in">exec</span> rake db:migrate</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®åº“æ’å…¥é»˜è®¤æ•°æ®"><a href="#æ•°æ®åº“æ’å…¥é»˜è®¤æ•°æ®" class="headerlink" title="æ•°æ®åº“æ’å…¥é»˜è®¤æ•°æ®"></a>æ•°æ®åº“æ’å…¥é»˜è®¤æ•°æ®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAILS_ENV=production REDMINE_LANG=zh bundle <span class="built_in">exec</span> rake redmine:load_default_data</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨-redmine"><a href="#å¯åŠ¨-redmine" class="headerlink" title="å¯åŠ¨ redmine"></a>å¯åŠ¨ redmine</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle <span class="built_in">exec</span> rails server webrick -e production -b 127.0.0.1</span><br></pre></td></tr></table></figure><h2 id="é…ç½®-LDAP-è®¤è¯"><a href="#é…ç½®-LDAP-è®¤è¯" class="headerlink" title="é…ç½® LDAP è®¤è¯"></a>é…ç½® LDAP è®¤è¯</h2><blockquote><p>ä¾æ¬¡æ‰“å¼€ ç®¡ç† -&gt; LDAP è®¤è¯ -&gt; æ–°å»ºè®¤è¯æ¨¡å¼</p></blockquote><p>é…ç½®ä¸€ä¸ª ou=admin çš„é…ç½®å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/20190705161009.png" alt></p><p>åŒæ ·çš„æ–¹æ³•é…ç½®æ‰€éœ€è¦çš„æ‰€æœ‰ ouï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/20190705161320.png" alt></p><h2 id="é…ç½®-CAS-SSO"><a href="#é…ç½®-CAS-SSO" class="headerlink" title="é…ç½® CAS SSO"></a>é…ç½® CAS SSO</h2><blockquote><p>å®‰è£…æ’ä»¶</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$REDMINE</span>/plugins</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/athlonreg/redmine_omniauth_cas</span><br><span class="line"><span class="built_in">cd</span> redmine_omniauth_cas</span><br><span class="line">bundle install</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$REDMINE</span></span><br><span class="line">bundle install</span><br><span class="line">RAILS_ENV=production rake redmine:plugins</span><br><span class="line">bundle <span class="built_in">exec</span> rails server webrick -e production -b 127.0.0.1</span><br></pre></td></tr></table></figure><blockquote><p>ä¾æ¬¡æ‰“å¼€ ç®¡ç† -&gt; æ’ä»¶ï¼Œç‚¹å‡»æ’ä»¶ Redmine Omniauth plugin åçš„é…ç½®</p></blockquote><p>é…ç½®å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/20190705162003.png" alt></p><blockquote><p>å„å­—æ®µå«ä¹‰å¯¹ç…§è¡¨</p></blockquote><table><thead><tr><th>å­—æ®µåç§°</th><th>å­—æ®µå«ä¹‰</th></tr></thead><tbody><tr><td>Enable CAS authentication</td><td>æ˜¯å¦å¯ç”¨ CAS è®¤è¯</td></tr><tr><td>CAS server URL</td><td>CAS æœåŠ¡å™¨åœ°å€</td></tr><tr><td>CAS validation URL (if different)</td><td>CAS æœåŠ¡å™¨èº«ä»½éªŒè¯æ¥å£åœ°å€</td></tr><tr><td>Login page text</td><td>ç™»é™†é¡µé¢æ ‡é¢˜</td></tr><tr><td>Replace Redmine login page</td><td>æ˜¯å¦ä½¿ç”¨ CAS æœåŠ¡å™¨çš„ç™»é™†ç•Œé¢æ›¿æ¢æ’ä»¶æä¾›çš„ç™»å½•ç•Œé¢</td></tr></tbody></table><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      CentOS éƒ¨ç½²é…ç½® Redmine é¡¹ç›®ç®¡ç†ç³»ç»Ÿ
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Redmine" scheme="https://blog.cloudops.ml/tags/Redmine/"/>
    
      <category term="é¡¹ç›®ç®¡ç†" scheme="https://blog.cloudops.ml/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/"/>
    
      <category term="æ•æ·å¼€å‘" scheme="https://blog.cloudops.ml/tags/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>CentOS å®‰è£…é…ç½® GitLab</title>
    <link href="https://blog.cloudops.ml/Setup-gitlab-to-support-frame.html"/>
    <id>https://blog.cloudops.ml/Setup-gitlab-to-support-frame.html</id>
    <published>2019-02-01T02:55:52.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="CentOS-å®‰è£…-GitLab"><a href="#CentOS-å®‰è£…-GitLab" class="headerlink" title="CentOS å®‰è£… GitLab"></a>CentOS å®‰è£… GitLab</h2><h2 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install curl</span></span><br><span class="line"><span class="comment"># yum -y install postfix</span></span><br><span class="line"><span class="comment"># systemctl start postfix</span></span><br><span class="line"><span class="comment"># systemctl enable postfix</span></span><br></pre></td></tr></table></figure><h3 id="ä¸‹è½½-GitLab-çš„-RPM-åŒ…"><a href="#ä¸‹è½½-GitLab-çš„-RPM-åŒ…" class="headerlink" title="ä¸‹è½½ GitLab çš„ RPM åŒ…"></a>ä¸‹è½½ GitLab çš„ RPM åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.7.0-ce.0.el7.x86_64.rpm</span></span><br></pre></td></tr></table></figure><p>åœ¨<span class="exturl" data-url="aHR0cHM6Ly9taXJyb3JzLnR1bmEudHNpbmdodWEuZWR1LmNuL2dpdGxhYi1jZS95dW0vZWw3Lw==" title="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/<i class="fa fa-external-link"></i></span>æ‰¾è‡ªå·±éœ€è¦çš„ç‰ˆæœ¬ï¼Œä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åå®‰è£…å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh  gitlab-ce-11.7.0-ce.0.el7.x86_64.rpm</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è¿™æ ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum localinstall gitlab-ce-11.7.0-ce.0.el7.x86_64.rpm</span></span><br></pre></td></tr></table></figure><h2 id="é…ç½®-gitlab-repo"><a href="#é…ç½®-gitlab-repo" class="headerlink" title="é…ç½® gitlab repo"></a>é…ç½® gitlab repo</h2><p>ä¸ºäº†åç»­å‡çº§æ–¹ä¾¿ï¼Œå»ºè®®æ·»åŠ <code>gitlab</code>çš„<code>repo</code>æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sh</span></span><br></pre></td></tr></table></figure><h2 id="ç«¯å£ä¿®æ”¹"><a href="#ç«¯å£ä¿®æ”¹" class="headerlink" title="ç«¯å£ä¿®æ”¹"></a>ç«¯å£ä¿®æ”¹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/gitlab/gitlab.rb</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸‹é¢çš„å±æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">external_url &apos;http://devops.iamzhl.top:8090&apos;</span><br><span class="line">unicorn[&apos;port&apos;] = 8070</span><br><span class="line">nginx[&apos;listen_port&apos;] = 8090</span><br></pre></td></tr></table></figure><p><em>è¯·æ ¹æ®ä¸ªäººéœ€è¦è¿›è¡Œå®šåˆ¶</em></p><h2 id="é‡æ–°éƒ¨ç½²å¹¶é‡å¯"><a href="#é‡æ–°éƒ¨ç½²å¹¶é‡å¯" class="headerlink" title="é‡æ–°éƒ¨ç½²å¹¶é‡å¯"></a>é‡æ–°éƒ¨ç½²å¹¶é‡å¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gitlab-ctl reconfigure</span></span><br><span class="line"><span class="comment"># gitlab-ctl restart</span></span><br></pre></td></tr></table></figure><h2 id="è®¾ç½®é¡µé¢åµŒå¥—æ”¯æŒ"><a href="#è®¾ç½®é¡µé¢åµŒå¥—æ”¯æŒ" class="headerlink" title="è®¾ç½®é¡µé¢åµŒå¥—æ”¯æŒ"></a>è®¾ç½®é¡µé¢åµŒå¥—æ”¯æŒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/opt/gitlab/nginx/conf/gitlab-http.conf</span></span><br></pre></td></tr></table></figure><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fzqr3dsb7gj31p818kgzc.jpg" alt></p><p>å¦‚å›¾ï¼Œæ·»åŠ æ ‡æ³¨çš„å±æ€§è®¾ç½®åé‡å¯<code>GitLab</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gitlab-ctl restart</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      CentOS å®‰è£…é…ç½® GitLab
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="GitLab" scheme="https://blog.cloudops.ml/tags/GitLab/"/>
    
      <category term="frame" scheme="https://blog.cloudops.ml/tags/frame/"/>
    
  </entry>
  
  <entry>
    <title>é«˜æ•ˆåˆ©ç”¨æœ‰é“äº‘ç¬”è®°</title>
    <link href="https://blog.cloudops.ml/How-to-use-youdao-note-in-a-special-way.html"/>
    <id>https://blog.cloudops.ml/How-to-use-youdao-note-in-a-special-way.html</id>
    <published>2019-01-20T13:12:25.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…ˆè¯´å‡ ä¸ªåšä¸»å’Œå…¶ä»–çš„ç å­—å†œæ°‘å·¥æ¯”è¾ƒå¤´ç–¼çš„é—®é¢˜</p><ul><li>äº‘åŒæ­¥</li></ul><p>ç°åœ¨æ˜¯äº‘çš„æ—¶ä»£ï¼Œæ²¡æœ‰äº‘åŒæ­¥çš„ç æ–‡ç¯å¢ƒä¸æ˜¯ä¸€ä¸ªå¥½çš„ç¯å¢ƒï¼Œå¯èƒ½æ¯ä¸ªäººéƒ½æœ‰ä¸æ­¢ä¸€ä¸ªç æ–‡å¹³å°ï¼Œæ¯”å¦‚å·¥ä½œé…çš„æœºå™¨å’Œç§äººçš„æœºå™¨ï¼Œæˆ‘åœ¨å…¶ä¸­ä¸€å°æœºå™¨å†™å¥½çš„æ–‡ç« è¿˜è¦å†å†™ä¸€ä»½åˆ°å¦å¤–çš„æœºå™¨ã€‚ã€‚ã€‚ç®€ç›´ä¸è¦å¤ªlowerã€‚å¯èƒ½æœ‰äººè¯´æˆ‘ä»¬ç”¨æŸåº¦ç½‘ç›˜ã€‚ã€‚ã€‚Whatâ€™s thatï¼Ÿå·²ç»æ”¾å¼ƒå¥½ä¹…ï¼Œæœ¬æ–‡ä¸åšèµ˜è¿°ï¼Œæƒ³ç”¨çš„å°±ç”¨å§ã€‚ã€‚ã€‚</p><ul><li>è·¨å¹³å°</li></ul><p>è¿™é‡Œå‡è®¾ä¸Šé¢çš„ç¯å¢ƒæˆç«‹ï¼Œä½ æœ‰ä¸¤å°æœºå™¨ï¼Œç§äººçš„æ˜¯Macç¯å¢ƒï¼Œå·¥ä½œæœºå™¨æ˜¯Windowsï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¹‹å‰æˆ‘åœ¨Macéå¸¸å–œæ¬¢MWebï¼Œå› ä¸ºå®ƒçš„å›¾åºŠé›†æˆè®©æˆ‘ç€è¿· ï¼Œæˆªå›¾ç²˜è´´ä¸€å¼ å¼•ç”¨å¤–é“¾çš„å›¾ç‰‡å°±è¿™ä¹ˆå®Œæˆäº†ï¼Œå°±æ˜¯è¿™ä¹ˆå¿«ï¼Œä½†æ˜¯ç°åœ¨ä¹Ÿå·²ç»æ”¾å¼ƒäº†ï¼Œå› ä¸ºWindowså¹³å°äººå®¶ä¸åšï¼Œä¸è¦é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œæˆ‘ä¸æƒ³å–·Windowså¤ªåƒåœ¾ğŸŒğŸŒä½†æ˜¯æ— å¥ˆå•ä½åªæœ‰Windowsï¼Œäºæ˜¯æˆ‘è¦ç”¨ä¸¤å¥—ç¯å¢ƒã€‚ã€‚ã€‚è®°ä½ä¸¤å¥—å¿«æ·é”®ã€‚ã€‚ã€‚</p><ul><li>MarkDown</li></ul><p>å…³äºMarkDownçš„ä»‹ç»è¿™é‡Œä¸èµ˜è¿°ã€‚äºæˆ‘è€Œè¨€ï¼Œä¸æ”¯æŒMarkDownè§£æçš„ç¼–è¾‘å™¨ï¼Œæˆ‘æ˜¯ç»å¯¹ä¸ä¼šç”¨çš„ï¼ŒWordå°±å·¥ä½œç”¨ç”¨ã€‚ã€‚ã€‚ä¸ºä½•å‘¢ï¼Ÿå› ä¸ºMarkDownå¤ªä¼˜é›…äº†ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼ŒWordå’ŒMarkDownå°±åƒ50å²çš„å¤§å¦ˆå’Œ20å²çš„å¦™é¾„å°‘å¥³ï¼Œå†™æ–‡æ¡£å‘åšæ–‡ç”¨Wordç®€ç›´æ˜¯é­ç½ªï¼Œç”¨MarkDownç®€ç›´æ˜¯äº«å—ï¼Œå½“ç„¶å•¦ï¼Œçº¯å±ä¸ªäººçœ‹æ³•ï¼Œä¸å–œå‹¿å–·ã€‚ã€‚ã€‚</p><ul><li>å›¾åºŠ</li></ul><p>è¯´å®Œäº†MarkDownå’Œäº‘çš„é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªé—®é¢˜å¾ˆæ˜æ˜¾ï¼Œäº‘ä¸Šçš„æ•°æ®æ–‡å­—å¯ä»¥ï¼Œå›¾ç‰‡ç”šè‡³è§†é¢‘æ€ä¹ˆåŠï¼Ÿéš¾é“æˆ‘è¿˜è¦ä¹°ä¸ªäº‘å­˜å‚¨ç”šè‡³æ˜¯äº‘æœåŠ¡å™¨ï¼Ÿå½“ç„¶ä¸ç”¨å•¦ï¼å›½å†…æœ‰äº›å¤§å…¬å¸è¿˜æ˜¯ç›¸å½“è‰¯å¿ƒçš„ï¼Œå…ˆç¥ç§˜ä¸€ä¸‹ï¼Œå…·ä½“ç”¨ä»€ä¹ˆï¼Œä¸‹é¢è¯¦ç»†è¯´ğŸ˜„</p><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ul><li>ç¼–è¾‘å™¨<ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cudHlwb3JhLmlv" title="https://www.typora.io">Typora<i class="fa fa-external-link"></i></span></li></ul></li><li>æˆªå›¾å·¥å…·<ul><li>Windowsï¼š<span class="exturl" data-url="aHR0cHM6Ly9zbmlwLnFxLmNvbQ==" title="https://snip.qq.com">Snip<i class="fa fa-external-link"></i></span></li><li>macOSï¼š<span class="exturl" data-url="aHR0cHM6Ly96aC54bmlwYXBwLmNvbQ==" title="https://zh.xnipapp.com">Xnip<i class="fa fa-external-link"></i></span></li></ul></li><li>å›¾åºŠ<ul><li>Sina Weoboè´¦å·(Sinaçš„å¾®åšå¹³å°æä¾›äº†ä¸€ä¸ªå›¾åºŠæœåŠ¡ï¼Œè‡ªå¸¦cdn)</li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01vbHVuZXJmaW5uL1BpY0dvL3JlbGVhc2Vz" title="https://github.com/Molunerfinn/PicGo/releases">PicGo<i class="fa fa-external-link"></i></span></li></ul></li><li>äº‘åŒæ­¥<ul><li><span class="exturl" data-url="aHR0cDovL25vdGUueW91ZGFvLmNvbQ==" title="http://note.youdao.com">æœ‰é“äº‘ç¬”è®°<i class="fa fa-external-link"></i></span></li></ul></li></ul><h2 id="é…ç½®PicGo"><a href="#é…ç½®PicGo" class="headerlink" title="é…ç½®PicGo"></a>é…ç½®PicGo</h2><p>å…¶ä»–çš„éƒ½æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè¯´ä¸€ä¸‹PicGoçš„é…ç½®å§ï¼é¦–å…ˆåœ¨æ–°æµªå¾®åšå®˜ç½‘ç™»å½•å¾®åšè´¦å·ï¼Œç„¶åæ‰“å¼€<span class="exturl" data-url="aHR0cHM6Ly93ZWliby5jb20vbWluaXB1Ymxpc2g=" title="https://weibo.com/minipublish">minipublish<i class="fa fa-external-link"></i></span>é¡µé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fzde3dq3hvj326w1e047w.jpg" alt></p><p>ç„¶åæ‰“å¼€è°ƒè¯•çª—å£ï¼Œ<code>Chrome</code>å¿«æ·é”®ä¸º<code>F12</code>ï¼Œç„¶åè°ƒåˆ°ç½‘ç»œé€‰é¡¹å¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fzde59wlkyj326w1e0gzx.jpg" alt></p><p>ç‚¹å‡»<code>minipublish</code>ï¼ŒæŸ¥çœ‹ä¸€ä¸‹Cookieå€¼å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fzde6i4je7j326w1e0tpj.jpg" alt></p><p>é€‰ä¸­Cookieåé¢é‚£ä¸€ä¸²å­—ç¬¦ï¼Œæ‹·è´ä¸€ä¸‹ï¼Œæ‰“å¼€<code>PicGo</code>çª—å£ï¼Œæ‰¾åˆ°å›¾åºŠè®¾ç½® -&gt; æ–°æµªå›¾åºŠï¼Œåœ¨Cookieåé¢çš„è¾“å…¥æ¡†ç²˜è´´åˆšæ‰çš„å­—ç¬¦ä¸²ï¼Œå‹¾é€‰cookieæ¨¡å¼ï¼Œç‚¹å‡»ç¡®å®š -&gt; è®¾ä¸ºé»˜è®¤å›¾åºŠï¼Œå¦‚ä¸‹å›¾</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fzde7rnurvj31eo0v847r.jpg" alt></p><p>è¿™æ—¶å€™ï¼Œç”¨å‰æ–‡æ‰€è¯´çš„æˆªå›¾å·¥å…·æˆ–è€…è‡ªå·±å–œæ¬¢çš„å·¥å…·æˆªå›¾ï¼Œç„¶åæŒ‰ä¸‹åˆšåˆšè®¾ç½®çš„å¿«æ·é”®ï¼Œå›¾ç‰‡å°±ä¼šä¸Šä¼ åˆ°æ–°æµªå¾®åšçš„å›¾åºŠæœåŠ¡å™¨ï¼Œç„¶åå°†å›¾ç‰‡çš„å¤–é“¾è¿”å›ç»™å‰ªè´´æ¿äº†ã€‚</p><p>åœ¨æœ‰é“äº‘éšä¾¿å»ºä¸€ä¸ªMarkDownæ–‡æ¡£ï¼Œç²˜è´´ä¸€ä¸‹ï¼Œå¦‚å›¾</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fzdem32mcej320w1e0nep.jpg" alt></p><p>æ–‡æ¡£ä¿å­˜åï¼Œæœ‰é“äº‘ç¬”è®°ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è¿›è¡Œäº‘åŒæ­¥ï¼Œä»æ­¤ä¸å¿…æ‹…å¿ƒå…¶3Gçš„ç©ºé—´ä¸å¤Ÿç”¨äº†ã€‚</p><p>å½“ç„¶å•¦ï¼Œå¿«æ·é”®æ ¹æ®ä¸ªäººä¹ æƒ¯åœ¨PicGoè®¾ç½®é‡Œé¢è‡ªè¡Œå®šä¹‰å§ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      é«˜æ•ˆåˆ©ç”¨æœ‰é“äº‘ç¬”è®°
    
    </summary>
    
      <category term="é«˜æ•ˆåˆ©ç”¨æœ‰é“äº‘ç¬”è®°" scheme="https://blog.cloudops.ml/categories/%E9%AB%98%E6%95%88%E5%88%A9%E7%94%A8%E6%9C%89%E9%81%93%E4%BA%91%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="å›¾åºŠ" scheme="https://blog.cloudops.ml/tags/%E5%9B%BE%E5%BA%8A/"/>
    
      <category term="æœ‰é“äº‘ç¬”è®°" scheme="https://blog.cloudops.ml/tags/%E6%9C%89%E9%81%93%E4%BA%91%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Picbed" scheme="https://blog.cloudops.ml/tags/Picbed/"/>
    
  </entry>
  
  <entry>
    <title>TestLink æ•´åˆ LDAP å’Œ CAS å•ç‚¹ç™»å½•</title>
    <link href="https://blog.cloudops.ml/TestLink-integrate-with-ldap-and-CAS.html"/>
    <id>https://blog.cloudops.ml/TestLink-integrate-with-ldap-and-CAS.html</id>
    <published>2018-12-04T06:55:56.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><ul><li>TestLink ç‰ˆæœ¬ï¼š2.18</li><li>TestLink URLï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wL3Rlc3RsaW5r" title="http://devops.iamzhl.top/testlink">http://devops.iamzhl.top/testlink<i class="fa fa-external-link"></i></span></li><li>openLDAP æœåŠ¡ï¼šldap://devops.iamzhl.top:389</li><li>CAS æœåŠ¡ï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgwODAvY2Fz" title="http://devops.iamzhl.top:8080/cas">http://devops.iamzhl.top:8080/cas<i class="fa fa-external-link"></i></span></li></ul><h2 id="æ•´åˆ-LDAP"><a href="#æ•´åˆ-LDAP" class="headerlink" title="æ•´åˆ LDAP"></a>æ•´åˆ LDAP</h2><h3 id="ä¿®æ”¹TestLinké…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹TestLinké…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹TestLinké…ç½®æ–‡ä»¶"></a>ä¿®æ”¹<code>TestLink</code>é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/testlink/custom_config.inc.php</span></span><br></pre></td></tr></table></figure><blockquote><p>æ·»åŠ <code>LDAP</code>é…ç½®æ–‡ä»¶</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$tlCfg-&gt;authentication[<span class="string">'method'</span>] = <span class="string">'LDAP'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>] = <span class="keyword">array</span>();</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_server'</span>] = <span class="string">'devops.iamzhl.top'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_port'</span>] = <span class="string">'389'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_version'</span>] = <span class="string">'3'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_root_dn'</span>] = <span class="string">'dc=iamzhl,dc=top'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_bind_dn'</span>] = <span class="string">'cn=Manager,dc=iamzhl,dc=top'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_bind_passwd'</span>] = <span class="string">'123456'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_tls'</span>] = <span class="keyword">false</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_organization'</span>] = <span class="string">''</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_uid_field'</span>] = <span class="string">'uid'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_email_field'</span>] = <span class="string">'mail'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_firstname_field'</span>] = <span class="string">'givenname'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap'</span>][<span class="number">1</span>][<span class="string">'ldap_surname_field'</span>] = <span class="string">'sn'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap_automatic_user_creation'</span>] = <span class="keyword">true</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap_email_field'</span>] = <span class="string">'mail'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap_firstname_field'</span>] = <span class="string">'givenname'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'ldap_surname_field'</span>] = <span class="string">'sn'</span>;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><blockquote><p>æ‰“å¼€<code>TestLink</code>ç½‘å€<code>http://devops.iamzhl.top/testlink</code></p></blockquote><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fxvp6j1abej328s1f8qb2.jpg" alt></p><p>å¦‚å›¾ï¼Œæ­£å¸¸è·³è½¬åˆ°<code>TestLink</code>ç™»å½•ç•Œé¢ï¼Œè¾“å…¥<code>LDAP</code>æœåŠ¡å™¨ä¸­çš„ç”¨æˆ·åå¯†ç åç‚¹å‡»<code>Log in</code></p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fxvuh6h46uj328s1f8k01.jpg" alt></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œç™»é™†æˆåŠŸåæ­£å¸¸çš„è·å–åˆ°äº†ç”¨æˆ·åï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ç™»å‡ºæŒ‰é’®ï¼Œæ­£å¸¸é€€å‡ºåè·³è½¬åˆ°äº†<code>TestLink</code>çš„ç™»å½•ç•Œé¢</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fxvuj3kqkjj328s1f8gtv.jpg" alt></p><p>è‡³æ­¤ï¼Œ<code>TestLink</code>æ•´åˆ<code>LDAP</code>å®Œæˆã€‚</p><h2 id="æ•´åˆCASå•ç‚¹ç™»å½•"><a href="#æ•´åˆCASå•ç‚¹ç™»å½•" class="headerlink" title="æ•´åˆCASå•ç‚¹ç™»å½•"></a>æ•´åˆ<code>CAS</code>å•ç‚¹ç™»å½•</h2><h3 id="æ·»åŠ ä¾èµ–çš„phpCASåº“æ–‡ä»¶"><a href="#æ·»åŠ ä¾èµ–çš„phpCASåº“æ–‡ä»¶" class="headerlink" title="æ·»åŠ ä¾èµ–çš„phpCASåº“æ–‡ä»¶"></a>æ·»åŠ ä¾èµ–çš„<code>phpCAS</code>åº“æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/apereo/phpCAS/archive/1.3.6.tar.gz</span></span><br><span class="line"><span class="comment"># mv 1.3.6.tar.gz phpCAS-1.3.6.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxvf phpCAS-1.3.6.tar.gz</span></span><br><span class="line"><span class="comment"># chown -R apache:apache phpCAS-1.3.6</span></span><br><span class="line"><span class="comment"># cp -arf phpCAS-1.3.6/source/CAS.php /var/www/html/testlink/lib/functions/</span></span><br><span class="line"><span class="comment"># cp -arf phpCAS-1.3.6/source/CAS /var/www/html/testlink/lib/functions/</span></span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹TestLinké…ç½®æ–‡ä»¶-1"><a href="#ä¿®æ”¹TestLinké…ç½®æ–‡ä»¶-1" class="headerlink" title="ä¿®æ”¹TestLinké…ç½®æ–‡ä»¶"></a>ä¿®æ”¹<code>TestLink</code>é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/testlink/custom_config.inc.php</span></span><br></pre></td></tr></table></figure><blockquote><p>æ·»åŠ <code>CAS</code>é…ç½®é¡¹</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** CAS server parameters */</span></span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_enable'</span>] = <span class="keyword">true</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_name'</span>] = <span class="string">'devops.iamzhl.top'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_port'</span>] = <span class="number">8080</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_path'</span>] = <span class="string">'cas'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_debug_enable'</span>] = <span class="keyword">true</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_debug_file'</span>] = <span class="string">'/var/logs/testlink/phpCAS.log'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_protocol'</span>] = <span class="string">'2.0'</span>;</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ç™»å½•ç•Œé¢"><a href="#ä¿®æ”¹ç™»å½•ç•Œé¢" class="headerlink" title="ä¿®æ”¹ç™»å½•ç•Œé¢"></a>ä¿®æ”¹ç™»å½•ç•Œé¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/testlink/login.php</span></span><br></pre></td></tr></table></figure><blockquote><p>åœ¨<code>switch($args-&gt;action)</code>åˆ†æ”¯é€‰æ‹©è¯­å¥æ®µå†…æ‰¾åˆ°<code>case &#39;loginform&#39;</code>éƒ¨åˆ†ï¼Œæ·»åŠ <code>CAS</code>çš„è®¤è¯</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>($args-&gt;action) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'doLogin'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'ajaxlogin'</span>:</span><br><span class="line">    doSessionStart(<span class="keyword">true</span>);</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// When doing ajax login we need to skip control regarding session already open</span></span><br><span class="line">    <span class="comment">// that we use when doing normal login.</span></span><br><span class="line">    <span class="comment">// If we do not proceed this way we will enter an infinite loop</span></span><br><span class="line">    $options = <span class="keyword">array</span>(<span class="string">'doSessionExistsCheck'</span> =&gt; ($args-&gt;action==<span class="string">'doLogin'</span>));</span><br><span class="line">    $op = doAuthorize($db,$args-&gt;login,$args-&gt;pwd,$options);</span><br><span class="line">    $doAuthPostProcess = <span class="keyword">true</span>;</span><br><span class="line">    $gui-&gt;draw = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="string">'ajaxcheck'</span>:</span><br><span class="line">    processAjaxCheck($db);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="string">'oauth'</span>:</span><br><span class="line">    <span class="comment">//If code is empty then break</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">        renderLoginScreen($gui);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Switch between oauth providers</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">include_once</span>(<span class="string">'lib/functions/oauth_providers/'</span>.$_GET[<span class="string">'oauth'</span>].<span class="string">'.php'</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Oauth client doesn't exist"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $oau = config_get(<span class="string">'OAuthServers'</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($oau <span class="keyword">as</span> $oprov) &#123;</span><br><span class="line">      <span class="keyword">if</span> (strcmp($oprov[<span class="string">'oauth_name'</span>],$_GET[<span class="string">'oauth'</span>]) == <span class="number">0</span>)&#123;</span><br><span class="line">        $oauth_params = $oprov;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $user_token = oauth_get_token($oauth_params, $_GET[<span class="string">'code'</span>]);</span><br><span class="line">    <span class="keyword">if</span>($user_token-&gt;status[<span class="string">'status'</span>] == tl::OK) &#123;</span><br><span class="line">      doSessionStart(<span class="keyword">true</span>);</span><br><span class="line">      $op = doAuthorize($db,$user_token-&gt;options-&gt;user,<span class="string">'oauth'</span>,$user_token-&gt;options);</span><br><span class="line">      $doAuthPostProcess = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $gui-&gt;note = $user_token-&gt;status[<span class="string">'msg'</span>];</span><br><span class="line">        renderLoginScreen($gui);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="string">'loginform'</span>:</span><br><span class="line">  <span class="comment">//zhanghl start</span></span><br><span class="line">  <span class="keyword">if</span>($authCfg[<span class="string">'cas_enable'</span>])</span><br><span class="line">    &#123;    </span><br><span class="line">       <span class="keyword">if</span>($authCfg[<span class="string">'cas_debug_enable'</span>])</span><br><span class="line">       &#123;</span><br><span class="line">          phpCAS::setDebug($authCfg[<span class="string">'cas_debug_file'</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Initialize phpCAS</span></span><br><span class="line">       phpCAS::client($authCfg[<span class="string">'cas_server_protocol'</span>], $authCfg[<span class="string">'cas_server_name'</span>], $authCfg[<span class="string">'cas_server_port'</span>], $authCfg[<span class="string">'cas_server_path'</span>]);</span><br><span class="line">       <span class="comment">// For production use set the CA certificate that is the issuer of the cert</span></span><br><span class="line">       <span class="comment">// on the CAS server and uncomment the line below</span></span><br><span class="line">       <span class="comment">// phpCAS::setCasServerCACert($cas_server_ca_cert_path);</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">// For quick testing you can disable SSL validation of the CAS server.</span></span><br><span class="line">       <span class="comment">// THIS SETTING IS NOT RECOMMENDED FOR PRODUCTION.</span></span><br><span class="line">       <span class="comment">// VALIDATING THE CAS SERVER IS CRUCIAL TO THE SECURITY OF THE CAS PROTOCOL!</span></span><br><span class="line">       phpCAS::setNoCasServerValidation();</span><br><span class="line">               </span><br><span class="line">       <span class="comment">// Override the validation url for any (ST and PT) CAS 2.0 validation</span></span><br><span class="line">       <span class="comment">//phpCAS::setServerProxyValidateURL('http://devops.iamzhl.top:8080/cas/proxyValidate');</span></span><br><span class="line">               </span><br><span class="line">       <span class="comment">// Override the validation url for any CAS 1.0 validation</span></span><br><span class="line">       <span class="comment">//phpCAS::setServerServiceValidateURL('http://devops.iamzhl.top:8080/cas/serviceValidate');</span></span><br><span class="line">              </span><br><span class="line">       phpCAS::handleLogoutRequests();</span><br><span class="line">       phpCAS::forceAuthentication();</span><br><span class="line">       $options = <span class="keyword">array</span>(<span class="string">'doSessionExistsCheck'</span> =&gt; ($args-&gt;action==<span class="string">'doLogin'</span>));</span><br><span class="line">       $op = doCASAuthorize($db,$options);</span><br><span class="line">       $doAuthPostProcess = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">//zhanghl end</span></span><br><span class="line">    $doRenderLoginScreen = <span class="keyword">true</span>;</span><br><span class="line">    $gui-&gt;draw = <span class="keyword">true</span>;</span><br><span class="line">    $op = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unfortunatelly we use $args-&gt;note in order to do some logic.</span></span><br><span class="line">    <span class="keyword">if</span>( ($args-&gt;note=trim($args-&gt;note)) == <span class="string">""</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span>( $gui-&gt;authCfg[<span class="string">'SSO_enabled'</span>] )</span><br><span class="line">      &#123;</span><br><span class="line">        doSessionStart(<span class="keyword">true</span>);</span><br><span class="line">        $doAuthPostProcess = <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> ($gui-&gt;authCfg[<span class="string">'SSO_method'</span>]) </span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'CLIENT_CERTIFICATE'</span>:</span><br><span class="line">            $op = doSSOClientCertificate($db,$_SERVER,$gui-&gt;authCfg);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">case</span> <span class="string">'WEBSERVER_VAR'</span>:</span><br><span class="line">            <span class="comment">//DEBUGsyslogOnCloud('Trying to execute SSO using SAML');</span></span><br><span class="line">            $op = doSSOWebServerVar($db,$gui-&gt;authCfg);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//zhanghl start</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//zhanghl end</span></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨<code>init_gui</code>å‡½æ•°å†…æ‰¾åˆ°<code>switch($args-&gt;note)</code>åˆ†æ”¯è¯­å¥ï¼Œåœ¨<code>expired</code>åˆ†æ”¯ä¸‹æ·»åŠ ä¸€è¡Œé‡å®šå‘è°ƒç”¨</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>($args-&gt;note) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'expired'</span>:</span><br><span class="line">      <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) &#123;</span><br><span class="line">        session_start();</span><br><span class="line">      &#125;</span><br><span class="line">      session_unset();</span><br><span class="line">      session_destroy();</span><br><span class="line">      $gui-&gt;note = lang_get(<span class="string">'session_expired'</span>);</span><br><span class="line">      $gui-&gt;reqURI = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// æ·»åŠ é‡å®šå‘è°ƒç”¨</span></span><br><span class="line">      redirect(TL_BASE_HREF .<span class="string">"login.php?destination="</span>.$args-&gt;destination);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'first'</span>:</span><br><span class="line">      $gui-&gt;note = lang_get(<span class="string">'your_first_login'</span>);</span><br><span class="line">      $gui-&gt;reqURI = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'lost'</span>:</span><br><span class="line">      $gui-&gt;note = lang_get(<span class="string">'passwd_lost'</span>);</span><br><span class="line">      $gui-&gt;reqURI = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      $gui-&gt;note = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ç™»å‡ºç•Œé¢"><a href="#ä¿®æ”¹ç™»å‡ºç•Œé¢" class="headerlink" title="ä¿®æ”¹ç™»å‡ºç•Œé¢"></a>ä¿®æ”¹ç™»å‡ºç•Œé¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /var/www/html/testlink/logout.php</span></span><br></pre></td></tr></table></figure><blockquote><p>åœ¨<code>$authCfg = config_get(&#39;authentication&#39;);</code>è¯­å¥ä¹‹åæ·»åŠ <code>CAS</code>çš„ç™»å‡ºå¤„ç†</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($authCfg[<span class="string">'cas_enable'</span>])</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">if</span>($authCfg[<span class="string">'cas_debug_enable'</span>])</span><br><span class="line">   &#123;</span><br><span class="line">      phpCAS::setDebug($authCfg[<span class="string">'cas_debug_file'</span>]);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Initialize phpCAS</span></span><br><span class="line">   phpCAS::client($authCfg[<span class="string">'cas_server_protocol'</span>], $authCfg[<span class="string">'cas_server_name'</span>], $authCfg[<span class="string">'cas_server_port'</span>], $authCfg[<span class="string">'cas_server_path'</span>]);</span><br><span class="line">   phpCAS::logout();</span><br><span class="line">&#125;</span><br><span class="line">redirect(<span class="string">"login.php?note=logout"</span>);</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹common-phpå…¨å±€å¼•ç”¨æ–‡ä»¶"><a href="#ä¿®æ”¹common-phpå…¨å±€å¼•ç”¨æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹common.phpå…¨å±€å¼•ç”¨æ–‡ä»¶"></a>ä¿®æ”¹<code>common.php</code>å…¨å±€å¼•ç”¨æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/testlink/lib/functions/common.php</span></span><br></pre></td></tr></table></figure><blockquote><p>åœ¨<code>require_once(&#39;tlsmarty.inc.php&#39;);</code>å¼•ç”¨çš„å‰é¢å¢åŠ å¯¹<code>CAS</code>çš„å¼•ç”¨</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** TestLink CAS Authentication Ref */</span></span><br><span class="line">$authCfg = config_get(<span class="string">'authentication'</span>);</span><br><span class="line"><span class="keyword">if</span>($authCfg[<span class="string">'cas_enable'</span>])</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// Load the CAS lib</span></span><br><span class="line">   <span class="keyword">require_once</span> <span class="string">'CAS.php'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fxvnthnmyaj31p818kn8o.jpg" alt></p><h3 id="ä¿®æ”¹è®¤è¯å‡½æ•°"><a href="#ä¿®æ”¹è®¤è¯å‡½æ•°" class="headerlink" title="ä¿®æ”¹è®¤è¯å‡½æ•°"></a>ä¿®æ”¹è®¤è¯å‡½æ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/testlink/lib/functions/doAuthorize.php</span></span><br></pre></td></tr></table></figure><blockquote><p>åœ¨å¼€å¤´<code>require_once</code>è¯­å¥çš„åé¢æ·»åŠ <code>CAS</code>è®¤è¯å‡½æ•°</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zhanghl start</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doCASAuthorize</span><span class="params">(&amp;$db,$options=null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">global</span> $g_tlLogger;</span><br><span class="line">   $result = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; tl::ERROR, <span class="string">'msg'</span> =&gt; <span class="keyword">null</span>);</span><br><span class="line">   $user = <span class="keyword">new</span> tlUser();</span><br><span class="line">   $user-&gt;login = $_SESSION[<span class="string">'phpCAS'</span>][<span class="string">'user'</span>];</span><br><span class="line">   $login_exists = ($user-&gt;readFromDB($db,tlUser::USER_O_SEARCH_BYLOGIN) &gt;= tl::OK);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!$login_exists)</span><br><span class="line">   &#123;</span><br><span class="line">      $user = <span class="keyword">new</span> tlUser();</span><br><span class="line">      $user-&gt;login = $_SESSION[<span class="string">'phpCAS'</span>][<span class="string">'user'</span>];</span><br><span class="line">      $user-&gt;isActive = <span class="keyword">true</span>;</span><br><span class="line">      $user-&gt;authentication = <span class="string">'LDAP'</span>;  <span class="comment">// force for auth_does_password_match</span></span><br><span class="line">      $user-&gt;setPassword($user-&gt;login);  <span class="comment">// write password on DB anyway</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//$user-&gt;emailAddress = $_SESSION['phpCAS']['attributes']['mail'];</span></span><br><span class="line">   <span class="comment">//$user-&gt;firstName = $_SESSION['phpCAS']['attributes']['sn'];</span></span><br><span class="line">   <span class="comment">//$user-&gt;lastName = $_SESSION['phpCAS']['attributes']['givenName'];</span></span><br><span class="line">   $doLogin = ($user-&gt;writeToDB($db) == tl::OK);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>( $doLogin )</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">// Need to do set COOKIE following Mantis model</span></span><br><span class="line">      $auth_cookie_name = config_get(<span class="string">'auth_cookie'</span>);</span><br><span class="line">      $expireOnBrowserClose=<span class="keyword">false</span>;</span><br><span class="line">      setcookie($auth_cookie_name,$user-&gt;getSecurityCookie(),$expireOnBrowserClose,<span class="string">'/'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Disallow two sessions within one browser</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'currentUser'</span>]) &amp;&amp; !is_null($_SESSION[<span class="string">'currentUser'</span>]))</span><br><span class="line">      &#123;</span><br><span class="line">         $result[<span class="string">'msg'</span>] = lang_get(<span class="string">'login_msg_session_exists1'</span>) .</span><br><span class="line">            <span class="string">' &lt;a style="color:white;" href="logout.php"&gt;'</span> .</span><br><span class="line">            lang_get(<span class="string">'logout_link'</span>) . <span class="string">'&lt;/a&gt;'</span> . lang_get(<span class="string">'login_msg_session_exists2'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="comment">// Setting user's session information</span></span><br><span class="line">         $_SESSION[<span class="string">'currentUser'</span>] = $user;</span><br><span class="line">         $_SESSION[<span class="string">'lastActivity'</span>] = time();</span><br><span class="line"></span><br><span class="line">         $g_tlLogger-&gt;endTransaction();</span><br><span class="line">         $g_tlLogger-&gt;startTransaction();</span><br><span class="line">         setUserSession($db,$user-&gt;login, $user-&gt;dbID,$user-&gt;globalRoleID,$user-&gt;emailAddress,$user-&gt;locale,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">         $result[<span class="string">'status'</span>] = tl::OK;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// zhanghl end</span></span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹å…¨å±€é…ç½®æ–‡ä»¶-å¯é€‰"><a href="#ä¿®æ”¹å…¨å±€é…ç½®æ–‡ä»¶-å¯é€‰" class="headerlink" title="ä¿®æ”¹å…¨å±€é…ç½®æ–‡ä»¶ (å¯é€‰)"></a>ä¿®æ”¹å…¨å±€é…ç½®æ–‡ä»¶ (å¯é€‰)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/testlink/config.inc.php</span></span><br></pre></td></tr></table></figure><blockquote><p>å¢åŠ <code>CAS</code>è®¤è¯å±æ€§</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** CAS server properties */</span></span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_enable'</span>] = <span class="keyword">false</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_name'</span>] = <span class="string">''</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_port'</span>] = <span class="number">8080</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_path'</span>] = <span class="string">'cas'</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_debug_enable'</span>] = <span class="keyword">true</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_debug_file'</span>] = <span class="string">''</span>;</span><br><span class="line">$tlCfg-&gt;authentication[<span class="string">'cas_server_protocol'</span>] = <span class="string">''</span>;</span><br></pre></td></tr></table></figure><p><strong><em>Noteï¼šæ­¤é€‰é¡¹ç”¨ä»¥è®¾ç½®é»˜è®¤å±æ€§å€¼ï¼Œä¸»è¦ç”¨æ¥æ—¥åæŸ¥é˜…ï¼Œå¯ä»¥ä¸å†™ï¼Œ<code>/var/www/html/testlink/custom_config.inc.php</code>æ–‡ä»¶ç›¸åŒçš„å±æ€§é…ç½®ä¼šè¦†ç›–ç”Ÿæ•ˆã€‚</em></strong></p><h3 id="ä¿®æ”¹CASçš„Client-phpå¯ç”¨httpè¿æ¥-æ ¹æ®ä¸ªäººCASæœåŠ¡å™¨æ¥å®š"><a href="#ä¿®æ”¹CASçš„Client-phpå¯ç”¨httpè¿æ¥-æ ¹æ®ä¸ªäººCASæœåŠ¡å™¨æ¥å®š" class="headerlink" title="ä¿®æ”¹CASçš„Client.phpå¯ç”¨httpè¿æ¥(æ ¹æ®ä¸ªäººCASæœåŠ¡å™¨æ¥å®š)"></a>ä¿®æ”¹<code>CAS</code>çš„<code>Client.php</code>å¯ç”¨<code>http</code>è¿æ¥(æ ¹æ®ä¸ªäºº<code>CAS</code>æœåŠ¡å™¨æ¥å®š)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/testlink/lib/functions/CAS/Client.php</span></span><br></pre></td></tr></table></figure><blockquote><p>å°†å¦‚ä¸‹å‡ ä¸ªå‡½æ•°ä¸­çš„<code>https</code>æ”¹ä¸º<code>http</code>å³å¯</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_getServerBaseURL</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// the URL is build only when needed</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>]) ) &#123;</span><br><span class="line">        <span class="comment">// $this-&gt;_server['base_url'] = 'https://' . $this-&gt;_getServerHostname();</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>] = <span class="string">'http://'</span> . <span class="keyword">$this</span>-&gt;_getServerHostname();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_getServerPort()!=<span class="number">443</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>] .= <span class="string">':'</span></span><br><span class="line">                .<span class="keyword">$this</span>-&gt;_getServerPort();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>] .= <span class="keyword">$this</span>-&gt;_getServerURI();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_getCallbackURL</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// the URL is built when needed only</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_callback_url) ) &#123;</span><br><span class="line">        $final_uri = <span class="string">''</span>;</span><br><span class="line">        <span class="comment">// remove the ticket if present in the URL</span></span><br><span class="line">        <span class="comment">// $final_uri = 'https://';</span></span><br><span class="line">        $final_uri = <span class="string">'http://'</span>;</span><br><span class="line">        $final_uri .= <span class="keyword">$this</span>-&gt;_getClientUrl();</span><br><span class="line">        $request_uri = $_SERVER[<span class="string">'REQUEST_URI'</span>];</span><br><span class="line">        $request_uri = preg_replace(<span class="string">'/\?.*$/'</span>, <span class="string">''</span>, $request_uri);</span><br><span class="line">        $final_uri .= $request_uri;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_callback_url = $final_uri;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_callback_url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getURL</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    phpCAS::traceBegin();</span><br><span class="line">    <span class="comment">// the URL is built when needed only</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_url) ) &#123;</span><br><span class="line">        $final_uri = <span class="string">''</span>;</span><br><span class="line">        <span class="comment">// remove the ticket if present in the URL</span></span><br><span class="line">        <span class="comment">// $final_uri = ($this-&gt;_isHttps()) ? 'https' : 'http';</span></span><br><span class="line">        $final_uri = (<span class="keyword">$this</span>-&gt;_isHttps()) ? <span class="string">'http'</span> : <span class="string">'http'</span>;</span><br><span class="line">        $final_uri .= <span class="string">'://'</span>;</span><br><span class="line"></span><br><span class="line">        $final_uri .= <span class="keyword">$this</span>-&gt;_getClientUrl();</span><br><span class="line">        $request_uri= explode(<span class="string">'?'</span>, $_SERVER[<span class="string">'REQUEST_URI'</span>], <span class="number">2</span>);</span><br><span class="line">        $final_uri.= $request_uri[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($request_uri[<span class="number">1</span>]) &amp;&amp; $request_uri[<span class="number">1</span>]) &#123;</span><br><span class="line">            $query_string= <span class="keyword">$this</span>-&gt;_removeParameterFromQueryString(<span class="string">'ticket'</span>, $request_uri[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the query string still has anything left,</span></span><br><span class="line">            <span class="comment">// append it to the final URI</span></span><br><span class="line">            <span class="keyword">if</span> ($query_string !== <span class="string">''</span>) &#123;</span><br><span class="line">                $final_uri.= <span class="string">"?$query_string"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        phpCAS::trace(<span class="string">"Final URI: $final_uri"</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setURL($final_uri);</span><br><span class="line">    &#125;</span><br><span class="line">    phpCAS::traceEnd(<span class="keyword">$this</span>-&gt;_url);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><blockquote><p>æ–°å»º<code>debug</code>è°ƒè¯•ç›®å½•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/log/testlink</span></span><br><span class="line"><span class="comment"># chown -R apache:apache /var/log/testlink</span></span><br></pre></td></tr></table></figure><blockquote><p>æ‰“å¼€<code>TestLink</code>ç½‘å€<code>http://devops.iamzhl.top/testlink</code></p></blockquote><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fxvougi1woj32221fcdv4.jpg" alt></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ­£å¸¸è·³è½¬åˆ°<code>CAS</code>çš„ç™»å½•ç•Œé¢ï¼Œåœ°å€å˜æˆäº†<code>http://devops.iamzhl.top:8080/cas/login?service=http%3A%2F%2Fdevops.iamzhl.top%2Ftestlink%2Flogin.php</code>ï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç åç‚¹å‡»ç™»å½•</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fxvuh6h46uj328s1f8k01.jpg" alt></p><p>å¦‚å›¾ç™»é™†æˆåŠŸåæ­£å¸¸è·å–ç”¨æˆ·åï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ç™»å‡ºæŒ‰é’®åï¼Œæ­£å¸¸é€€å‡ºåˆ°<code>CAS</code>ç™»å‡ºé¡µé¢</p><p>![image-20181205173735167](/Users/canvas/Library/Application Support/typora-user-images/image-20181205173735167.png)</p><p>è‡³æ­¤ï¼Œ<code>TestLink</code>æ•´åˆ<code>CAS</code>å•ç‚¹ç™»å½•å®Œæˆã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      TestLink æ•´åˆ LDAP å’Œ CAS å•ç‚¹ç™»å½•
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="CAS" scheme="https://blog.cloudops.ml/tags/CAS/"/>
    
      <category term="LDAP" scheme="https://blog.cloudops.ml/tags/LDAP/"/>
    
      <category term="TestLink" scheme="https://blog.cloudops.ml/tags/TestLink/"/>
    
  </entry>
  
  <entry>
    <title>MantisBT æ•´åˆ LDAP å’Œ CAS å•ç‚¹ç™»å½•</title>
    <link href="https://blog.cloudops.ml/MantisBT-integrate-with-ldap-and-CAS.html"/>
    <id>https://blog.cloudops.ml/MantisBT-integrate-with-ldap-and-CAS.html</id>
    <published>2018-12-03T07:07:11.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><ul><li>MantisBT ç‰ˆæœ¬ï¼š2.18</li><li>Mantis URLï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wL21hbnRpcw==" title="http://devops.iamzhl.top/mantis">http://devops.iamzhl.top/mantis<i class="fa fa-external-link"></i></span></li><li>openLDAP æœåŠ¡ï¼šldap://devops.iamzhl.top:389</li><li>CAS æœåŠ¡ï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgwODAvY2Fz" title="http://devops.iamzhl.top:8080/cas">http://devops.iamzhl.top:8080/cas<i class="fa fa-external-link"></i></span></li></ul><h2 id="æ•´åˆ-LDAP"><a href="#æ•´åˆ-LDAP" class="headerlink" title="æ•´åˆ LDAP"></a>æ•´åˆ LDAP</h2><h3 id="ä¿®æ”¹MantisBTé…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹MantisBTé…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹MantisBTé…ç½®æ–‡ä»¶"></a>ä¿®æ”¹<code>MantisBT</code>é…ç½®æ–‡ä»¶</h3><blockquote><p>æ·»åŠ ä»¥ä¸‹é…ç½®é¡¹</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MantisBT Authentication and LDAP Settings #</span></span><br><span class="line">$g_login_method = LDAP;</span><br><span class="line">$g_reauthentication = ON;</span><br><span class="line">$g_reauthentication_expiry = TOKEN_EXPIRY_AUTHENTICATED;</span><br><span class="line">$g_ldap_server = <span class="string">'ldap://devops.iamzhl.top:389'</span>;</span><br><span class="line">$g_ldap_root_dn = <span class="string">'ou=People,dc=iamzhl,dc=top'</span>;</span><br><span class="line">$g_ldap_protocol_version = <span class="number">3</span>;</span><br><span class="line">$g_ldap_organization = <span class="string">''</span>;</span><br><span class="line">$g_ldap_bind_dn = <span class="string">'cn=Manager,dc=iamzhl,dc=top'</span>;</span><br><span class="line">$g_ldap_bind_passwd = <span class="string">'123456'</span>;</span><br><span class="line">$g_ldap_uid_field = <span class="string">'uid'</span>;</span><br><span class="line">$g_ldap_realname_field = <span class="string">'cn'</span>;</span><br><span class="line">$g_use_ldap_realname = ON;</span><br><span class="line">$g_use_ldap_email = ON;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€<code>MantisBT</code>ç½‘å€ï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç ç‚¹å‡»ç™»å½•</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/dd/a754582a7218fd2860d31fb543c667.jpg" alt></p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/07/158dfd797dce0fa01335dd8d9b5085.jpg" alt></p><p>ç™»é™†æˆåŠŸåï¼Œæ­£å¸¸è·å–ç”¨æˆ·å</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/5d/e2fd0f937861208615ce61fae90423.jpg" alt></p><p>ç‚¹å‡»å³ä¸Šè§’çš„ç”¨æˆ·å -&gt; æ³¨é”€ï¼Œä¼šæ­£å¸¸é€€å‡ºå¹¶è·³è½¬åˆ°ç™»å½•ç•Œé¢</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/5e/e198803ba7693b67b5e6c5fc075ab5.jpg" alt></p><p>è‡³æ­¤ï¼Œ<code>MantisBT</code>æ•´åˆ<code>LDAP</code>å®Œæˆã€‚</p><h2 id="æ•´åˆ-CAS-å•ç‚¹ç™»å½•"><a href="#æ•´åˆ-CAS-å•ç‚¹ç™»å½•" class="headerlink" title="æ•´åˆ CAS å•ç‚¹ç™»å½•"></a>æ•´åˆ CAS å•ç‚¹ç™»å½•</h2><h3 id="ä¸‹è½½phpCASæ”¾åˆ°MantisBTä¸‹"><a href="#ä¸‹è½½phpCASæ”¾åˆ°MantisBTä¸‹" class="headerlink" title="ä¸‹è½½phpCASæ”¾åˆ°MantisBTä¸‹"></a>ä¸‹è½½<code>phpCAS</code>æ”¾åˆ°<code>MantisBT</code>ä¸‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/apereo/phpCAS/archive/1.3.6.tar.gz</span></span><br><span class="line"><span class="comment"># mv 1.3.6.tar.gz phpCAS-1.3.6.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxvf phpCAS-1.3.6.tar.gz</span></span><br><span class="line"><span class="comment"># chown -R apache:apache phpCAS-1.3.6</span></span><br><span class="line"><span class="comment"># cp -arf phpCAS-1.3.6 /var/www/html/mantis/phpCAS</span></span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹MantisBTé…ç½®æ–‡ä»¶-1"><a href="#ä¿®æ”¹MantisBTé…ç½®æ–‡ä»¶-1" class="headerlink" title="ä¿®æ”¹MantisBTé…ç½®æ–‡ä»¶"></a>ä¿®æ”¹<code>MantisBT</code>é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/mantis/config/config_inc.php</span></span><br></pre></td></tr></table></figure><blockquote><p>æ·»åŠ <code>CAS</code>è®¤è¯éœ€è¦çš„å˜é‡(è¯·æŒ‰ç…§è‡ªå·±çš„<code>LDAP</code>æœåŠ¡å™¨è¿›è¡Œä¿®æ”¹)</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MantisBT Authentication With CAS Settings #</span></span><br><span class="line">$g_login_method = CAS;</span><br><span class="line">$g_cas_server = <span class="string">'devops.iamzhl.top'</span>;</span><br><span class="line">$g_cas_port = <span class="number">8080</span>;</span><br><span class="line">$g_cas_uri = <span class="string">'/cas'</span>;</span><br><span class="line">$g_cas_validate = <span class="string">''</span>;</span><br><span class="line">$g_cas_version = <span class="string">'2.0'</span>;</span><br><span class="line">$g_cas_debug = <span class="string">'/var/www/html/mantis/cas.log'</span>;</span><br><span class="line">$g_cas_saml_attributes = OFF;</span><br><span class="line">$g_cas_saml_map = <span class="keyword">array</span>( <span class="string">'name'</span> =&gt; <span class="string">''</span>, <span class="string">'mail'</span> =&gt; <span class="string">''</span> );</span><br><span class="line">$g_cas_use_ldap = ON;</span><br><span class="line">$g_ldap_mantis_uid  = <span class="string">'uid'</span>;</span><br><span class="line">$g_cas_ldap_update  = OFF;</span><br><span class="line">$g_cas_ldap_update_fields = <span class="string">''</span>;</span><br><span class="line">$g_cas_ldap_update_map    = <span class="string">''</span>;</span><br><span class="line">$g_ldap_language_field = <span class="string">''</span>;</span><br><span class="line">$g_ldap_language_keys = <span class="string">''</span>;</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ç™»å½•é¡µé¢"><a href="#ä¿®æ”¹ç™»å½•é¡µé¢" class="headerlink" title="ä¿®æ”¹ç™»å½•é¡µé¢"></a>ä¿®æ”¹ç™»å½•é¡µé¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/mantis/login_page.php</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ–‡ä»¶å¼€å¤´çš„ require_once éƒ¨åˆ†å¢åŠ å¯¹ phpCAS çš„å¼•å…¥</span></span><br><span class="line"><span class="keyword">require_once</span>( <span class="string">'/var/www/html/mantis/phpCAS/login_cas.php'</span> );</span><br><span class="line"><span class="comment">// åœ¨ $f_username å˜é‡çš„å®šä¹‰ä¹‹å‰æ·»åŠ åˆ¤æ–­è¯­å¥ï¼Œå½“æ£€æµ‹åˆ°ç”¨æˆ·å·²ç»è®¤è¯æ—¶ï¼Œè·³è½¬åˆ°ä¸»é¡µ</span></span><br><span class="line"><span class="keyword">if</span>( auth_is_user_authenticated() &amp;&amp; !current_user_is_anonymous() ) &#123;</span><br><span class="line">print_header_redirect( config_get( <span class="string">'default_home_page'</span> ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/mantis/login.php</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨åˆ¤æ–­å˜é‡ f_install çš„åˆ¤æ–­è¯­å¥ä¹‹åæ·»åŠ ä¸‹é¢çš„åˆ¤æ–­è¯­å¥æ¥åˆ¤æ–­éªŒè¯æ–¹å¼ï¼Œè‹¥ä¸º CAS ï¼Œåˆ™åˆ©ç”¨ auth_cas_get_name å‡½æ•°æ¥å¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> ( CAS == config_get( <span class="string">'login_method'</span> ) ) &#123;</span><br><span class="line"><span class="comment"># This will detour to the CAS login page if needed</span></span><br><span class="line">$f_password = <span class="string">''</span>;</span><br><span class="line">$f_username = auth_cas_get_name();</span><br><span class="line"><span class="comment"># User is always authenticated by this point</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/mantis/login_password_page.php</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨ $f_username å˜é‡çš„å®šä¹‰ä¹‹å‰æ·»åŠ åˆ¤æ–­è¯­å¥ï¼Œå½“æ£€æµ‹åˆ°ç”¨æˆ·å·²ç»è®¤è¯æ—¶ï¼Œè·³è½¬åˆ°ä¸»é¡µ</span></span><br><span class="line"><span class="keyword">if</span>( auth_is_user_authenticated() &amp;&amp; !current_user_is_anonymous() ) &#123;</span><br><span class="line">print_header_redirect( config_get( <span class="string">'default_home_page'</span> ) );</span><br><span class="line">&#125;</span><br><span class="line">$f_username              = gpc_get_string( <span class="string">'username'</span>, <span class="string">''</span> );</span><br><span class="line"><span class="comment"># zhanghl start</span></span><br><span class="line"><span class="keyword">if</span>( $f_username == <span class="string">''</span> ) &#123;</span><br><span class="line">        $f_username = $staffid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># zhanghl end</span></span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ç™»å‡ºé¡µé¢"><a href="#ä¿®æ”¹ç™»å‡ºé¡µé¢" class="headerlink" title="ä¿®æ”¹ç™»å‡ºé¡µé¢"></a>ä¿®æ”¹ç™»å‡ºé¡µé¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/mantis/logout_page.php</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ–‡ä»¶å¼€å¤´çš„ require_once éƒ¨åˆ†å¢åŠ å¯¹ phpCAS çš„å¼•å…¥</span></span><br><span class="line"><span class="keyword">require_once</span>( <span class="string">'/var/www/html/mantis/phpCAS/login_cas.php'</span> );</span><br><span class="line"><span class="comment"># Cache the current logout redirect page as it will be cleared by auth_logout()</span></span><br><span class="line"><span class="comment">//$t_logout_redirect = auth_logout_redirect_page();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//auth_logout();</span></span><br><span class="line">phpCAS::setDebug();</span><br><span class="line">phpCAS::setVerbose(<span class="keyword">true</span>);</span><br><span class="line">phpCAS::handleLogoutRequests();</span><br><span class="line">phpCAS::logout();</span><br><span class="line"></span><br><span class="line"><span class="comment">//print_header_redirect( $t_logout_redirect, true, false );</span></span><br><span class="line">print_header_redirect( config_get( <span class="string">'logout_redirect_page'</span> ), <span class="keyword">true</span>, <span class="keyword">false</span> );</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹éªŒè¯é€»è¾‘"><a href="#ä¿®æ”¹éªŒè¯é€»è¾‘" class="headerlink" title="ä¿®æ”¹éªŒè¯é€»è¾‘"></a>ä¿®æ”¹éªŒè¯é€»è¾‘</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/mantis/core/authentication_api.php</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨å˜é‡ g_cache_current_user_id çš„å®šä¹‰åé¢æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼Œå®šä¹‰ CAS çš„ç™»å½•é€»è¾‘</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Initialize phpCAS.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_cas_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment"># phpCAS must be installed in the include path</span></span><br><span class="line">       <span class="comment"># or in the Mantis directory.</span></span><br><span class="line">       <span class="keyword">require_once</span>(<span class="string">'/var/www/html/mantis/phpCAS/CAS.php'</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">static</span> $s_initialized=<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (! $s_initialized ) &#123;</span><br><span class="line">               phpCAS::setDebug( config_get( <span class="string">'cas_debug'</span> ) );</span><br><span class="line">              <span class="comment">## These should be set in config_inc.php</span></span><br><span class="line">               $t_server_version = config_get( <span class="string">'cas_version'</span> );</span><br><span class="line">               $t_server_cas_server = config_get( <span class="string">'cas_server'</span> );</span><br><span class="line">               $t_server_port = config_get( <span class="string">'cas_port'</span> );</span><br><span class="line">               $t_server_uri = config_get( <span class="string">'cas_uri'</span> );</span><br><span class="line">               $t_start_session = (boolean)<span class="keyword">FALSE</span>; <span class="comment"># Mantis takes care of its own session</span></span><br><span class="line"></span><br><span class="line">               phpCAS::client($t_server_version, $t_server_cas_server, $t_server_port, $t_server_uri, $t_start_session);</span><br><span class="line">               <span class="keyword">if</span> ($t_server_version == <span class="string">"S1"</span>)</span><br><span class="line">                       phpCAS::setServerSamlValidateURL( config_get( <span class="string">'cas_validate'</span> ) );</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">                       phpCAS::setServerProxyValidateURL( config_get( <span class="string">'cas_validate'</span> ) );</span><br><span class="line">               <span class="keyword">if</span> (method_exists(<span class="string">'phpCAS'</span>, <span class="string">'setNoCasServerValidation'</span>)) &#123;</span><br><span class="line">                       <span class="comment">// no SSL validation for the CAS server</span></span><br><span class="line">                       phpCAS::setNoCasServerValidation();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               $s_initialized = <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Fetches the user's CAS name, authenticating if needed.</span></span><br><span class="line"><span class="comment">* Can translate CAS login name to Mantis username through LDAP.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_cas_get_name</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">       <span class="comment"># Get CAS username from phpCAS</span></span><br><span class="line">       auth_cas_init();</span><br><span class="line">       phpCAS::forceAuthentication();</span><br><span class="line">       $t_cas_id = phpCAS::getUser();</span><br><span class="line">       $t_cas_attribs = phpCAS::getAttributes();</span><br><span class="line"></span><br><span class="line">       <span class="comment"># If needed, translate the CAS username through LDAP</span></span><br><span class="line">       $t_username = $t_cas_id;</span><br><span class="line">       <span class="keyword">if</span> (config_get( <span class="string">'cas_use_ldap'</span>, <span class="keyword">false</span> )) &#123;</span><br><span class="line">               $t_username = auth_cas_ldap_translate( $t_cas_id );</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">elseif</span> (config_get( <span class="string">'cas_saml_attributes'</span>, <span class="keyword">false</span> )) &#123;</span><br><span class="line">               $t_cas_attribmap = config_get( <span class="string">'cas_saml_map'</span>, <span class="keyword">array</span>() );</span><br><span class="line">               $t_cas_attrib_name = $t_cas_attribs[$t_cas_attribmap[<span class="string">'name'</span>]];</span><br><span class="line">               $t_cas_attrib_mail = $t_cas_attribs[$t_cas_attribmap[<span class="string">'mail'</span>]];</span><br><span class="line">               <span class="keyword">if</span> ( user_get_id_by_name($t_cas_id) == <span class="keyword">false</span> ) &#123;</span><br><span class="line">                       user_create( $t_cas_id, <span class="string">''</span>, $t_cas_attrib_mail, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, $t_cas_attrib_name );</span><br><span class="line">       &#125;</span><br><span class="line">       &#125;</span><br><span class="line">                               </span><br><span class="line">       <span class="keyword">return</span> $t_username;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Takes an ID string, and looks up the LDAP directory to find</span></span><br><span class="line"><span class="comment">* the matching username for Mantis.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Optionally, also update the user information in the Mantis user</span></span><br><span class="line"><span class="comment">* table.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> $p_cas_id string Typically, the username given by phpCAS.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> $p_update_user bool Whether or not to update user details from LDAP.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_cas_ldap_translate</span><span class="params">( $p_cas_id, $p_update_user=<span class="string">''</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Please make sure the Mantis CAS and LDAP settings are set in config_inc.php</span></span><br><span class="line"></span><br><span class="line">       $t_ldap_organization    = config_get( <span class="string">'ldap_organization'</span> );</span><br><span class="line">       $t_ldap_root_dn         = config_get( <span class="string">'ldap_root_dn'</span> );</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Required fields in LDAP for CAS</span></span><br><span class="line">       $t_ldap_language_field = config_get( <span class="string">'ldap_language_field'</span>, <span class="string">''</span> );</span><br><span class="line">       $t_ldap_uid_field = config_get( <span class="string">'ldap_uid_field'</span>, <span class="string">'uid'</span> ) ;</span><br><span class="line">       $t_ldap_mantis_uid = config_get( <span class="string">'ldap_mantis_uid'</span>, <span class="string">'uid'</span> );</span><br><span class="line">       $t_ldap_required = <span class="keyword">array</span>( $t_ldap_uid_field, $t_ldap_mantis_uid, <span class="string">'dn'</span> );</span><br><span class="line">       <span class="keyword">if</span> ($t_ldap_language_field) &#123;</span><br><span class="line">               <span class="comment">// Add language field to attributes list only if it is configured.</span></span><br><span class="line">               $t_ldap_required[] = $t_ldap_language_field;</span><br><span class="line">       &#125;</span><br><span class="line">       $t_ldap_required = array_combine( $t_ldap_required, $t_ldap_required );</span><br><span class="line"></span><br><span class="line">       <span class="comment"># User-defined fields to fetch from LDAP...</span></span><br><span class="line">       $t_ldap_fields = explode( <span class="string">','</span>, config_get( <span class="string">'cas_ldap_update_fields'</span> ) );</span><br><span class="line">       $t_ldap_fields = array_combine( $t_ldap_fields, $t_ldap_fields );</span><br><span class="line">       <span class="comment"># ...which are mapped to Mantis user fields</span></span><br><span class="line">       $t_ldap_map = explode( <span class="string">','</span>, config_get( <span class="string">'cas_ldap_update_map'</span> ) );</span><br><span class="line">       $t_ldap_map = array_combine( $t_ldap_map, $t_ldap_map );</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Build LDAP search filter, attribute list from CAS ID</span></span><br><span class="line">       $t_search_filter = <span class="string">"(&amp;$t_ldap_organization($t_ldap_uid_field=$p_cas_id))"</span>;</span><br><span class="line">       $t_search_attrs = array_values($t_ldap_required + $t_ldap_fields);      <span class="comment"># array union</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># Use Mantis ldap_api to connect to LDAP</span></span><br><span class="line">       $t_ds = ldap_connect_bind();</span><br><span class="line">       $t_sr   = ldap_search( $t_ds, $t_ldap_root_dn, $t_search_filter, $t_search_attrs );</span><br><span class="line">       $t_info = ldap_get_entries( $t_ds, $t_sr );</span><br><span class="line">       <span class="comment"># Parse the LDAP entry to find the Mantis username</span></span><br><span class="line">       <span class="keyword">if</span> ( $t_info ) &#123;</span><br><span class="line">               <span class="comment"># Get Mantis username</span></span><br><span class="line">               $t_username = $t_info[<span class="number">0</span>][$t_ldap_mantis_uid][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">               <span class="comment"># @@@ The fact that we got here means the user is authenticated</span></span><br><span class="line">               <span class="comment"># @@@ by CAS, and has an LDAP entry.</span></span><br><span class="line">               <span class="comment"># @@@ We might as well update other user details since we are here.</span></span><br><span class="line"></span><br><span class="line">               <span class="comment"># If no argument given, check settings</span></span><br><span class="line">               <span class="keyword">if</span> ( <span class="string">''</span> == $p_update_user ) &#123;</span><br><span class="line">                       $p_update_user = config_get( <span class="string">'cas_ldap_update'</span>, <span class="keyword">FALSE</span> );</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment"># If there's a user record, then update it</span></span><br><span class="line">               <span class="keyword">if</span> ( $p_update_user ) &#123;</span><br><span class="line">                       <span class="comment"># Only proceed if the field map arrays are the same length</span></span><br><span class="line">                       $t_field_map = array_combine( $t_ldap_fields, $t_ldap_map );</span><br><span class="line">                       <span class="keyword">if</span> ($t_field_map) &#123;</span><br><span class="line">                               <span class="comment"># If user is new, then we must create their account before updating it</span></span><br><span class="line">                               <span class="comment"># @@@ ( make sure $g_allow_blank_email == ON )</span></span><br><span class="line">                               $t_userid = user_get_id_by_name($t_username);</span><br><span class="line">                               <span class="keyword">if</span> ( <span class="keyword">false</span> == $t_userid ) &#123;</span><br><span class="line">                                       user_create( $t_username, <span class="string">''</span> );</span><br><span class="line">                                       <span class="comment"># @@@ Wow, this is pretty lame</span></span><br><span class="line">                                       $t_userid = user_get_id_by_name($t_username);</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="comment"># @@@ maybe we can optimize this to write all fields at once?</span></span><br><span class="line">                             <span class="keyword">foreach</span> ( $t_field_map <span class="keyword">as</span> $key=&gt;$t_userfield ) &#123;</span><br><span class="line">                                     <span class="keyword">if</span> (<span class="keyword">isset</span>($t_info[<span class="number">0</span>][$key][<span class="number">0</span>])) &#123;</span><br><span class="line">                                             user_set_field( $t_userid, $t_userfield, $t_info[<span class="number">0</span>][$key][<span class="number">0</span>] );</span><br><span class="line">                                     &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       <span class="comment">// Update user's overall language preference</span></span><br><span class="line">                       <span class="keyword">if</span> ($t_ldap_language_field) &#123;</span><br><span class="line">                               $t_language = $t_info[<span class="number">0</span>][$t_ldap_language_field][<span class="number">0</span>];</span><br><span class="line">                               <span class="comment">// Map the LDAP language field to Mantis' language field if needed</span></span><br><span class="line">                               $t_language_keys = config_get( <span class="string">'ldap_language_keys'</span>, <span class="string">''</span>);</span><br><span class="line">                               $t_language_values = config_get( <span class="string">'ldap_language_values'</span>, <span class="string">''</span>);</span><br><span class="line">                               $t_language_map = array_combine(</span><br><span class="line">                                       explode(<span class="string">','</span>, $t_language_keys),</span><br><span class="line">                                       explode(<span class="string">','</span>, $t_language_values)</span><br><span class="line">                               );</span><br><span class="line">                               <span class="keyword">if</span> (<span class="keyword">isset</span>($t_language_map[$t_language])) &#123;</span><br><span class="line">                                       $t_language = $t_language_map[$t_language];</span><br><span class="line">                               &#125;</span><br><span class="line">                               user_pref_set_pref($t_userid, <span class="string">'language'</span>, $t_language);</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ldap_free_result( $t_sr );</span><br><span class="line">       ldap_unbind( $t_ds );</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> $t_username;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Logs out of CAS, redirecting to Mantis on re-login.</span></span><br><span class="line"><span class="comment">* User should already be logged out of Mantis by the time this is called.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> auth_logout()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_cas_logout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">       $t_path = config_get(<span class="string">'path'</span>);</span><br><span class="line">       auth_cas_init();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (method_Exists(<span class="string">'phpCAS'</span>, <span class="string">'logoutWithUrl'</span>)) &#123;</span><br><span class="line">               phpCAS::logoutWithUrl($t_path);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               phpCAS::logout($t_path);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// zhanghl end</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹ auth_auto_create_user å‡½æ•°å®ç° CAS è‡ªåŠ¨åˆ›å»ºç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_auto_create_user</span><span class="params">( $p_username, $p_password )</span> </span>&#123;</span><br><span class="line">$t_login_method = config_get_global( <span class="string">'login_method'</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">// if( $t_login_method == BASIC_AUTH ) &#123;</span></span><br><span class="line"><span class="keyword">if</span> ( in_array( $t_login_method, <span class="keyword">array</span>( BASIC_AUTH, CAS ) ) ) &#123;</span><br><span class="line"><span class="comment"># attempt to create the user if using BASIC_AUTH or CAS</span></span><br><span class="line">$t_auto_create = <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>( $t_login_method == LDAP &amp;&amp; ldap_authenticate_by_username( $p_username, $p_password ) ) &#123;</span><br><span class="line">$t_auto_create = <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">$t_auto_create = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( CAS == config_get( <span class="string">'login_method'</span> ) ) &#123;</span><br><span class="line"><span class="comment"># Redirect to CAS page to logout</span></span><br><span class="line">auth_cas_logout();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( $t_auto_create ) &#123;</span><br><span class="line"><span class="comment"># attempt to create the user</span></span><br><span class="line">$t_cookie_string = user_create( $p_username, md5( $p_password ) );</span><br><span class="line"><span class="keyword">if</span>( $t_cookie_string === <span class="keyword">false</span> ) &#123;</span><br><span class="line"><span class="comment"># it didn't work</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ok, we created the user, get the row again</span></span><br><span class="line"><span class="keyword">return</span> user_get_id_by_name( $p_username );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">session_clean();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_attempt_login</span><span class="params">( $p_username, $p_password, $p_perm_login = false )</span> </span>&#123;</span><br><span class="line">$t_user_id = auth_get_user_id_from_login_name( $p_username );</span><br><span class="line">$t_login_method = config_get( <span class="string">'login_method'</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( $t_user_id === <span class="keyword">false</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( in_array( $t_login_method, <span class="keyword">array</span>( BASIC_AUTH, CAS ) ) ) &#123;</span><br><span class="line">            <span class="comment"># attempt to create the user if using BASIC_AUTH or CAS</span></span><br><span class="line">            <span class="comment"># ( note: CAS must have $g_allow_blank_email == ON )</span></span><br><span class="line"> $t_auto_create = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">$t_user_id = auth_auto_create_user( $p_username, $p_password );</span><br><span class="line"><span class="keyword">if</span>( $t_user_id === <span class="keyword">false</span> ) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># max. failed login attempts achieved...</span></span><br><span class="line"><span class="keyword">if</span>( !user_is_login_request_allowed( $t_user_id ) ) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for anonymous login</span></span><br><span class="line"><span class="keyword">if</span>( !user_is_anonymous( $t_user_id ) ) &#123;</span><br><span class="line"><span class="comment"># anonymous login didn't work, so check the password</span></span><br><span class="line"><span class="keyword">if</span>( !auth_does_password_match( $t_user_id, $p_password ) ) &#123;</span><br><span class="line">user_increment_failed_login_count( $t_user_id );</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> auth_login_user( $t_user_id, $p_perm_login );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_logout</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $g_cache_current_user_id, $g_cache_cookie_valid;</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear cached userid</span></span><br><span class="line">user_clear_cache( $g_cache_current_user_id );</span><br><span class="line">current_user_set( <span class="keyword">null</span> );</span><br><span class="line">$g_cache_cookie_valid = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear cookies, if they were set</span></span><br><span class="line"><span class="keyword">if</span>( auth_clear_cookies() ) &#123;</span><br><span class="line">helper_clear_pref_cookies();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( HTTP_AUTH == config_get_global( <span class="string">'login_method'</span> ) ) &#123;</span><br><span class="line">auth_http_set_logout_pending( <span class="keyword">true</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> ( CAS == config_get( <span class="string">'login_method'</span> ) ) &#123;</span><br><span class="line">        <span class="comment"># Redirect to CAS page to logout</span></span><br><span class="line">        auth_cas_logout();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">session_clean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_automatic_logon_bypass_form</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>( config_get( <span class="string">'login_method'</span> ) ) &#123;</span><br><span class="line">                <span class="keyword">case</span> HTTP_AUTH:</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">case</span> CAS:</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//return config_get_global( 'login_method' ) == HTTP_AUTH;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_does_password_match</span><span class="params">( $p_user_id, $p_test_password )</span> </span>&#123;</span><br><span class="line">$t_configured_login_method = config_get_global( <span class="string">'login_method'</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( LDAP == $t_configured_login_method ) &#123;</span><br><span class="line"><span class="keyword">return</span> ldap_authenticate( $p_user_id, $p_test_password );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span> ( CAS == $t_configured_login_method ) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( !auth_can_use_standard_login( $p_user_id ) ) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$t_password = user_get_field( $p_user_id, <span class="string">'password'</span> );</span><br><span class="line">$t_login_methods = <span class="keyword">array</span>(</span><br><span class="line">MD5,</span><br><span class="line">CRYPT,</span><br><span class="line">PLAIN,</span><br><span class="line">BASIC_AUTH,</span><br><span class="line">CAS,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>( $t_login_methods <span class="keyword">as</span> $t_login_method ) &#123;</span><br><span class="line"><span class="comment"># pass the stored password in as the salt</span></span><br><span class="line"><span class="keyword">if</span>( auth_process_plain_password( $p_test_password, $t_password, $t_login_method ) == $t_password ) &#123;</span><br><span class="line"><span class="comment"># Do not support migration to PLAIN, since this would be a crazy thing to do.</span></span><br><span class="line"><span class="comment"># Also if we do, then a user will be able to login by providing the MD5 value</span></span><br><span class="line"><span class="comment"># that is copied from the database.  See #8467 for more details.</span></span><br><span class="line"><span class="keyword">if</span>( ( $t_configured_login_method != PLAIN &amp;&amp; $t_login_method == PLAIN ) ||</span><br><span class="line">( $t_configured_login_method != BASIC_AUTH &amp;&amp; $t_login_method == BASIC_AUTH ) ) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check for migration to another login method and test whether the password was encrypted</span></span><br><span class="line"><span class="comment"># with our previously insecure implementation of the CRYPT method</span></span><br><span class="line"><span class="keyword">if</span>( ( $t_login_method != $t_configured_login_method ) || (( CRYPT == $t_configured_login_method ) &amp;&amp; mb_substr( $t_password, <span class="number">0</span>, <span class="number">2</span> ) == mb_substr( $p_test_password, <span class="number">0</span>, <span class="number">2</span> ) ) ) &#123;</span><br><span class="line">user_set_password( $p_user_id, $p_test_password, <span class="keyword">true</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth_reauthenticate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//if( !auth_reauthentication_enabled() || BASIC_AUTH == config_get_global( 'login_method' ) || HTTP_AUTH == config_get_global( 'login_method' ) ) &#123;</span></span><br><span class="line"><span class="keyword">if</span>( !auth_reauthentication_enabled() || in_array(config_get(<span class="string">'login_method'</span>), <span class="keyword">array</span>(BASIC_AUTH, HTTP_AUTH, CAS)) ) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$t_auth_token = token_get( TOKEN_AUTHENTICATED );</span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">null</span> != $t_auth_token ) &#123;</span><br><span class="line">token_touch( $t_auth_token[<span class="string">'id'</span>], auth_reauthentication_expiry() );</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">$t_anon_account = auth_anonymous_account();</span><br><span class="line">$t_anon_allowed = auth_anonymous_enabled();</span><br><span class="line"></span><br><span class="line">$t_user_id = auth_get_current_user_id();</span><br><span class="line">$t_username = user_get_username( $t_user_id );</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for anonymous login</span></span><br><span class="line"><span class="keyword">if</span>( ON == $t_anon_allowed &amp;&amp; $t_anon_account == $t_username ) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$t_request_uri = string_url( $_SERVER[<span class="string">'REQUEST_URI'</span>] );</span><br><span class="line"></span><br><span class="line">$t_query_params = http_build_query(</span><br><span class="line"><span class="keyword">array</span>(</span><br><span class="line"><span class="string">'reauthenticate'</span> =&gt; <span class="number">1</span>,</span><br><span class="line"><span class="string">'username'</span> =&gt; $t_username,</span><br><span class="line"><span class="string">'return'</span> =&gt; $t_request_uri,</span><br><span class="line">),</span><br><span class="line"><span class="string">''</span>, <span class="string">'&amp;'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># redirect to login page</span></span><br><span class="line">print_header_redirect( auth_credential_page( $t_query_params ) );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–°å»ºlogin-cas-phpå¤„ç†æ‹¦æˆªåˆ©ç”¨CASè®¤è¯ç™»å½•"><a href="#æ–°å»ºlogin-cas-phpå¤„ç†æ‹¦æˆªåˆ©ç”¨CASè®¤è¯ç™»å½•" class="headerlink" title="æ–°å»ºlogin_cas.phpå¤„ç†æ‹¦æˆªåˆ©ç”¨CASè®¤è¯ç™»å½•"></a>æ–°å»º<code>login_cas.php</code>å¤„ç†æ‹¦æˆªåˆ©ç”¨<code>CAS</code>è®¤è¯ç™»å½•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  vi /var/www/html/mantis/phpCAS/login_cas.php</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>( <span class="string">'CAS.php'</span> );</span><br><span class="line">define(<span class="string">'CAS_ENABLE'</span>, <span class="keyword">true</span>);</span><br><span class="line">$cas_host = <span class="string">'devops.iamzhl.top'</span>;</span><br><span class="line">$cas_context = <span class="string">'/cas'</span>;</span><br><span class="line">$cas_port = <span class="number">8080</span>;</span><br><span class="line">$cas_real_hosts = <span class="keyword">array</span> (</span><br><span class="line"><span class="string">'devops.iamzhl.top'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">phpCAS::setDebug();</span><br><span class="line">phpCAS::setVerbose(<span class="keyword">true</span>);</span><br><span class="line">phpCAS::client(CAS_VERSION_2_0, $cas_host, $cas_port, $cas_context);</span><br><span class="line">phpCAS::setNoCasServerValidation();</span><br><span class="line">phpCAS::handleLogoutRequests(<span class="keyword">true</span>, $cas_real_hosts);</span><br><span class="line">phpCAS::forceAuthentication();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹CASçš„Client-phpå¯ç”¨httpè¿æ¥-æ ¹æ®ä¸ªäººCASæœåŠ¡å™¨æ¥å®š"><a href="#ä¿®æ”¹CASçš„Client-phpå¯ç”¨httpè¿æ¥-æ ¹æ®ä¸ªäººCASæœåŠ¡å™¨æ¥å®š" class="headerlink" title="ä¿®æ”¹CASçš„Client.phpå¯ç”¨httpè¿æ¥(æ ¹æ®ä¸ªäººCASæœåŠ¡å™¨æ¥å®š)"></a>ä¿®æ”¹<code>CAS</code>çš„<code>Client.php</code>å¯ç”¨<code>http</code>è¿æ¥(æ ¹æ®ä¸ªäºº<code>CAS</code>æœåŠ¡å™¨æ¥å®š)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /var/www/html/mantis/phpCAS/source/CAS/Client.php</span></span><br></pre></td></tr></table></figure><blockquote><p>å°†å¦‚ä¸‹å‡ ä¸ªå‡½æ•°ä¸­çš„httpsæ”¹ä¸ºhttpå³å¯</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_getServerBaseURL</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// the URL is build only when needed</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>]) ) &#123;</span><br><span class="line">            <span class="comment">//$this-&gt;_server['base_url'] = 'https://' . $this-&gt;_getServerHostname();</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>] = <span class="string">'http://'</span> . <span class="keyword">$this</span>-&gt;_getServerHostname();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_getServerPort()!=<span class="number">443</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>] .= <span class="string">':'</span></span><br><span class="line">                .<span class="keyword">$this</span>-&gt;_getServerPort();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>] .= <span class="keyword">$this</span>-&gt;_getServerURI();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_server[<span class="string">'base_url'</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_getCallbackURL</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// the URL is built when needed only</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_callback_url) ) &#123;</span><br><span class="line">            $final_uri = <span class="string">''</span>;</span><br><span class="line">            <span class="comment">// remove the ticket if present in the URL</span></span><br><span class="line">            <span class="comment">//$final_uri = 'https://';</span></span><br><span class="line">            $final_uri = <span class="string">'http://'</span>;</span><br><span class="line">            $final_uri .= <span class="keyword">$this</span>-&gt;_getClientUrl();</span><br><span class="line">            $request_uri = $_SERVER[<span class="string">'REQUEST_URI'</span>];</span><br><span class="line">            $request_uri = preg_replace(<span class="string">'/\?.*$/'</span>, <span class="string">''</span>, $request_uri);</span><br><span class="line">            $final_uri .= $request_uri;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_callback_url = $final_uri;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_callback_url;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public function getURL()</span><br><span class="line">    &#123;</span><br><span class="line">        phpCAS::traceBegin();</span><br><span class="line">        // the URL is built when needed only</span><br><span class="line">        if ( empty($this-&gt;_url) ) &#123;</span><br><span class="line">            $final_uri = &apos;&apos;;</span><br><span class="line">            // remove the ticket if present in the URL</span><br><span class="line">            //$final_uri = ($this-&gt;_isHttps()) ? &apos;https&apos; : &apos;http&apos;;</span><br><span class="line">            $final_uri = ($this-&gt;_isHttps()) ? &apos;http&apos; : &apos;http&apos;;</span><br><span class="line">            $final_uri .= &apos;://&apos;;</span><br><span class="line"></span><br><span class="line">            $final_uri .= $this-&gt;_getClientUrl();</span><br><span class="line">            $request_uri        = explode(&apos;?&apos;, $_SERVER[&apos;REQUEST_URI&apos;], 2);</span><br><span class="line">            $final_uri          .= $request_uri[0];</span><br><span class="line"></span><br><span class="line">            if (isset($request_uri[1]) &amp;&amp; $request_uri[1]) &#123;</span><br><span class="line">                $query_string= $this-&gt;_removeParameterFromQueryString(&apos;ticket&apos;, $request_uri[1]);</span><br><span class="line"></span><br><span class="line">                // If the query string still has anything left,</span><br><span class="line">                // append it to the final URI</span><br><span class="line">                if ($query_string !== &apos;&apos;) &#123;</span><br><span class="line">                    $final_uri  .= &quot;?$query_string&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            phpCAS::trace(&quot;Final URI: $final_uri&quot;);</span><br><span class="line">            $this-&gt;setURL($final_uri);</span><br><span class="line">        &#125;</span><br><span class="line">        phpCAS::traceEnd($this-&gt;_url);</span><br><span class="line">        return $this-&gt;_url;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><blockquote><p>æ–°å»º<code>log</code>ç›®å½•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/log/mantis</span></span><br><span class="line"><span class="comment"># chown -R apache:apache /var/log/mantis</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€<code>MantisBT</code>ç½‘å€ï¼Œæ­£å¸¸è·³è½¬è‡³<code>CAS</code>ç™»å½•ç•Œé¢ï¼Œç½‘å€æ˜¯<code>http://devops.iamzhl.top:8080/cas/login?service=http%3A%2F%2Fdevops.iamzhl.top%2Fmantis%2Flogin_page.php</code></p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/fa/f707556ce41d95b71052d07834f5d8.jpg" alt></p><p>å¦‚å›¾ï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç åç‚¹å‡»ç™»å½•ï¼Œæ­£å¸¸ç™»é™†åè·³è½¬è‡³<code>MantisBT</code>ä¸»é¡µï¼Œå¹¶ä¸”æ­£å¸¸è·å–ç”¨æˆ·å</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/49/1365298ec15c90fbf95612a38606ed.jpg" alt></p><p>ç‚¹å‡»å³ä¸Šè§’çš„ç”¨æˆ·å -&gt; æ³¨é”€ï¼Œä¼šæ­£å¸¸é€€å‡ºå¹¶è·³è½¬åˆ°<code>CAS</code>çš„ç™»å‡ºç•Œé¢</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/85/2d25e40bdf97b6f06dad6239cf3167.jpg" alt></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      MantisBT æ•´åˆ LDAP å’Œ CAS å•ç‚¹ç™»å½•
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="CAS" scheme="https://blog.cloudops.ml/tags/CAS/"/>
    
      <category term="LDAP" scheme="https://blog.cloudops.ml/tags/LDAP/"/>
    
      <category term="MantisBT" scheme="https://blog.cloudops.ml/tags/MantisBT/"/>
    
  </entry>
  
  <entry>
    <title>Gerrit æ•´åˆ ldap å’Œ CAS å•ç‚¹ç™»å½•</title>
    <link href="https://blog.cloudops.ml/Gerrit-integrate-with-ldap-and-CAS.html"/>
    <id>https://blog.cloudops.ml/Gerrit-integrate-with-ldap-and-CAS.html</id>
    <published>2018-12-03T01:42:41.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><ul><li>Gerrit ç‰ˆæœ¬ï¼š2.16</li><li>Gerrit URLï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgy" title="http://devops.iamzhl.top:82">http://devops.iamzhl.top:82<i class="fa fa-external-link"></i></span></li><li>openLDAP æœåŠ¡ï¼šldap://devops.iamzhl.top:389</li><li>CAS æœåŠ¡ï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgwODAvY2Fz" title="http://devops.iamzhl.top:8080/cas">http://devops.iamzhl.top:8080/cas<i class="fa fa-external-link"></i></span></li></ul><h2 id="æ•´åˆ-LDAP"><a href="#æ•´åˆ-LDAP" class="headerlink" title="æ•´åˆ LDAP"></a>æ•´åˆ LDAP</h2><h3 id="ä¿®æ”¹-gerrit-config"><a href="#ä¿®æ”¹-gerrit-config" class="headerlink" title="ä¿®æ”¹ gerrit.config"></a>ä¿®æ”¹ gerrit.config</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/review_site/etc/gerrit.config</span></span><br></pre></td></tr></table></figure><blockquote><p>è¯·æ ¹æ®è‡ªå·±çš„<code>LDAP</code>æœåŠ¡å™¨ä¿¡æ¯è¿›è¡Œå®šåˆ¶</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[auth]</span><br><span class="line">        type = LDAP</span><br><span class="line">[ldap]</span><br><span class="line">        server = ldap://devops.iamzhl.top:389</span><br><span class="line">        username = cn=Manager,dc=iamzhl,dc=top</span><br><span class="line">        password = passwd</span><br><span class="line">        accountBase = ou=People,dc=iamzhl,dc=top</span><br><span class="line">        groupBase = ou=People,dc=iamzhl,dc=top</span><br><span class="line">        accountFullName = uid</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æœåŠ¡"><a href="#é‡å¯æœåŠ¡" class="headerlink" title="é‡å¯æœåŠ¡"></a>é‡å¯æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gerrit restart</span></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>æ‰“å¼€ç½‘å€<code>http://devops.iamzhl.top:8081</code>ï¼Œè¿›å…¥åˆ°<code>Gerrit</code>ä¸»é¡µé¢</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/4d/42f6d16ca0cd469d5b5bd9cfb9f471.jpg" alt></p><p>ç‚¹å‡»å³ä¸Šè§’<code>Sign in</code>ï¼Œè¿›å…¥ç™»å½•ç•Œé¢ï¼Œè¾“å…¥<code>LDAP</code>æœåŠ¡å™¨ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åç‚¹å‡»<code>Sign in</code></p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/5e/3a439fb1bcfae0116018eaca7dd987.jpg" alt></p><p>ç™»å½•æˆåŠŸåè·³è½¬åˆ°ç”¨æˆ·ä¸»é¡µé¢ï¼Œæ­£å¸¸è·å–ç”¨æˆ·å</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/3d/ea561210f011755f97aec7c4a90b59.jpg" alt></p><p>ç‚¹å‡»ç”¨æˆ·å -&gt; Sign Outï¼Œæ­£å¸¸é€€å‡º</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/4d/42f6d16ca0cd469d5b5bd9cfb9f471.jpg" alt></p><p>è‡³æ­¤ï¼Œ<code>Gerrit</code>æ•´åˆ<code>LDAP</code>å®Œæˆã€‚</p><h2 id="æ•´åˆ-CAS"><a href="#æ•´åˆ-CAS" class="headerlink" title="æ•´åˆ CAS"></a>æ•´åˆ CAS</h2><h3 id="ä¿®æ”¹-gerrit-config-1"><a href="#ä¿®æ”¹-gerrit-config-1" class="headerlink" title="ä¿®æ”¹ gerrit.config"></a>ä¿®æ”¹ gerrit.config</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/review_site/etc/gerrit.config</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>[auth]</code>éƒ¨åˆ†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[auth]</span><br><span class="line">        type = HTTP</span><br><span class="line">        httpHeader = X-Forwarded-Gerrit</span><br><span class="line">        logoutUrl = http://devops.iamzhl.top:8080/cas/logout</span><br></pre></td></tr></table></figure><h3 id="mod-auth-casä¿®æ”¹"><a href="#mod-auth-casä¿®æ”¹" class="headerlink" title="mod_auth_casä¿®æ”¹"></a><code>mod_auth_cas</code>ä¿®æ”¹</h3><p>ç„¶åå®‰è£…<code>mod_auth_cas</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install mod_auth_cas</span></span><br></pre></td></tr></table></figure><p>é…ç½®<code>mod_auth_cas</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/httpd/conf.d/auth_cas.conf</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>CAS</code>çš„<code>Cookie</code>å­˜å‚¨ä½ç½®ä»¥åŠç™»å½•åœ°å€å’ŒéªŒè¯åœ°å€ç­‰å‚æ•°å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LogLevel Debug</span><br><span class="line">CASDebug On</span><br><span class="line">CASVersion 2</span><br><span class="line">CASTimeout 1740</span><br><span class="line">CASIdleTimeout 1740</span><br><span class="line">CASSSOEnabled On</span><br><span class="line">CASCookiePath /var/cache/httpd/mod_auth_cas/</span><br><span class="line">CASLoginURL http://devops.iamzhl.top:8080/cas/login</span><br><span class="line">CASValidateURL http://devops.iamzhl.top:8080/cas/serviceValidate</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹-apache-é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹-apache-é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ apache é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹ apache é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/httpd/conf/httpd.conf</span></span><br></pre></td></tr></table></figure><blockquote><p>æ·»åŠ åå‘ä»£ç†</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># æ·»åŠ ä¸€ä¸ªç›‘å¬ç«¯å£ 82 ç”¨ä½œ Gerrit çš„ä»£ç†ä¸»æœº</span><br><span class="line">Listen 82</span><br><span class="line"></span><br><span class="line"># åŠ è½½ mod_auth_cas æ¨¡å—ï¼Œå¦‚æœå·²ç»åŠ è½½è¯·å¿½ç•¥</span><br><span class="line">LoadModule auth_cas_module modules/mod_auth_cas.so</span><br><span class="line"></span><br><span class="line"># è®¾ç½® Gerrit çš„è™šæ‹Ÿä¸»æœº</span><br><span class="line">&lt;VirtualHost *:82&gt;</span><br><span class="line">    ServerName devops.iamzhl.top</span><br><span class="line">    ServerAdmin 15563836030@163.com</span><br><span class="line"></span><br><span class="line">    CASRootProxiedAs http://devops.iamzhl.top:82</span><br><span class="line"></span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyVia Off</span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line"></span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">          Order deny,allow</span><br><span class="line">          Allow from all</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Location &quot;/login/&quot;&gt;</span><br><span class="line">        AuthType CAS</span><br><span class="line">        AuthName &quot;Welcome To Gerrit Code Review&quot;</span><br><span class="line">        Require valid-user</span><br><span class="line">        CASAuthNHeader X-Forwarded-Gerrit</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">    AllowEncodedSlashes On</span><br><span class="line"></span><br><span class="line">    ProxyPass / http://devops.iamzhl.top:8081/</span><br><span class="line">    ProxyPassReverse / http://devops.iamzhl.top:8081</span><br><span class="line"></span><br><span class="line">    ErrorLog /var/log/gerrit/error.log</span><br><span class="line">    CustomLog /var/log/gerrit/access.log common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æœåŠ¡-1"><a href="#é‡å¯æœåŠ¡-1" class="headerlink" title="é‡å¯æœåŠ¡"></a>é‡å¯æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/log/gerrit</span></span><br><span class="line"><span class="comment"># gerrit restart</span></span><br><span class="line"><span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>æ‰“å¼€ç½‘å€<code>http://devops.iamzhl.top:82</code>ï¼Œå‘ç°è‡ªåŠ¨è·³è½¬åˆ°äº†<code>CAS</code>çš„ç™»å½•ç•Œé¢ï¼Œç½‘å€æ˜¯<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgwODAvY2FzL2xvZ2luP3NlcnZpY2U9aHR0cCUzYSUyZiUyZmRldm9wcy5pYW16aGwudG9wJTNhODIlMmY=" title="http://devops.iamzhl.top:8080/cas/login?service=http%3a%2f%2fdevops.iamzhl.top%3a82%2f">http://devops.iamzhl.top:8080/cas/login?service=http%3a%2f%2fdevops.iamzhl.top%3a82%2f<i class="fa fa-external-link"></i></span></p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/dc/a298cbb27df3f031b6a75d41b8ae3b.jpg" alt></p><p>è¾“å…¥ç”¨æˆ·åå¯†ç åï¼Œç‚¹å‡»ç™»å½•ï¼Œç™»é™†æˆåŠŸï¼Œåœ°å€æ˜¯<code>http://devops.iamzhl.top:82//#/dashboard/self</code></p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/6b/7e1c3e774f6d188f2a2a7203776be1.jpg" alt></p><p>ç‚¹å‡»ç”¨æˆ·å -&gt; Sign Outï¼Œå°±ä¼šç™»å‡º</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/a2/726b245663641d5b6aaf1eef3e17bf.jpg" alt></p><p>ç™»å‡ºç•Œé¢å¦‚ä¸‹ï¼Œåœ°å€æ˜¯<code>http://devops.iamzhl.top:8080/cas/logout</code></p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/e9/a067be6a85ec888bc9ab25bcf0d0e7.jpg" alt></p><p>è‡³æ­¤ï¼Œ<code>Gerrit</code>æ•´åˆ<code>CAS</code>å•ç‚¹ç™»å½•å®Œæˆã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      Gerrit æ•´åˆ ldap å’Œ CAS å•ç‚¹ç™»å½•
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="CAS" scheme="https://blog.cloudops.ml/tags/CAS/"/>
    
      <category term="Gerrit" scheme="https://blog.cloudops.ml/tags/Gerrit/"/>
    
      <category term="ldap" scheme="https://blog.cloudops.ml/tags/ldap/"/>
    
  </entry>
  
  <entry>
    <title>SonarQube æ•´åˆ LDAP å’Œ CAS å•ç‚¹ç™»å½•</title>
    <link href="https://blog.cloudops.ml/SonarQube-integrate-with-ldap-and-CAS.html"/>
    <id>https://blog.cloudops.ml/SonarQube-integrate-with-ldap-and-CAS.html</id>
    <published>2018-11-30T05:23:17.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><ul><li><code>SonarQube</code>ç‰ˆæœ¬ï¼š7.4</li><li><code>SonarQube</code> URL: <span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjkwMDA=" title="http://devops.iamzhl.top:9000">http://devops.iamzhl.top:9000<i class="fa fa-external-link"></i></span></li><li>openLDAP æœåŠ¡ï¼šldap://devops.iamzhl.top:389</li><li>CAS æœåŠ¡ï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgwODAvY2Fz" title="http://devops.iamzhl.top:8080/cas">http://devops.iamzhl.top:8080/cas<i class="fa fa-external-link"></i></span></li></ul><h2 id="æ•´åˆLDAP"><a href="#æ•´åˆLDAP" class="headerlink" title="æ•´åˆLDAP"></a>æ•´åˆ<code>LDAP</code></h2><p>ä¿®æ”¹<code>sonar</code>é…ç½®æ–‡ä»¶<code>sonar.properties</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vi /usr/<span class="built_in">local</span>/sonarqube-7.4/conf/sonar.properties</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸‹é¢çš„éƒ¨åˆ†ä¿®æ”¹<code>LDAP</code>é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#--------------------------------------------------------------------------------------------------</span><br><span class="line"># LDAP CONFIGURATION</span><br><span class="line"></span><br><span class="line"># Enable the LDAP feature</span><br><span class="line"># sonar.security.realm=LDAP</span><br><span class="line"></span><br><span class="line"># Set to true when connecting to a LDAP server using a case-insensitive setup.</span><br><span class="line"># sonar.authenticator.downcase=true</span><br><span class="line"></span><br><span class="line"># URL of the LDAP server. Note that if you are using ldaps, then you should install the server certificate into the Java truststore.</span><br><span class="line"># ldap.url=ldap://localhost:10389</span><br><span class="line"></span><br><span class="line"># Bind DN is the username of an LDAP user to connect (or bind) with. Leave this blank for anonymous access to the LDAP directory (optional)</span><br><span class="line"># ldap.bindDn=cn=sonar,ou=users,o=mycompany</span><br><span class="line"></span><br><span class="line"># Bind Password is the password of the user to connect with. Leave this blank for anonymous access to the LDAP directory (optional)</span><br><span class="line"># ldap.bindPassword=secret</span><br><span class="line"></span><br><span class="line"># Possible values: simple | CRAM-MD5 | DIGEST-MD5 | GSSAPI See http://java.sun.com/products/jndi/tutorial/ldap/security/auth.html (default: simple)</span><br><span class="line"># ldap.authentication=simple</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å¦‚ä¸‹(è¯·å°†å…·ä½“ä¿¡æ¯æŒ‰ç…§è‡ªå·±çš„<code>LDAP</code>æœåŠ¡å™¨ä¿¡æ¯è¿›è¡Œä¿®æ”¹):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">#--------------------------------------------------------------------------------------------------</span><br><span class="line"># LDAP CONFIGURATION</span><br><span class="line"></span><br><span class="line"># Enable the LDAP feature</span><br><span class="line">sonar.security.realm=LDAP</span><br><span class="line"></span><br><span class="line"># Set to true when connecting to a LDAP server using a case-insensitive setup.</span><br><span class="line"># sonar.authenticator.downcase=true</span><br><span class="line"></span><br><span class="line"># URL of the LDAP server. Note that if you are using ldaps, then you should install the server certificate into the Java truststore.</span><br><span class="line">ldap.url=ldap://devops.iamzhl.top:389</span><br><span class="line"></span><br><span class="line"># Bind DN is the username of an LDAP user to connect (or bind) with. Leave this blank for anonymous access to the LDAP directory (optional)</span><br><span class="line">ldap.bindDn=cn=Manager,dc=iamzhl,dc=top</span><br><span class="line"></span><br><span class="line"># Bind Password is the password of the user to connect with. Leave this blank for anonymous access to the LDAP directory (optional)</span><br><span class="line">ldap.bindPassword=passwd</span><br><span class="line"></span><br><span class="line"># Possible values: simple | CRAM-MD5 | DIGEST-MD5 | GSSAPI See http://java.sun.com/products/jndi/tutorial/ldap/security/auth.html (default: simple)</span><br><span class="line">ldap.authentication=simple</span><br><span class="line"></span><br><span class="line"># See :</span><br><span class="line">#   * http://java.sun.com/products/jndi/tutorial/ldap/security/digest.html</span><br><span class="line">#   * http://java.sun.com/products/jndi/tutorial/ldap/security/crammd5.html</span><br><span class="line"># (optional)</span><br><span class="line"># ldap.realm=example.org</span><br><span class="line"></span><br><span class="line"># Context factory class (optional)</span><br><span class="line"># ldap.contextFactoryClass=com.sun.jndi.ldap.LdapCtxFactory</span><br><span class="line"></span><br><span class="line"># Enable usage of StartTLS (default : false)</span><br><span class="line"># ldap.StartTLS=true</span><br><span class="line"></span><br><span class="line"># Follow or not referrals. See http://docs.oracle.com/javase/jndi/tutorial/ldap/referral/jndi.html (default: true)</span><br><span class="line"># ldap.followReferrals=false</span><br><span class="line"></span><br><span class="line"># USER MAPPING</span><br><span class="line"></span><br><span class="line"># Distinguished Name (DN) of the root node in LDAP from which to search for users (mandatory)</span><br><span class="line">ldap.user.baseDn=ou=People,dc=iamzhl,dc=top</span><br><span class="line"></span><br><span class="line"># LDAP user request. (default: (&amp;(objectClass=inetOrgPerson)(uid=&#123;login&#125;)) )</span><br><span class="line"># ldap.user.request=(&amp;(objectClass=user)(sAMAccountName=&#123;login&#125;))</span><br><span class="line">ldap.user.request=(&amp;(objectClass=inetOrgPerson)(uid=&#123;login&#125;))</span><br><span class="line"></span><br><span class="line"># Attribute in LDAP defining the userâ€™s real name. (default: cn)</span><br><span class="line"># ldap.user.realNameAttribute=name</span><br><span class="line">ldap.user.realNameAttribute=cn</span><br><span class="line"></span><br><span class="line"># Attribute in LDAP defining the userâ€™s email. (default: mail)</span><br><span class="line"># ldap.user.emailAttribute=email</span><br><span class="line">ldap.user.emailAttribute=mail</span><br><span class="line"></span><br><span class="line"># GROUP MAPPING</span><br><span class="line"></span><br><span class="line"># Distinguished Name (DN) of the root node in LDAP from which to search for groups. (optional, default: empty)</span><br><span class="line"># ldap.group.baseDn=cn=groups,dc=example,dc=org</span><br><span class="line">ldap.group.baseDn=ou=People,dc=iamzhl,dc=top</span><br><span class="line"></span><br><span class="line"># LDAP group request (default: (&amp;(objectClass=groupOfUniqueNames)(uniqueMember=&#123;dn&#125;)) )</span><br><span class="line"># ldap.group.request=(&amp;(objectClass=group)(member=&#123;dn&#125;))</span><br><span class="line">ldap.group.request=(&amp;(objectClass=posixGroup)(memberUid=&#123;uid&#125;))</span><br><span class="line"></span><br><span class="line"># Property used to specifiy the attribute to be used for returning the list of user groups in the compatibility mode. (default: cn)</span><br><span class="line"># ldap.group.idAttribute=sAMAccountName</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œæˆåï¼Œé‡å¯<code>sonar</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sonar restart</span><br></pre></td></tr></table></figure><p>æ‰“å¼€<code>sonar</code>ç½‘å€ï¼Œè¾“å…¥<code>LDAP</code>ä¸­çš„ç”¨æˆ·åå’Œå¯†ç åç‚¹å‡»ç™»å½•</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/89/7728c5a52a96a6841a426155062a56.jpg" alt></p><p>ç™»é™†æˆåŠŸåï¼Œæ­£å¸¸è·å–ç”¨æˆ·å</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/dd/53d39dc0858679e2a4949419417678.jpg" alt></p><p>è‡³æ­¤ï¼Œ<code>SonarQube</code>æ•´åˆ<code>LDAP</code>å®Œæˆ</p><h2 id="æ•´åˆCASå•ç‚¹ç™»å½•"><a href="#æ•´åˆCASå•ç‚¹ç™»å½•" class="headerlink" title="æ•´åˆCASå•ç‚¹ç™»å½•"></a>æ•´åˆ<code>CAS</code>å•ç‚¹ç™»å½•</h2><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><code>SonarQube</code>æä¾›äº†ä¸€ç§<code>SSO</code>æœºåˆ¶ï¼Œå¯ä»¥ç”¨æ¥ä½œä¸ºå•ç‚¹ç™»å½•çš„å®ç°æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨<code>HTTP header</code>çš„æ–¹å¼ï¼Œè€Œ<code>CAS</code>ä¹Ÿæä¾›äº†ä¸€ç§ç”¨äº<code>apache</code>æœåŠ¡çš„è®¤è¯æ–¹å¼ï¼Œè¿™å°±æ˜¯<code>mod_auth_cas</code>ï¼Œæ€è·¯å¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ©ç”¨<code>apache</code>åå‘ä»£ç†ï¼Œåšä¸€ä¸ªç«¯å£ç”¨äºè™šæ‹Ÿä¸»æœºæ¥è½¬å‘<code>SonarQube</code>æœåŠ¡ï¼Œç„¶ååœ¨è¿™ä¸ªè™šæ‹Ÿä¸»æœºå†…éƒ¨åŠ å…¥<code>mod_auth_cas</code>æä¾›çš„è®¤è¯æ‹¦æˆªï¼ŒåŒæ—¶åœ¨é‡Œé¢æŒ‡å®šä¸€ä¸ª<code>HTTP header</code>ç”¨äºå‘é€è®¤è¯åçš„è¯·æ±‚åˆ°<code>SonarQube</code>ï¼Œç„¶åï¼Œ<code>SonarQube</code>æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚åï¼Œå‘ç°æ­£æ˜¯è‡ªå·±è®¾å®šçš„<code>HTTP header</code>ï¼Œäºæ˜¯äºˆä»¥é€šè¿‡è®¤è¯ã€‚è¿™å°±æ˜¯æ•´ä¸ªè®¤è¯æµç¨‹ï¼Œä¸‹é¢å¼€å§‹ä»‹ç»æ•´åˆæ–¹æ³•ã€‚</p><h3 id="SonarQubeä¿®æ”¹"><a href="#SonarQubeä¿®æ”¹" class="headerlink" title="SonarQubeä¿®æ”¹"></a><code>SonarQube</code>ä¿®æ”¹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vi /usr/<span class="built_in">local</span>/sonarqube-7.4/conf/sonar.properties</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å¦‚ä¸‹éƒ¨åˆ†(å°±æ˜¯å°†<code>SSO AUTHENTICATION</code>éƒ¨åˆ†çš„å‚æ•°å–æ¶ˆæ³¨é‡Šï¼Œä»¤å…¶ç”Ÿæ•ˆ)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#--------------------------------------------------------------------------------------------------</span><br><span class="line"># SSO AUTHENTICATION</span><br><span class="line"></span><br><span class="line"># Enable authentication using HTTP headers</span><br><span class="line">sonar.web.sso.enable=true</span><br><span class="line"></span><br><span class="line"># Name of the header to get the user login.</span><br><span class="line"># Only alphanumeric, &apos;.&apos; and &apos;@&apos; characters are allowed</span><br><span class="line">sonar.web.sso.loginHeader=X-Forwarded-Login</span><br><span class="line"></span><br><span class="line"># Name of the header to get the user name</span><br><span class="line">sonar.web.sso.nameHeader=X-Forwarded-Name</span><br><span class="line"></span><br><span class="line"># Name of the header to get the user email (optional)</span><br><span class="line">sonar.web.sso.emailHeader=X-Forwarded-Email</span><br><span class="line"></span><br><span class="line"># Name of the header to get the list of user groups, separated by comma (optional).</span><br><span class="line"># If the sonar.sso.groupsHeader is set, the user will belong to those groups if groups exist in SonarQube.</span><br><span class="line"># If none of the provided groups exists in SonarQube, the user will only belong to the default group.</span><br><span class="line"># Note that the default group will always be set.</span><br><span class="line">sonar.web.sso.groupsHeader=X-Forwarded-Groups</span><br><span class="line"></span><br><span class="line"># Interval used to know when to refresh name, email and groups.</span><br><span class="line"># During this interval, if for instance the name of the user is changed in the header, it will only be updated after X minutes.</span><br><span class="line">sonar.web.sso.refreshIntervalInMinutes=5</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>app.d5dba530.chunk.js</code>ï¼Œè§£å†³ç™»å‡ºé—®é¢˜ï¼Œä¸åŒçš„ç‰ˆæœ¬ä¸åŒï¼Œ<code>7.2.1</code>çš„åœ¨<code>main</code>å¼€å¤´çš„ä¸€ä¸ª<code>js</code>æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/sonarqube-7.4/web/js/app.d5dba530.chunk.js</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t.handleLogout = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"><span class="comment">// e.preventDefault(), t.context.router.push("/sessions/logout") </span></span><br><span class="line">t.context.router.push(<span class="string">"/sessions/logout"</span>)  <span class="comment">//å»æ‰e.preventDefault()æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">r.createElement(<span class="string">"li"</span>, <span class="literal">null</span>, r.createElement(<span class="string">"a"</span>, &#123;</span><br><span class="line"><span class="comment">//href: "#",</span></span><br><span class="line">href: <span class="string">"http://192.168.6.99:8080/cas/logout"</span>,  <span class="comment">//å°†æ­¤æ³¨é”€æŒ‰é’®çš„hrefæ”¹ä¸ºCASæœåŠ¡å™¨çš„ç™»å‡ºé¡µé¢</span></span><br><span class="line">onClick: <span class="keyword">this</span>.handleLogout</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mod-auth-casä¿®æ”¹"><a href="#mod-auth-casä¿®æ”¹" class="headerlink" title="mod_auth_casä¿®æ”¹"></a><code>mod_auth_cas</code>ä¿®æ”¹</h3><p>ç„¶åå®‰è£…<code>mod_auth_cas</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install mod_auth_cas</span></span><br></pre></td></tr></table></figure><p>é…ç½®<code>mod_auth_cas</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/httpd/conf.d/auth_cas.conf</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>CAS</code>çš„<code>Cookie</code>å­˜å‚¨ä½ç½®ä»¥åŠç™»å½•åœ°å€å’ŒéªŒè¯åœ°å€ç­‰å‚æ•°å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LogLevel Debug</span><br><span class="line">CASDebug On</span><br><span class="line">CASVersion 2</span><br><span class="line">CASTimeout 1740</span><br><span class="line">CASIdleTimeout 1740</span><br><span class="line">CASSSOEnabled On</span><br><span class="line">CASCookiePath /var/cache/httpd/mod_auth_cas/</span><br><span class="line">CASLoginURL http://devops.iamzhl.top:8080/cas/login</span><br><span class="line">CASValidateURL http://devops.iamzhl.top:8080/cas/serviceValidate</span><br></pre></td></tr></table></figure><h3 id="apacheä¿®æ”¹"><a href="#apacheä¿®æ”¹" class="headerlink" title="apacheä¿®æ”¹"></a><code>apache</code>ä¿®æ”¹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/httpd/conf/httpd.conf</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ è™šæ‹Ÿä¸»æœº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># æ·»åŠ ä¸€ä¸ªç›‘å¬ç«¯å£ 83 ç”¨ä½œ SonarQube çš„ä»£ç†ä¸»æœº</span><br><span class="line">Listen 83</span><br><span class="line"></span><br><span class="line"># åŠ è½½ mod_auth_cas æ¨¡å—ï¼Œå¦‚æœå·²ç»åŠ è½½è¯·å¿½ç•¥</span><br><span class="line">LoadModule auth_cas_module modules/mod_auth_cas.so</span><br><span class="line"></span><br><span class="line"># è®¾ç½® SonarQube çš„è™šæ‹Ÿä¸»æœº</span><br><span class="line">&lt;VirtualHost *:83&gt;</span><br><span class="line">        ServerName devops.iamzhl.top</span><br><span class="line">        ServerAdmin 15563836030@163.com</span><br><span class="line"></span><br><span class="line">        CASRootProxiedAs http://devops.iamzhl.top:83</span><br><span class="line"></span><br><span class="line">        ProxyPreserveHost On</span><br><span class="line"></span><br><span class="line">        ProxyPass / http://devops.iamzhl.top:9000/</span><br><span class="line">        ProxyPassReverse / http://devops.iamzhl.top:9000/</span><br><span class="line">        ProxyPass /sessions/logout http://devops.iamzhl.top:8080/cas/logout</span><br><span class="line">        ProxyPassReverse /sessions/logout http://devops.iamzhl.top:8080/cas/logout</span><br><span class="line">        ProxyPass /api/authentication/logout http://devops.iamzhl.top:8080/cas/logout</span><br><span class="line">        ProxyPassReverse /api/authentication/logout http://devops.iamzhl.top:8080/cas/logout</span><br><span class="line"></span><br><span class="line">        ErrorLog /var/log/sonar/error.log</span><br><span class="line">        CustomLog /var/log/sonar/access.log common</span><br><span class="line"></span><br><span class="line">        &lt;Location /&gt;</span><br><span class="line">                AuthName &quot;Welcome to devops sonar&quot;</span><br><span class="line">                CASAuthNHeader X-Forwarded-Login</span><br><span class="line">                Authtype CAS</span><br><span class="line">                require valid-user</span><br><span class="line">        &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Proxy *&gt;</span><br><span class="line">                Order deny,allow</span><br><span class="line">                Allow from all</span><br><span class="line">        &lt;/Proxy&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æœåŠ¡"><a href="#é‡å¯æœåŠ¡" class="headerlink" title="é‡å¯æœåŠ¡"></a>é‡å¯æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir /var/log/sonar</span></span><br><span class="line"><span class="comment"># chown -R apache:apache /var/log/sonar</span></span><br><span class="line"><span class="comment"># su sonar</span></span><br><span class="line">$ sonar restart</span><br><span class="line"><span class="comment"># su </span></span><br><span class="line"><span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>æ‰“å¼€ç½‘å€<code>http://devops.iamzhl.top:83</code>ï¼Œå‘ç°è‡ªåŠ¨è·³è½¬åˆ°äº†<code>CAS</code>çš„ç™»å½•ç•Œé¢ï¼Œç½‘å€æ˜¯<code>http://devops.iamzhl.top:8080/cas/login?service=http%3a%2f%2fdevops.iamzhl.top%3a83%2f</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/0b/b05aa63a31ffc624e42290d71c68e8.jpg" alt></p><p>è¾“å…¥ç”¨æˆ·åå¯†ç åç‚¹å‡»ç™»å½•</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/6d/548f70b5aba6e4399e06ae288adfa9.jpg" alt></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œç™»é™†æˆåŠŸï¼Œåœ°å€æ˜¯<code>http://devops.iamzhl.top:83/projects</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/e1/463c767ddd0147ed54fba65d91a0f7.jpg" alt></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç‚¹å‡»æ³¨é”€ï¼Œå°±ä¼šç™»å‡ºå¹¶è·³è½¬è‡³<code>CAS</code>çš„ç™»å‡ºç•Œé¢</p><p><img src="https://gitee.com/athlonreg/picbed/raw/master/Images/e9/a067be6a85ec888bc9ab25bcf0d0e7.jpg" alt></p><p>è‡³æ­¤ï¼Œ<code>SonarQube</code>æ•´åˆ<code>CAS</code>å•ç‚¹ç™»å½•å®Œæˆã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      SonarQube æ•´åˆ LDAP å’Œ CAS å•ç‚¹ç™»å½•
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="CAS" scheme="https://blog.cloudops.ml/tags/CAS/"/>
    
      <category term="LDAP" scheme="https://blog.cloudops.ml/tags/LDAP/"/>
    
      <category term="SonarQube" scheme="https://blog.cloudops.ml/tags/SonarQube/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins æ•´åˆ LDAP ä»¥åŠ CAS å•ç‚¹ç™»å½•</title>
    <link href="https://blog.cloudops.ml/Jenkins-integrate-with-ldap-and-CAS.html"/>
    <id>https://blog.cloudops.ml/Jenkins-integrate-with-ldap-and-CAS.html</id>
    <published>2018-11-30T02:17:09.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><ul><li>Jenkins ç‰ˆæœ¬ï¼š2.138.3</li><li>Jenkins å®‰è£…æ–¹å¼ï¼š Tomcat å®¹å™¨éƒ¨ç½² war åŒ…</li><li>Jenkins åœ°å€ï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgwODAvamVua2lucw==" title="http://devops.iamzhl.top:8080/jenkins">http://devops.iamzhl.top:8080/jenkins<i class="fa fa-external-link"></i></span></li><li>openLDAP æœåŠ¡ï¼šldap://devops.iamzhl.top:389</li><li>CAS æœåŠ¡ï¼š<span class="exturl" data-url="aHR0cDovL2Rldm9wcy5pYW16aGwudG9wOjgwODAvY2Fz" title="http://devops.iamzhl.top:8080/cas">http://devops.iamzhl.top:8080/cas<i class="fa fa-external-link"></i></span></li></ul><h2 id="æ•´åˆ-openLDAP"><a href="#æ•´åˆ-openLDAP" class="headerlink" title="æ•´åˆ openLDAP"></a>æ•´åˆ openLDAP</h2><p>é¦–å…ˆå» Jenkins æ’ä»¶å®˜ç½‘ä¸‹è½½ LDAP å’Œ CAS æ’ä»¶</p><ul><li>LDAPï¼š<span class="exturl" data-url="aHR0cHM6Ly91cGRhdGVzLmplbmtpbnMuaW8vZG93bmxvYWQvcGx1Z2lucy9sZGFwLw==" title="https://updates.jenkins.io/download/plugins/ldap/">https://updates.jenkins.io/download/plugins/ldap/<i class="fa fa-external-link"></i></span></li><li>CASï¼š<span class="exturl" data-url="aHR0cHM6Ly91cGRhdGVzLmplbmtpbnMuaW8vZG93bmxvYWQvcGx1Z2lucy9jYXMtcGx1Z2luLw==" title="https://updates.jenkins.io/download/plugins/cas-plugin/">https://updates.jenkins.io/download/plugins/cas-plugin/<i class="fa fa-external-link"></i></span></li></ul><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/46/53fb1f3e3cfa00c055965bc99c7fbd.jpg" alt></p><p>å¦‚å›¾ï¼Œç‚¹å‡»<code>ç³»ç»Ÿç®¡ç†</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/86/4f0c2ebaef58a3c719397b0adfbc5b.jpg" alt></p><p>ç‚¹å‡»æ’ä»¶ç®¡ç† -&gt; é«˜çº§ -&gt; ä¸Šä¼ æ’ä»¶(é€‰æ‹©æ–‡ä»¶)</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/65/bfd2b91d856ca8132434b2da51de6e.jpg" alt></p><p>å¼¹å‡ºé€‰æ‹©æ–‡ä»¶çš„å¯¹è¯æ¡†åï¼Œé¦–å…ˆé€‰æ‹©æˆ‘ä»¬ä¸‹è½½å¥½çš„ LDAP æ’ä»¶ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ ï¼Œç„¶åå°±ä¼šè·³è½¬åˆ°å®‰è£…ç•Œé¢ï¼Œæˆ‘ä»¬å‹¾é€‰<code>å®‰è£…å®Œæˆåé‡å¯Jenkins(ç©ºé—²æ—¶)</code>ï¼Œç­‰å¾…ä¸€ä¼šJenkinså®‰è£…æ’ä»¶å®Œæˆåå°±ä¼šé‡å¯</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/c5/7cf7ef11ecd49b19b07ea7333cc26a.jpg" alt></p><p>è¾“å…¥ç”¨æˆ·åå¯†ç ç™»å½•åï¼Œä¾æ¬¡æ‰“å¼€<code>ç³»ç»Ÿç®¡ç†</code> -&gt; <code>å…¨å±€å®‰å…¨é…ç½®</code>ï¼Œåœ¨å®‰å…¨åŸŸå‹¾é€‰ LDAPï¼Œç‚¹å‡»<code>Advanced Server Configuration</code>,å¼€å§‹é…ç½® LDAP æœåŠ¡å™¨çš„ç»‘å®šä¿¡æ¯</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/12/adf30303385802ce2fc45d175a7d16.jpg" alt></p><p>ç‚¹å‡»<code>Test LDAP settings</code>ï¼Œæµ‹è¯•<code>LDAP</code>é…ç½®æ˜¯å¦å¯ç”¨ï¼Œå¦‚ä¸‹å›¾ï¼Œè¾“å…¥ä¸€ä¸ª<code>LDAP</code>æœåŠ¡å™¨ä¸­å­˜åœ¨çš„ç”¨æˆ·è´¦å·å’Œå¯†ç ï¼Œç‚¹å‡»<code>Test</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/93/bca0bd8c0ac21d1b2c4cffd7cea3bc.jpg" alt></p><p>å¦‚æœæµ‹è¯•æˆåŠŸï¼Œä¼šæ‰“å°å‡ºç±»ä¼¼å¦‚ä¸‹çš„ä¿¡æ¯</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/f5/7453c8051a55d9622dbe1e461d1b25.jpg" alt></p><p>ç‚¹å‡»<code>åº”ç”¨</code>ï¼Œç„¶åç‚¹å‡»<code>ä¿å­˜</code>ã€‚</p><p>æµ‹è¯•ä¸€ä¸‹ï¼Œç”¨<code>LDAP</code>ä¸­çš„ç”¨æˆ·è¿›è¡Œç™»å½•</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/1e/46a5ac15c7611eff4ade4830966565.jpg" alt></p><p>ç™»é™†æˆåŠŸï¼Œé…ç½®å®Œæˆï¼Œåˆ°è¿™é‡Œï¼Œ<code>Jenkins</code>æ•´åˆ<code>LDAP</code>è®¤è¯å°±å®Œæˆäº†ã€‚</p><h2 id="æ•´åˆ-CAS-å•ç‚¹ç™»å½•"><a href="#æ•´åˆ-CAS-å•ç‚¹ç™»å½•" class="headerlink" title="æ•´åˆ CAS å•ç‚¹ç™»å½•"></a>æ•´åˆ CAS å•ç‚¹ç™»å½•</h2><p>é¦–å…ˆå®‰è£…<code>CAS</code>æ’ä»¶ï¼Œå’Œä¸Šé¢å®‰è£…<code>LDAP</code>æ’ä»¶æ­¥éª¤ä¸€æ ·ï¼Œå®‰è£…å®Œ<code>CAS</code>æ‰“å¼€<code>ç³»ç»Ÿç®¡ç†</code> -&gt; <code>å…¨å±€å®‰å…¨é…ç½®</code>ï¼Œåœ¨å®‰å…¨åŸŸå‹¾é€‰<code>CAS (Central Authentication Service)</code>ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œé…ç½®å¥½<code>CAS</code>çš„<code>URL</code>å’Œ<code>CAS åè®®</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b7/99ca653df5281634fed8a6dcc4f3c2.jpg" alt></p><p>ç„¶åç‚¹å‡»<code>åº”ç”¨</code>-&gt;<code>ä¿å­˜</code>ï¼Œæ³¨é”€ï¼Œç„¶åé‡æ–°ç™»å½•</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/ce/bf7939fceebf45806037fd759179f4.jpg" alt></p><p>è¿™æ—¶å°±å¯ä»¥è·³è½¬åˆ°<code>CAS</code>çš„ç™»å½•ç•Œé¢äº†ï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç ç‚¹å‡»ç™»å½•ï¼Œå°±å¯ä»¥æ­£å¸¸çš„ç™»å½•è¿›å…¥<code>Jenkins</code>ç³»ç»Ÿäº†ã€‚</p><p>è‡³æ­¤ï¼Œ<code>Jenkins</code>æ•´åˆ<code>CAS</code>å®Œæˆã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      Jenkins æ•´åˆ LDAP ä»¥åŠ CAS å•ç‚¹ç™»å½•
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="CAS" scheme="https://blog.cloudops.ml/tags/CAS/"/>
    
      <category term="Jenkins" scheme="https://blog.cloudops.ml/tags/Jenkins/"/>
    
      <category term="LDAP" scheme="https://blog.cloudops.ml/tags/LDAP/"/>
    
  </entry>
  
  <entry>
    <title>shadowsocks-libev</title>
    <link href="https://blog.cloudops.ml/shadowsocks-libev.html"/>
    <id>https://blog.cloudops.ml/shadowsocks-libev.html</id>
    <published>2018-11-25T09:39:40.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ul><li>å›½å¤–æœåŠ¡å™¨ä¸€å°</li><li>CentOS æ“ä½œç³»ç»Ÿ</li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install pcre pcre-devel git wget gcc gcc-c++</span></span><br><span class="line"><span class="comment"># cd ~ &amp;&amp; git clone https://github.com/shadowsocks/shadowsocks-libev.git</span></span><br><span class="line"><span class="comment"># cd shadowsocks-libev &amp;&amp; git submodule update --init --recursive</span></span><br><span class="line"><span class="comment"># yum install gettext gcc autoconf libtool automake make asciidoc xmlto c-ares-devel libev-devel</span></span><br><span class="line"><span class="comment"># echo "LIBSODIUM_VER=1.0.13" &gt;&gt; /etc/profile</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br><span class="line"><span class="comment"># cd ~</span></span><br><span class="line"><span class="comment"># wget https://download.libsodium.org/libsodium/releases/LATEST.tar.gz</span></span><br><span class="line"><span class="comment"># tar zxvf LATEST.tar.gz</span></span><br><span class="line"><span class="comment"># pushd libsodium-stable</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr &amp;&amp; make</span></span><br><span class="line"><span class="comment"># make install</span></span><br><span class="line"><span class="comment"># popd</span></span><br><span class="line"><span class="comment"># ldconfig</span></span><br><span class="line"><span class="comment"># echo "export MBEDTLS_VER=2.6.0" &gt;&gt; /etc/profile</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br><span class="line"><span class="comment"># cd ~ &amp;&amp; wget wget https://tls.mbed.org/download/mbedtls-2.14.0-apache.tgz</span></span><br><span class="line"><span class="comment"># tar xvf mbedtls-2.14.0-apache.tgz</span></span><br><span class="line"><span class="comment"># pushd mbedtls-2.14.0</span></span><br><span class="line"><span class="comment"># make SHARED=1 CFLAGS=-fPIC</span></span><br><span class="line"><span class="comment"># make DESTDIR=/usr install</span></span><br><span class="line"><span class="comment"># popd</span></span><br><span class="line"><span class="comment"># ldconfig</span></span><br><span class="line"><span class="comment"># cd shadowsocks-libev &amp;&amp; ./autogen.sh &amp;&amp; ./configure &amp;&amp; make</span></span><br><span class="line"><span class="comment"># make install</span></span><br><span class="line"><span class="comment"># cd /usr/local &amp;&amp;  wget  https://nchc.dl.sourceforge.net/project/pcre/pcre/8.41/pcre-8.41.tar.gz</span></span><br><span class="line"><span class="comment"># tar -zxvf  pcre-8.41.tar.gz</span></span><br><span class="line"><span class="comment"># cd pcre-8.41 &amp;&amp; ./configure &amp;&amp; make</span></span><br><span class="line"><span class="comment"># make install</span></span><br><span class="line"><span class="comment"># cd /usr/local &amp;&amp; mkdir ssr &amp;&amp; cd ssr</span></span><br><span class="line"><span class="comment"># vi conf.conf</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">"server"</span>:<span class="string">"your server ip"</span>,</span><br><span class="line">        <span class="attr">"server_port"</span>:<span class="number">7788</span>,</span><br><span class="line">        <span class="attr">"local_port"</span>:<span class="number">1080</span>,</span><br><span class="line">        <span class="attr">"password"</span>:<span class="string">"your password for ssr"</span>,</span><br><span class="line">        <span class="attr">"timeout"</span>:<span class="number">60</span>,</span><br><span class="line">        <span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ss-server -c /usr/local/ssr/conf.conf //è¿è¡Œ</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/d4/6463c41c237e134ade8219c099db8e.jpg" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/bin &amp;&amp; vi ssr //åˆ©ç”¨è„šæœ¬åå°è¿è¡Œ</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">nohup ss-server -c /usr/local/ssr/conf.conf &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chmod +x /usr/local/bin/ssr</span></span><br><span class="line"><span class="comment"># ssr</span></span><br><span class="line"><span class="comment"># ps ax | grep ssr</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/a4/ef69a4b5a7ca6de17e5744064ba11d.jpg" alt></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      shadowsocks-libev
    
    </summary>
    
      <category term="study" scheme="https://blog.cloudops.ml/categories/study/"/>
    
    
      <category term="shadowsocks" scheme="https://blog.cloudops.ml/tags/shadowsocks/"/>
    
  </entry>
  
  <entry>
    <title>CentOSå®‰è£…éƒ¨ç½² openLDAP</title>
    <link href="https://blog.cloudops.ml/CentOS-install-openLDAP.html"/>
    <id>https://blog.cloudops.ml/CentOS-install-openLDAP.html</id>
    <published>2018-11-24T14:17:41.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>OpenLDAP æ˜¯è½»å‹ç›®å½•è®¿é—®åè®®<code>Lightweight Directory Access Protocol</code> - <code>LDAP</code>çš„è‡ªç”±å’Œå¼€æºçš„å®ç°ï¼Œåœ¨å…¶<code>OpenLDAP</code>è®¸å¯è¯ä¸‹å‘è¡Œï¼Œå¹¶å·²ç»è¢«åŒ…å«åœ¨ä¼—å¤šæµè¡Œçš„<code>Linux</code>å‘è¡Œç‰ˆä¸­ã€‚</p><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd ~</span></span><br><span class="line"><span class="comment"># yum -y install openldap-servers openldap-clients</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/1c/02ad1e703c7187295361dbff3fad9c.jpg" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span></span><br><span class="line"><span class="comment"># chown ldap:ldap /var/lib/ldap/DB_CONFIG</span></span><br><span class="line"><span class="comment"># systemctl start slapd</span></span><br><span class="line"><span class="comment"># systemctl enable slapd</span></span><br></pre></td></tr></table></figure><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slappasswd</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/75/c5c970bd59e02ac7434f217a5f27a6.jpg" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi chrootpw.ldif</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># specify the password generated above for &quot;olcRootPW&quot; section</span><br><span class="line">dn: olcDatabase=&#123;0&#125;config,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcRootPW</span><br><span class="line">olcRootPW: &#123;SSHA&#125;xxxxxxxxxxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ldapadd -Y EXTERNAL -H ldapi:/// -f chrootpw.ldif</span></span><br></pre></td></tr></table></figure><h2 id="å¯¼å…¥åŸºæœ¬æ¨¡å¼"><a href="#å¯¼å…¥åŸºæœ¬æ¨¡å¼" class="headerlink" title="å¯¼å…¥åŸºæœ¬æ¨¡å¼"></a>å¯¼å…¥åŸºæœ¬æ¨¡å¼</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif </span></span><br><span class="line"><span class="comment"># ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif </span></span><br><span class="line"><span class="comment"># ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif</span></span><br></pre></td></tr></table></figure><h2 id="åœ¨ldapçš„DBä¸­è®¾ç½®åŸŸå"><a href="#åœ¨ldapçš„DBä¸­è®¾ç½®åŸŸå" class="headerlink" title="åœ¨ldapçš„DBä¸­è®¾ç½®åŸŸå"></a>åœ¨ldapçš„DBä¸­è®¾ç½®åŸŸå</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slappasswd</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/de/9a4502a39d572493b8ae8d723a08ef.jpg" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi chdomain.ldif</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># replace to your own domain name for &quot;dc=***,dc=***&quot; section</span><br><span class="line"># specify the password generated above for &quot;olcRootPW&quot; section</span><br><span class="line">dn: olcDatabase=&#123;1&#125;monitor,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to * by dn.base=&quot;gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth&quot;</span><br><span class="line">  read by dn.base=&quot;cn=Manager,dc=iamzhl,dc=top&quot; read by * none</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcSuffix</span><br><span class="line">olcSuffix: dc=iamzhl,dc=top</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootDN</span><br><span class="line">olcRootDN: cn=Manager,dc=iamzhl,dc=top</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcRootPW</span><br><span class="line">olcRootPW: &#123;SSHA&#125;xxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by</span><br><span class="line">  dn=&quot;cn=Manager,dc=iamzhl,dc=top&quot; write by anonymous auth by self write by * none</span><br><span class="line">olcAccess: &#123;1&#125;to dn.base=&quot;&quot; by * read</span><br><span class="line">olcAccess: &#123;2&#125;to * by dn=&quot;cn=Manager,dc=iamzhl,dc=top&quot; write by * read</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ldapmodify -Y EXTERNAL -H ldapi:/// -f chdomain.ldif</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi basedomain.ldif</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># replace to your own domain name for &quot;dc=***,dc=***&quot; section</span><br><span class="line">dn: dc=iamzhl,dc=top</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectclass: organization</span><br><span class="line">o: iamzhl</span><br><span class="line">dc: iamzhl</span><br><span class="line"></span><br><span class="line">dn: cn=Manager,dc=iamzhl,dc=top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: Manager</span><br><span class="line">description: Directory Manager</span><br><span class="line"></span><br><span class="line">dn: ou=People,dc=iamzhl,dc=top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: People</span><br><span class="line"></span><br><span class="line">dn: ou=Group,dc=iamzhl,dc=top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: Group</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ldapadd -x -D cn=Manager,dc=iamzhl,dc=top -W -f basedomain.ldif</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/d1/46842e7f601199c0f78da4d97d30ad.jpg" alt></p><h2 id="æ·»åŠ ä¸€ä¸ªç”¨æˆ·"><a href="#æ·»åŠ ä¸€ä¸ªç”¨æˆ·" class="headerlink" title="æ·»åŠ ä¸€ä¸ªç”¨æˆ·"></a>æ·»åŠ ä¸€ä¸ªç”¨æˆ·</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slappasswd </span></span><br><span class="line"><span class="comment"># vi ldapuser.ldif</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># create new</span><br><span class="line"># replace to your own domain name for &quot;dc=***,dc=***&quot; section</span><br><span class="line">dn: uid=cent,ou=People,dc=iamzhl,dc=top</span><br><span class="line">objectClass: inetOrgPerson</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">cn: Cent</span><br><span class="line">sn: Linux</span><br><span class="line">userPassword: &#123;SSHA&#125;xxxxxxxxxxxxxxxxx</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">uidNumber: 1000</span><br><span class="line">gidNumber: 1000</span><br><span class="line">homeDirectory: /home/cent</span><br><span class="line"></span><br><span class="line">dn: cn=cent,ou=Group,dc=iamzhl,dc=top</span><br><span class="line">objectClass: posixGroup</span><br><span class="line">cn: Cent</span><br><span class="line">gidNumber: 1000</span><br><span class="line">memberUid: cent</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ldapadd -x -D cn=Manager,dc=iamzhl,dc=top -W -f ldapuser.ldif</span></span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ æœ¬æœºçš„ç”¨æˆ·å’Œç¾¤ç»„åˆ°ldapç›®å½•"><a href="#æ·»åŠ æœ¬æœºçš„ç”¨æˆ·å’Œç¾¤ç»„åˆ°ldapç›®å½•" class="headerlink" title="æ·»åŠ æœ¬æœºçš„ç”¨æˆ·å’Œç¾¤ç»„åˆ°ldapç›®å½•"></a>æ·»åŠ æœ¬æœºçš„ç”¨æˆ·å’Œç¾¤ç»„åˆ°ldapç›®å½•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi ldapuser.sh</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> extract <span class="built_in">local</span> users and groups who have 1000-9999 digit UID</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replace <span class="string">"SUFFIX=***"</span> to your own domain name</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this is an example</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">SUFFIX='dc=iamzhl,dc=top'</span><br><span class="line">LDIF='ldapuser.ldif'</span><br><span class="line"></span><br><span class="line">echo -n &gt; $LDIF</span><br><span class="line">GROUP_IDS=()</span><br><span class="line">grep "x:[1-9][0-9][0-9][0-9]:" /etc/passwd | (while read TARGET_USER</span><br><span class="line">do</span><br><span class="line">    USER_ID="$(echo "$TARGET_USER" | cut -d':' -f1)"</span><br><span class="line"></span><br><span class="line">    USER_NAME="$(echo "$TARGET_USER" | cut -d':' -f5 | cut -d' ' -f1,2)"</span><br><span class="line">    [ ! "$USER_NAME" ] &amp;&amp; USER_NAME="$USER_ID"</span><br><span class="line"></span><br><span class="line">    LDAP_SN="$(echo "$USER_NAME" | cut -d' ' -f2)"</span><br><span class="line">    [ ! "$LDAP_SN" ] &amp;&amp; LDAP_SN="$USER_NAME"</span><br><span class="line"></span><br><span class="line">    LASTCHANGE_FLAG="$(grep "$&#123;USER_ID&#125;:" /etc/shadow | cut -d':' -f3)"</span><br><span class="line">    [ ! "$LASTCHANGE_FLAG" ] &amp;&amp; LASTCHANGE_FLAG="0"</span><br><span class="line"></span><br><span class="line">    SHADOW_FLAG="$(grep "$&#123;USER_ID&#125;:" /etc/shadow | cut -d':' -f9)"</span><br><span class="line">    [ ! "$SHADOW_FLAG" ] &amp;&amp; SHADOW_FLAG="0"</span><br><span class="line"></span><br><span class="line">    GROUP_ID="$(echo "$TARGET_USER" | cut -d':' -f4)"</span><br><span class="line">    [ ! "$(echo "$&#123;GROUP_IDS[@]&#125;" | grep "$GROUP_ID")" ] &amp;&amp; GROUP_IDS=("$&#123;GROUP_IDS[@]&#125;" "$GROUP_ID")</span><br><span class="line"></span><br><span class="line">    echo "dn: uid=$USER_ID,ou=People,$SUFFIX" &gt;&gt; $LDIF</span><br><span class="line">    echo "objectClass: inetOrgPerson" &gt;&gt; $LDIF</span><br><span class="line">    echo "objectClass: posixAccount" &gt;&gt; $LDIF</span><br><span class="line">    echo "objectClass: shadowAccount" &gt;&gt; $LDIF</span><br><span class="line">    echo "sn: $LDAP_SN" &gt;&gt; $LDIF</span><br><span class="line">    echo "givenName: $(echo "$USER_NAME" | awk '&#123;print $1&#125;')" &gt;&gt; $LDIF</span><br><span class="line">    echo "cn: $USER_NAME" &gt;&gt; $LDIF</span><br><span class="line">    echo "displayName: $USER_NAME" &gt;&gt; $LDIF</span><br><span class="line">    echo "uidNumber: $(echo "$TARGET_USER" | cut -d':' -f3)" &gt;&gt; $LDIF</span><br><span class="line">    echo "gidNumber: $(echo "$TARGET_USER" | cut -d':' -f4)" &gt;&gt; $LDIF</span><br><span class="line">    echo "userPassword: &#123;crypt&#125;$(grep "$&#123;USER_ID&#125;:" /etc/shadow | cut -d':' -f2)" &gt;&gt; $LDIF</span><br><span class="line">    echo "gecos: $USER_NAME" &gt;&gt; $LDIF</span><br><span class="line">    echo "loginShell: $(echo "$TARGET_USER" | cut -d':' -f7)" &gt;&gt; $LDIF</span><br><span class="line">    echo "homeDirectory: $(echo "$TARGET_USER" | cut -d':' -f6)" &gt;&gt; $LDIF</span><br><span class="line">    echo "shadowExpire: $(passwd -S "$USER_ID" | awk '&#123;print $7&#125;')" &gt;&gt; $LDIF</span><br><span class="line">    echo "shadowFlag: $SHADOW_FLAG" &gt;&gt; $LDIF</span><br><span class="line">    echo "shadowWarning: $(passwd -S "$USER_ID" | awk '&#123;print $6&#125;')" &gt;&gt; $LDIF</span><br><span class="line">    echo "shadowMin: $(passwd -S "$USER_ID" | awk '&#123;print $4&#125;')" &gt;&gt; $LDIF</span><br><span class="line">    echo "shadowMax: $(passwd -S "$USER_ID" | awk '&#123;print $5&#125;')" &gt;&gt; $LDIF</span><br><span class="line">    echo "shadowLastChange: $LASTCHANGE_FLAG" &gt;&gt; $LDIF</span><br><span class="line">    echo &gt;&gt; $LDIF</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for TARGET_GROUP_ID in "$&#123;GROUP_IDS[@]&#125;"</span><br><span class="line">do</span><br><span class="line">    LDAP_CN="$(grep ":$&#123;TARGET_GROUP_ID&#125;:" /etc/group | cut -d':' -f1)"</span><br><span class="line"></span><br><span class="line">    echo "dn: cn=$LDAP_CN,ou=Group,$SUFFIX" &gt;&gt; $LDIF</span><br><span class="line">    echo "objectClass: posixGroup" &gt;&gt; $LDIF</span><br><span class="line">    echo "cn: $LDAP_CN" &gt;&gt; $LDIF</span><br><span class="line">    echo "gidNumber: $TARGET_GROUP_ID" &gt;&gt; $LDIF</span><br><span class="line"></span><br><span class="line">    for MEMBER_UID in $(grep ":$&#123;TARGET_GROUP_ID&#125;:" /etc/passwd | cut -d':' -f1,3)</span><br><span class="line">    do</span><br><span class="line">        UID_NUM=$(echo "$MEMBER_UID" | cut -d':' -f2)</span><br><span class="line">        [ $UID_NUM -ge 1000 -a $UID_NUM -le 9999 ] &amp;&amp; echo "memberUid: $(echo "$MEMBER_UID" | cut -d':' -f1)" &gt;&gt; $LDIF</span><br><span class="line">    done</span><br><span class="line">    echo &gt;&gt; $LDIF</span><br><span class="line">done</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sh ldapuser.sh </span></span><br><span class="line"><span class="comment"># ldapadd -x -D cn=Manager,dc=iamzhl,dc=top -W -f ldapuser.ldif</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/d5/aaa70f4f22ad6ee40fa74bf027bd4b.jpg" alt></p><h2 id="åˆ©ç”¨Apache-Directory-Studioè¿›è¡Œç®¡ç†"><a href="#åˆ©ç”¨Apache-Directory-Studioè¿›è¡Œç®¡ç†" class="headerlink" title="åˆ©ç”¨Apache Directory Studioè¿›è¡Œç®¡ç†"></a>åˆ©ç”¨Apache Directory Studioè¿›è¡Œç®¡ç†</h2><p>Apache Directory Studio æ˜¯ä¸€ä¸ª LDAP çš„å·¥å…·å¹³å°ï¼Œç”¨æ¥è¿æ¥åˆ°ä»»ä½• LDAP æœåŠ¡å™¨å¹¶è¿›è¡Œç®¡ç†å’Œå¼€å‘å·¥ä½œã€‚å…¶å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li>LDAPæµè§ˆå™¨</li><li>LDIFç¼–è¾‘å™¨</li><li>åµŒå…¥å¼ ApacheDS</li><li>ACIç¼–è¾‘å™¨</li><li>å±æ€§ç®¡ç†</li></ul><p>ä¸‹é¢ä»¥æ–°å»ºè¿æ¥å’Œæ–°å¢ç”¨æˆ·ä¸ºä¾‹è¿›è¡Œæ¼”ç¤º</p><p>å¦‚å›¾ï¼Œç‚¹å‡» New Connection æ–°å»ºä¸€ä¸ª ldap è¿æ¥</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/12/d782ef026127039c48173727402ae1.jpg" alt></p><p>ä¾æ¬¡è¾“å…¥è¿æ¥åã€ä¸»æœºåä»¥åŠç«¯å£å·åç‚¹å‡»<code>Next</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b4/8238cc5d14bd32906fb1bf4d2fb726.jpg" alt></p><p>å†ä¾æ¬¡è¾“å…¥ç»‘å®šçš„<code>DN</code>å’Œå¯†ç åç‚¹å‡»<code>Finish</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/6d/33932a9dccd444922051239295a40e.jpg" alt></p><p>æ–°å»ºä¸€ä¸ª openLDAP ç”¨æˆ· test / 123456</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/0e/e69bb807212cc32a80cb28c4b927e1.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/01/ab9d40ac8d216e3e2b99a287082fa7.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/14/de8c6a3b3854b28bca29d84e338f9f.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/53/287f9a9a0cfe1c25c3c66d775fb214.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/af/af3a63b732070ac51f27b10f6e2dca.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b3/da28177e70ab2cb77421d6ae16ca95.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/70/749184f3907b06951093fc2a944e42.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/c0/5ddca5f311e7f8b2ba598480c3636e.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/e7/8a989532254213ac72efc235676a2a.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/2e/ebca96c81bd780e9b90d9bdbd3415a.jpg" alt></p><h2 id="Credits"><a href="#Credits" class="headerlink" title="Credits"></a>Credits</h2><p>æœ¬æ–‡å¤šå¤„å‚è€ƒ<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlbndlbnhpb25nL2FydGljbGUvZGV0YWlscy83Njg1NTA0Nw==" title="https://blog.csdn.net/wenwenxiong/article/details/76855047">centos7ä¸‹ldapæœåŠ¡æ­å»º<i class="fa fa-external-link"></i></span>ï¼Œæ„Ÿè°¢<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlbndlbnhpb25n" title="https://blog.csdn.net/wenwenxiong">wenwenxiong<i class="fa fa-external-link"></i></span>çš„åˆ†äº«ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      CentOSå®‰è£…éƒ¨ç½² openLDAP
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="openLDAP" scheme="https://blog.cloudops.ml/tags/openLDAP/"/>
    
  </entry>
  
  <entry>
    <title>CAS 5.3.4 å®‰è£…éƒ¨ç½²</title>
    <link href="https://blog.cloudops.ml/CAS-5-3-4-install-and-deploy.html"/>
    <id>https://blog.cloudops.ml/CAS-5-3-4-install-and-deploy.html</id>
    <published>2018-11-24T12:59:49.000Z</published>
    <updated>2019-08-11T14:11:07.323Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><code>CAS</code>å…¨ç§°<code>Central Authentication Service</code>ï¼Œä¸­å¤®è®¤è¯æœåŠ¡ï¼Œä¸€ç§ç‹¬ç«‹å¼€æ”¾æŒ‡ä»¤åè®®ã€‚CAS æ˜¯ Yale å¤§å­¦å‘èµ·çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨ä¸º Web åº”ç”¨ç³»ç»Ÿæä¾›ä¸€ç§å¯é çš„å•ç‚¹ç™»å½•æ–¹æ³•ï¼ŒCAS åœ¨ 2004 å¹´ 12 æœˆæ­£å¼æˆä¸º JA-SIG çš„ä¸€ä¸ªé¡¹ç›®ï¼Œç›®å‰æ˜¯ä¸€ç§ä¼ä¸šçº§çš„å•ç‚¹ç™»å½•è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="åè®®ä»‹ç»"><a href="#åè®®ä»‹ç»" class="headerlink" title="åè®®ä»‹ç»"></a>åè®®ä»‹ç»</h2><p>å…³äº oauth2.0 çš„åŸç†åŠä»‹ç»å¯ä»¥å‚è€ƒ<span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTQvMDUvb2F1dGhfMl8wLmh0bWw=" title="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">ç†è§£OAuth 2.0 - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—<i class="fa fa-external-link"></i></span>ï¼Œè¿™é‡Œä¸åšèµ˜è¿°ã€‚</p><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p><code>CAS</code>æ˜¯åŸºäºSpringå†™çš„ï¼Œå› æ­¤éœ€è¦å‡†å¤‡Javaç¯å¢ƒï¼Œå®˜æ–¹æä¾›äº†ä¸€ç§éå¸¸å¥½ç”¨çš„ç¼–è¯‘æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥å†³å®šä¾èµ–çš„é€‰æ‹©ï¼Œæœ¬æ–‡ä¸»è¦ä»¥openLDAPå’Œoauthä¸ºä¾‹ã€‚ç¼–è¯‘æ—¶éœ€è¦mavenç¯å¢ƒã€‚è¿è¡Œæ—¶éœ€è¦ Tomcat å®¹å™¨ï¼Œå› æ­¤éœ€è¦æå‰å‡†å¤‡å¥½ Tomcat ç¯å¢ƒã€‚åç»­æˆ‘ä»¬ä¼šæ•´åˆ openLDAP åšç»Ÿä¸€ç”¨æˆ·ç®¡ç†ï¼Œå› æ­¤è¯·å…ˆå®‰è£…å¥½ openLDAPã€‚</p><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p>é¦–å…ˆå»é¡¹ç›®åœ°å€ä¸‹è½½ç¼–è¯‘æ¨¡æ¿</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apereo/cas-overlay-template</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/apereo/cas-overlay-template</span></span><br><span class="line"><span class="comment"># cd cas-overlay-template</span></span><br><span class="line"><span class="comment"># vi pom.xml</span></span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸‹é¢çš„éƒ¨åˆ†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-webapp$&#123;app.server&#125;&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;type&gt;war&lt;/type&gt;</span><br><span class="line">        &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    ...Additional dependencies may be placed here...</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><p>å°†æ³¨é‡Šçš„éƒ¨åˆ†æ›¿æ¢ä¸ºæˆ‘ä»¬éœ€è¦çš„æ¨¡å—</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-webapp$&#123;app.server&#125;&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;type&gt;war&lt;/type&gt;</span><br><span class="line">        &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-oauth-webflow&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;mysql.driver.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-jdbc&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-jdbc-drivers&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-rest&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-ldap&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-jpa-ticket-registry&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-jpa-service-registry&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-rest-services&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apereo.cas&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-server-support-json-service-registry&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;cas.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¾‹å­ä¸­æˆ‘æ·»åŠ äº†openLDAP oauth2.0 mysqlçš„ä¾èµ–ï¼Œå…·ä½“è¯·æŒ‰ç…§è‡ªå·±éœ€æ±‚é€‰æ‹©ã€‚</p><blockquote><p>æ·»åŠ  MySQL éœ€è¦æŒ‡å®š connector-java è¿æ¥å™¨çš„ç‰ˆæœ¬</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mysql.driver.version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">mysql.driver.version</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç¼–è¾‘å¥½pomæ–‡ä»¶åï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¼€å§‹ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mvn clean package</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/42/20e1a20a856b8d98083544240e949b.jpg" alt></p><p>è¿‡ç¨‹å¾ˆé•¿ï¼Œéœ€è¦è”ç½‘ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¼–è¯‘å®Œæˆåï¼Œä¼šåœ¨æ­¤ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª target ç›®å½•ï¼Œæˆ‘ä»¬éœ€è¦çš„ war åŒ…å°±åœ¨é‡Œé¢ã€‚</p><h2 id="å®‰è£…æµ‹è¯•"><a href="#å®‰è£…æµ‹è¯•" class="headerlink" title="å®‰è£…æµ‹è¯•"></a>å®‰è£…æµ‹è¯•</h2><p>å®‰è£…è¿‡ç¨‹å°±æ¯”è¾ƒç®€å•äº†ï¼Œå°† war åŒ…ä¿å­˜è‡³ Tomcat ä¸‹ webapps ç›®å½•ä¸‹ï¼Œç„¶åè¿è¡Œ Tomcat å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># startup.sh</span></span><br><span class="line"><span class="comment"># tail -f /usr/local/tomcat/logs/catalina.out</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b7/bfb043dc833a972751ad396ccc63c5.jpg" alt></p><p>è¿è¡Œå®Œæˆåæ—¥å¿—å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç„¶åæˆ‘ä»¬æ‰“å¼€ <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDgwL2Nhcw==" title="http://localhost:8080/cas">http://localhost:8080/cas<i class="fa fa-external-link"></i></span></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/91/6097314bc496dd2404ecc7ccac8a28.jpg" alt></p><p>é»˜è®¤çš„ç”¨æˆ·åå¯†ç ä¸º casuser / Mellonï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç ç‚¹å‡»ç™»å½•ï¼Œç™»å½•æˆåŠŸåå¦‚å›¾è·³è½¬è‡³ç™»å½•æˆåŠŸé¡µé¢</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/41/4c9e1c4a3a9632ffd3475df7798005.jpg" alt></p><p>å®‰è£…è‡³æ­¤å®Œæˆ</p><h2 id="å¼€å¯-oauth-2-0-æˆæƒ"><a href="#å¼€å¯-oauth-2-0-æˆæƒ" class="headerlink" title="å¼€å¯ oauth 2.0 æˆæƒ"></a>å¼€å¯ oauth 2.0 æˆæƒ</h2><blockquote><p>application.properties å¢åŠ é…ç½®æ–‡ä»¶å¦‚ä¸‹</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/tomcat/webapps/cas/WEB-INF/classes/application.properties</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cas.authn.oauth.refreshToken.timeToKillInSeconds=2592000</span><br><span class="line">cas.authn.oauth.code.timeToKillInSeconds=30</span><br><span class="line">cas.authn.oauth.code.numberOfUses=1</span><br><span class="line">cas.authn.oauth.accessToken.releaseProtocolAttributes=true</span><br><span class="line">cas.authn.oauth.accessToken.timeToKillInSeconds=7200</span><br><span class="line">cas.authn.oauth.accessToken.maxTimeToLiveInSeconds=28800</span><br><span class="line">cas.authn.oauth.grants.resourceOwner.requireServiceHeader=true</span><br><span class="line">cas.authn.oauth.userProfileViewType=NESTED</span><br></pre></td></tr></table></figure><blockquote><p>å¢åŠ  OAUTH-1002.json service æ³¨å†Œæ–‡ä»¶</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/tomcat/webapps/cas/WEB-INF/classes/servies/OAUTH-1002.json</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;@class&quot; : &quot;org.apereo.cas.support.oauth.services.OAuthRegisteredService&quot;,</span><br><span class="line">  &quot;clientId&quot;: &quot;20181124&quot;,</span><br><span class="line">  &quot;clientSecret&quot;: &quot;123456&quot;,</span><br><span class="line">  &quot;serviceId&quot; : &quot;^(https|http|imaps)://.*&quot;,</span><br><span class="line">  &quot;name&quot; : &quot;OAuthService&quot;,</span><br><span class="line">  &quot;id&quot; : 1002</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>é‡å¯ Tomcat æµ‹è¯•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shutdown.sh                   </span></span><br><span class="line">Using CATALINA_BASE:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/<span class="built_in">local</span>/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr</span><br><span class="line">Using CLASSPATH:       /usr/<span class="built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="built_in">local</span>/tomcat/bin/tomcat-juli.jar</span><br><span class="line"><span class="comment"># startup.sh </span></span><br><span class="line">Using CATALINA_BASE:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/<span class="built_in">local</span>/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr</span><br><span class="line">Using CLASSPATH:       /usr/<span class="built_in">local</span>/tomcat/bin/bootstrap.jar:/usr/<span class="built_in">local</span>/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>é‡å¯å®Œæˆåï¼Œæˆ‘ä»¬åˆ©ç”¨æœ¬åšå®¢ä½œä¸ºç›®æ ‡è®¿é—®ç½‘å€è¿›è¡Œæµ‹è¯•ï¼Œæµè§ˆå™¨æ‰“å¼€ <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDgwL2Nhcy9vYXV0aDIuMC9hdXRob3JpemU/cmVzcG9uc2VfdHlwZT1jb2RlJmFtcDtjbGllbnRfaWQ9MjAxODExMjQmYW1wO3JlZGlyZWN0X3VyaT1odHRwczovL2Jsb2cuaWFtemhsLnRvcA==" title="http://localhost:8080/cas/oauth2.0/authorize?response_type=code&amp;client_id=20181124&amp;redirect_uri=https://blog.iamzhl.top">http://localhost:8080/cas/oauth2.0/authorize?response_type=code&amp;client_id=20181124&amp;redirect_uri=https://blog.iamzhl.top<i class="fa fa-external-link"></i></span></p><p>å‘ç°è·³è½¬äº†ä¸€ä¸ªç¤ºä¾‹ç½‘å€</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b1/603980e19d03912f2c01b3a7c94b80.jpg" alt></p><p>è¿™æ—¶æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸‹ä¸¤ä¸ªå˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/tomcat/webapps/cas/WEB-INF/classes/application.properties</span></span><br></pre></td></tr></table></figure><p>åŠ å…¥ä¸‹é¢ä¸¤è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cas.server.name=http://devops.iamzhl.top:8080/cas</span><br><span class="line">cas.server.prefix=$&#123;cas.server.name&#125;</span><br></pre></td></tr></table></figure><p>è¯·å°† devops.iamzhl.top æ”¹ä¸ºä½ çš„ ipï¼Œç„¶åé‡å¯ Tomcat å†æ¬¡æµ‹è¯•</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/66/574e93fdcc2b8ab686a46ec772627d.jpg" alt></p><p>è¿™æ¬¡èƒ½æ­£å¸¸è·³è½¬äº†ï¼Œä½†æ˜¯å‡ºç°äº†<code>æœªè®¤è¯æˆæƒçš„æœåŠ¡</code>ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å¼€å¯ http åè®®æ”¯æŒï¼Œå› æ­¤åªè¦å†è®©æˆ‘ä»¬çš„ CAS Server æ”¯æŒ http è®¤è¯å°±è¡Œäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/tomcat/webapps/cas/WEB-INF/classes/application.properties</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¸‹é¢ä¸¤è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cas.tgc.secure=false</span><br><span class="line">cas.serviceRegistry.initFromJson=true</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/tomcat/webapps/cas/WEB-INF/classes/services/HTTPSandIMAPS-10000001.json</span></span><br></pre></td></tr></table></figure><p>å°†<code>&quot;serviceId&quot; : &quot;^(https|imaps)://.*&quot;,</code>æ”¹ä¸º<code>&quot;serviceId&quot; : &quot;^(https|http|imaps)://.*&quot;,</code>ï¼Œå¦‚å›¾</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/2b/cca4a5df53dd47b94e73664bdc8ff3.jpg" alt></p><p>å†æ¬¡ç™»å½•æµ‹è¯•</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/f5/c1a598cd7ecd0a96df200f38659aec.jpg" alt></p><p>è¿™æ¬¡ç»ˆäºæ­£å¸¸äº†ï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç ç‚¹å‡»ç™»å½•ï¼Œå°±ä¼šè·³è½¬åˆ°æˆæƒé¡µé¢</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/ae/c40e776bfcecf0ca8b48c4e9582dbc.jpg" alt></p><p>ç‚¹å‡» Allow å³å¯æˆåŠŸæˆæƒè·³è½¬è‡³æœ¬åšå®¢ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ° uri ä¼šæºå¸¦ä¸€ä¸ª codeï¼Œè¿™å°±æ˜¯ CAS ç›®å‰åœ¨ oauth2.0 æˆæƒä¸­æœ€ä¸ºå®Œå–„çš„ code æˆæƒæ¨¡å¼äº†ã€‚</p><p>è‡³æ­¤ï¼Œ CAS 5.3 é›†æˆ oauth2.0 çš„æˆæƒå·²ç»æ­å»ºå®Œæ¯•</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/13/f1a8df13c6ee93210a970833c5059a.jpg" alt></p><h2 id="æ•´åˆ-openLDAP"><a href="#æ•´åˆ-openLDAP" class="headerlink" title="æ•´åˆ openLDAP"></a>æ•´åˆ openLDAP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /usr/local/tomcat/webapps/cas/WEB-INF/classes/application.properties</span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šæ‰é»˜è®¤çš„ <code>cas.authn.accept.users</code> è®¤è¯æ–¹å¼å¹¶æ·»åŠ ä¸<code>LDAP Server</code>è¿æ¥çš„é…ç½®(è¯·æ ¹æ®è‡ªå·±çš„<code>LDAP</code>æœåŠ¡å™¨ä¿¡æ¯è¿›è¡Œä¿®æ”¹)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">##</span><br><span class="line"># CAS Authentication Credentials</span><br><span class="line">#</span><br><span class="line"># cas.authn.accept.users=casuser::Mellon</span><br><span class="line">cas.authn.ldap[0].principalAttributeList=sn,cn:commonName,givenName,eduPersonTargettedId:SOME_IDENTIFIER</span><br><span class="line">cas.authn.ldap[0].collectDnAttribute=false</span><br><span class="line">cas.authn.ldap[0].principalDnAttributeName=principalLdapDn</span><br><span class="line">cas.authn.ldap[0].allowMultiplePrincipalAttributeValues=true</span><br><span class="line">cas.authn.ldap[0].allowMissingPrincipalAttributeValue=true</span><br><span class="line">cas.authn.ldap[0].credentialCriteria=</span><br><span class="line">cas.authn.attributeRepository.ldap[0].attributes.uid=uid</span><br><span class="line">cas.authn.attributeRepository.ldap[0].attributes.displayName=displayName</span><br><span class="line">cas.authn.attributeRepository.ldap[0].attributes.cn=commonName</span><br><span class="line">cas.authn.attributeRepository.ldap[0].attributes.affiliation=groupMembership</span><br><span class="line">cas.authn.ldap[0].ldapUrl=ldap://devops.iamzhl.top:389</span><br><span class="line">cas.authn.ldap[0].bindDn=cn=Manager,dc=iamzhl,dc=top</span><br><span class="line">cas.authn.ldap[0].bindCredential=passwd</span><br><span class="line">cas.authn.ldap[0].poolPassivator=BIND</span><br><span class="line">cas.authn.ldap[0].connectionStrategy=</span><br><span class="line">cas.authn.ldap[0].providerClass=org.ldaptive.provider.unboundid.UnboundIDProvider</span><br><span class="line">cas.authn.ldap[0].connectTimeout=5000</span><br><span class="line">cas.authn.ldap[0].trustCertificates=</span><br><span class="line">cas.authn.ldap[0].keystore=</span><br><span class="line">cas.authn.ldap[0].keystorePassword=</span><br><span class="line">cas.authn.ldap[0].keystoreType=PKCS12</span><br><span class="line">cas.authn.ldap[0].minPoolSize=3</span><br><span class="line">cas.authn.ldap[0].maxPoolSize=10</span><br><span class="line">cas.authn.ldap[0].validateOnCheckout=true</span><br><span class="line">cas.authn.ldap[0].validatePeriodically=true</span><br><span class="line">cas.authn.ldap[0].validatePeriod=500</span><br><span class="line">cas.authn.ldap[0].validateTimeout=5000</span><br><span class="line">cas.authn.ldap[0].failFast=true</span><br><span class="line">cas.authn.ldap[0].idleTime=500</span><br><span class="line">cas.authn.ldap[0].prunePeriod=24</span><br><span class="line">cas.authn.ldap[0].blockWaitTime=5000</span><br><span class="line">cas.authn.ldap[0].useSsl=false</span><br><span class="line">cas.authn.ldap[0].useStartTls=false</span><br><span class="line">cas.authn.ldap[0].responseTimeout=8000</span><br><span class="line">cas.authn.ldap[0].allowMultipleDns=false</span><br><span class="line">cas.authn.ldap[0].name=</span><br><span class="line">cas.authn.ldap[0].type=AUTHENTICATED</span><br><span class="line">cas.authn.ldap[0].searchFilter=uid=&#123;user&#125;</span><br><span class="line">#cas.authn.ldap[0].enhanceWithEntryResolver=true</span><br><span class="line">cas.authn.ldap[0].derefAliases=NEVER</span><br><span class="line">cas.authn.ldap[0].dnFormat=uid=%s,ou=People,dc=iamzhl,dc=top</span><br><span class="line">cas.authn.ldap[0].baseDn=ou=People,dc=iamzhl,dc=top</span><br></pre></td></tr></table></figure><p>é‡å¯ Tomcat æŸ¥çœ‹æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shutdown.sh</span></span><br><span class="line"><span class="comment"># startup.sh</span></span><br><span class="line"><span class="comment"># tail -f /usr/local/tomcat/logs/catalina.out</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/f2/308f5dc1de191625e6087c1d040824.jpg" alt></p><p>æ–°å»ºä¸€ä¸ª openLDAP ç”¨æˆ· test / 123456</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/0e/e69bb807212cc32a80cb28c4b927e1.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/01/ab9d40ac8d216e3e2b99a287082fa7.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/14/de8c6a3b3854b28bca29d84e338f9f.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/53/287f9a9a0cfe1c25c3c66d775fb214.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/af/af3a63b732070ac51f27b10f6e2dca.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/b3/da28177e70ab2cb77421d6ae16ca95.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/70/749184f3907b06951093fc2a944e42.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/c0/5ddca5f311e7f8b2ba598480c3636e.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/e7/8a989532254213ac72efc235676a2a.jpg" alt></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/2e/ebca96c81bd780e9b90d9bdbd3415a.jpg" alt></p><p>æ‰“å¼€ CAS ç½‘å€æµ‹è¯• <code>http://devops.iamzhl.top:8080/cas/login</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/48/9f8dc131728eda81cd522d5db954d4.jpg" alt></p><p>è¾“å…¥ç”¨æˆ·åå¯†ç ç™»é™†æˆåŠŸ</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/89/2e8366b3accc1248a4043079a958a3.jpg" alt></p><p>æ—¥å¿—è¾“å‡ºå¦‚ä¸‹</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/c3/cf45af8f7ab6b3aa80267f95cb6a42.jpg" alt></p><p>è‡³æ­¤ï¼ŒCAS 5.3 æ•´åˆ openLDAP ç»“æŸã€‚</p><h2 id="æ•´åˆ-MySQL-è®¤è¯"><a href="#æ•´åˆ-MySQL-è®¤è¯" class="headerlink" title="æ•´åˆ MySQL è®¤è¯"></a>æ•´åˆ MySQL è®¤è¯</h2><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><blockquote><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/tomcat/webapps/cas/WEB-INF/classes/application.properties</span><br></pre></td></tr></table></figure><blockquote><p>æœ€åæ·»åŠ å¦‚ä¸‹å†…å®¹ (éœ€è¦å°†é™æ€è®¤è¯å…³é—­ï¼Œå³ cas.authn.accept.users é…ç½®é¡¹æ³¨é‡Šæ‰å³å¯)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">##</span><br><span class="line"># MySQL Authentication Credentials</span><br><span class="line">#</span><br><span class="line"># å®šä¹‰æŸ¥è¯¢ç”¨æˆ·åçš„ sql è¯­å¥</span><br><span class="line">cas.authn.jdbc.query[0].sql=select * from sys_user where username=?</span><br><span class="line"># å®šä¹‰ç”¨æˆ·å¯†ç å­—æ®µ</span><br><span class="line">cas.authn.jdbc.query[0].fieldPassword=password</span><br><span class="line"># å®šä¹‰æç¤ºä¿®æ”¹å¯†ç å­—æ®µ</span><br><span class="line">cas.authn.jdbc.query[0].fieldExpired=expired</span><br><span class="line"># å®šä¹‰ç¦ç”¨ç”¨æˆ·çš„å­—æ®µ</span><br><span class="line">cas.authn.jdbc.query[0].fieldDisabled=disabled</span><br><span class="line"># ä½¿ç”¨çš„æ•°æ®åº“æ–¹è¨€</span><br><span class="line">cas.authn.jdbc.query[0].dialect=org.hibernate.dialect.MySQLDialect</span><br><span class="line"># å®šä¹‰æ•°æ®åº“ç±»</span><br><span class="line">cas.authn.jdbc.query[0].driverClass=com.mysql.jdbc.Driver</span><br><span class="line"># ä½¿ç”¨çš„æ•°æ®åº“</span><br><span class="line">cas.authn.jdbc.query[0].url=jdbc:mysql://localhost:3306/cas?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false</span><br><span class="line"># ä½¿ç”¨çš„æ•°æ®åº“ç”¨æˆ·</span><br><span class="line">cas.authn.jdbc.query[0].user=root</span><br><span class="line"># æ•°æ®åº“ root ç”¨æˆ·å¯†ç </span><br><span class="line">cas.authn.jdbc.query[0].password=123456</span><br><span class="line"></span><br><span class="line">#é»˜è®¤åŠ å¯†ç­–ç•¥ï¼Œé€šè¿‡encodingAlgorithmæ¥æŒ‡å®šç®—æ³•ï¼Œé»˜è®¤NONEä¸åŠ å¯†</span><br><span class="line">cas.authn.jdbc.query[0].passwordEncoder.type=DEFAULT</span><br><span class="line">cas.authn.jdbc.query[0].passwordEncoder.characterEncoding=UTF-8</span><br><span class="line">cas.authn.jdbc.query[0].passwordEncoder.encodingAlgorithm=MD5</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®åº“é…ç½®"><a href="#æ•°æ®åº“é…ç½®" class="headerlink" title="æ•°æ®åº“é…ç½®"></a>æ•°æ®åº“é…ç½®</h3><blockquote><p>åˆ›å»ºæ•°æ®åº“</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database cas;</span><br></pre></td></tr></table></figure><blockquote><p>åˆ›å»ºè¡¨</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use cas</span><br><span class="line">mysql&gt; create table sys_user (</span><br><span class="line"> `id` int(11) not null auto_increment,</span><br><span class="line"> `username` varchar(30) not null,</span><br><span class="line"> `password` varchar(64) not null,</span><br><span class="line"> `email`    varchar(50),</span><br><span class="line"> `address`  varchar(100),</span><br><span class="line"> `age`      int,</span><br><span class="line"> `expired` int,</span><br><span class="line"> `disabled` int,</span><br><span class="line"> `locked` int,</span><br><span class="line">  primary key (`id`)</span><br><span class="line">) engine=innodb auto_increment=1 default charset=utf8;</span><br></pre></td></tr></table></figure><blockquote><p>æ•°æ®è¡¨å­—æ®µè¯´æ˜:</p></blockquote><p><strong><em>id ä¸ºè‡ªå¢å­—æ®µï¼Œusername ä¸ºç”¨æˆ·åï¼Œpassword ä¸ºè´¦å·å¯†ç ï¼Œemail ä¸ºé‚®ä»¶åœ°å€ï¼Œaddress ä¸ºè”ç³»åœ°å€ï¼Œage ä¸ºç”¨æˆ·å¹´é¾„ï¼Œexpired ä¸ºæ˜¯å¦ç™»å½•åæç¤ºä¿®æ”¹å¯†ç ï¼Œdisabled ä¸ºæ˜¯å¦ç¦ç”¨è´¦å·ï¼Œlocked ä¸ºæ˜¯å¦é”å®šè´¦å·ï¼Œå…¶ä¸­ id ä¸ºä¸»é”®è‡ªå¢ã€‚</em></strong></p><blockquote><p>é…ç½®å®Œæˆååœ¨æ•°æ®è¡¨æ·»åŠ ç”¨æˆ·å¯åŠ¨ Tomcat è¿›è¡Œæµ‹è¯•å³å¯ã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into sys_user values (&apos;1&apos;, &apos;admin&apos;, &apos;e10adc3949ba59abbe56e057f20f883e&apos;, &apos;admin@example.com&apos;, &apos;åŒ—äº¬é¡ºä¹‰&apos;, 20, 0, 0, 0);</span><br></pre></td></tr></table></figure><p><strong><em>éœ€è¦æ³¨æ„çš„æ˜¯æ’å…¥æ•°æ®æ—¶ï¼Œéœ€è¦ç”¨å¯†ç çš„ MD5 å€¼</em></strong></p><h2 id="è‡ªå®šä¹‰ç™»å‡ºè·³è½¬ç•Œé¢"><a href="#è‡ªå®šä¹‰ç™»å‡ºè·³è½¬ç•Œé¢" class="headerlink" title="è‡ªå®šä¹‰ç™»å‡ºè·³è½¬ç•Œé¢"></a>è‡ªå®šä¹‰ç™»å‡ºè·³è½¬ç•Œé¢</h2><p>æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¯¹ç™»å‡ºè¿›è¡Œå®šåˆ¶ï¼Œæ¯”å¦‚ç­‰å‡ºåè·³è½¬åˆ°ç­‰å‡ºç•Œé¢ï¼Œåœ¨<code>CAS 5.3</code>ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œç›´æ¥ä¿®æ”¹å‰ç«¯çš„<code>HTML</code>é¡µé¢æ— æ³•å®Œæˆç™»å‡ºçš„å®šåˆ¶è·³è½¬ï¼Œä¸è¿‡å®˜æ–¹æä¾›äº†æ›´ä¸ºæ–¹ä¾¿çš„è®¾ç½®æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶<code>application.properties</code>æ¥å®ç°ï¼Œåœ¨æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cas.logout.followServiceRedirects=true</span><br><span class="line">cas.logout.redirectParameter=service</span><br><span class="line">cas.logout.redirectUrl=https://default.cas.com</span><br><span class="line">cas.logout.confirmLogout=false</span><br><span class="line">cas.logout.removeDescendantTickets=true</span><br></pre></td></tr></table></figure><p><em>è¯·æ ¹æ®éœ€è¦å°†å…¶ä¸­çš„<code>redirectUrl</code>æ”¹ä¸ºè¦å®šåˆ¶çš„ç™»å‡ºè·³è½¬é“¾æ¥</em></p><h2 id="è‡ªå®šä¹‰é»˜è®¤çš„ç™»å½•è·³è½¬ç•Œé¢"><a href="#è‡ªå®šä¹‰é»˜è®¤çš„ç™»å½•è·³è½¬ç•Œé¢" class="headerlink" title="è‡ªå®šä¹‰é»˜è®¤çš„ç™»å½•è·³è½¬ç•Œé¢"></a>è‡ªå®šä¹‰é»˜è®¤çš„ç™»å½•è·³è½¬ç•Œé¢</h2><p>ç™»å‡ºè·³è½¬å¯ä»¥å®šåˆ¶ï¼Œç™»å½•çš„ä¹Ÿå¯ä»¥ï¼Œæœ‰äº›æ—¶å€™ï¼Œå¯èƒ½éœ€è¦åœ¨ç›´æ¥è®¿é—®çš„<code>CAS</code>çš„æ—¶å€™ï¼Œç™»é™†æˆåŠŸåç›´æ¥è·³è½¬åˆ°æŒ‡å®šçš„ç•Œé¢ï¼Œæ¯”å¦‚ç›´æ¥è®¿é—®<code>http://devops.iamzhl.top:8080/cas</code>ï¼Œéœ€è¦è·³è½¬åˆ°<code>http://devops.iamzhl.top/index.html</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨<code>application.properties</code>ä¸­æ·»åŠ ä»¥ä¸‹å±æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cas.view.defaultRedirectUrl=http://devops.iamzhl.top/index.html</span><br></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰ç™»å½•ç•Œé¢ä¸»é¢˜"><a href="#è‡ªå®šä¹‰ç™»å½•ç•Œé¢ä¸»é¢˜" class="headerlink" title="è‡ªå®šä¹‰ç™»å½•ç•Œé¢ä¸»é¢˜"></a>è‡ªå®šä¹‰ç™»å½•ç•Œé¢ä¸»é¢˜</h2><p>åœ¨<code>cas/WEB-INF/classes/static/themes</code>ä¸­æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ä»¥è¦è®¾ç½®çš„ä¸»é¢˜åå‘½åï¼Œæ¯”å¦‚<code>devops</code>ï¼Œåœ¨æ­¤ç›®å½•ä¸‹å»ºç«‹<code>js</code>ã€<code>css</code>ä»¥åŠ<code>images</code>ç­‰é™æ€èµ„æºæ–‡ä»¶å¤¹ï¼Œå°†å®šåˆ¶çš„é™æ€èµ„æºä¿å­˜å¥½ï¼Œç»“æ„å¦‚ä¸‹</p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fzqqbpvu1cj31p818k4au.jpg" alt></p><p>ç„¶ååœ¨<code>application.properties</code>æ·»åŠ ä»¥ä¸‹å±æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cas.theme.defaultThemeName=devops</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      CAS 5.3.4 å®‰è£…éƒ¨ç½²
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="CAS" scheme="https://blog.cloudops.ml/tags/CAS/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 7 å®‰è£…éƒ¨ç½²é‚®ä»¶æœåŠ¡å™¨</title>
    <link href="https://blog.cloudops.ml/Install-and-deploy-mail-server-on-CentOS-7.html"/>
    <id>https://blog.cloudops.ml/Install-and-deploy-mail-server-on-CentOS-7.html</id>
    <published>2018-10-19T13:31:24.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h1 id="æœ¬æ–‡ç¯å¢ƒ"><a href="#æœ¬æ–‡ç¯å¢ƒ" class="headerlink" title="æœ¬æ–‡ç¯å¢ƒ"></a>æœ¬æ–‡ç¯å¢ƒ</h1><p>CentOS 7.2 1511</p><h1 id="å¼€å§‹å®‰è£…"><a href="#å¼€å§‹å®‰è£…" class="headerlink" title="å¼€å§‹å®‰è£…"></a>å¼€å§‹å®‰è£…</h1><h2 id="å®‰è£…postfix"><a href="#å®‰è£…postfix" class="headerlink" title="å®‰è£…postfix"></a>å®‰è£…postfix</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install postfix</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæœºå™¨å·²ç»å®‰è£…äº†sendmailï¼Œéœ€è¦å°†å…¶å¸è½½ï¼Œä¸‹é¢ä¸¤æ¡å‘½ä»¤å‡å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y remove sendmail</span></span><br><span class="line"><span class="comment"># rpm -e sendmail</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹MTA(é»˜è®¤é‚®ä»¶ä»£ç†)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alternatives --config mta</span></span><br></pre></td></tr></table></figure><p>æ£€æŸ¥æ˜¯å¦é…ç½®æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alternatives --display mta</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/14/519a03d59c7bc4ff363f66a8620736.jpg" alt></p><p>è¿™é‡Œæˆ‘å·²ç»å®‰è£…è¿‡postfixäº†</p><h2 id="å®‰è£…dovecot"><a href="#å®‰è£…dovecot" class="headerlink" title="å®‰è£…dovecot"></a>å®‰è£…dovecot</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install dovecot</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/fd/d041b10136a8aea22008556cba508a.jpg" alt></p><h2 id="é…ç½®postfix"><a href="#é…ç½®postfix" class="headerlink" title="é…ç½®postfix"></a>é…ç½®postfix</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/postfix/main.cf</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä»¥ä¸‹å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">myhostname = mail.zhanghl.cn  # å–æ¶ˆæ³¨é‡Šï¼Œè®¾ç½®hostname</span><br><span class="line">mydomain = zhanghl.cn  # å–æ¶ˆæ³¨é‡Šï¼Œè®¾ç½®åŸŸå</span><br><span class="line">myorigin = $mydomain  # å–æ¶ˆæ³¨é‡Š</span><br><span class="line">inet_interfaces = all  # ä¿®æ”¹ä¸ºall</span><br><span class="line">inet_protocols = ipv4  # ä¿®æ”¹ipv4ï¼Œå¦‚æœæ”¯æŒipv6ï¼Œåˆ™å¯ä»¥ä¸ºall</span><br><span class="line">mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain # ä¿®æ”¹åœ¨æœ€åæ·»åŠ $mydomain</span><br><span class="line">mynetworks = 127.0.0.0/8, 10.0.0.0/24  # å–æ¶ˆæ³¨é‡Šï¼ŒæŒ‡å®šå†…ç½‘å’Œæœ¬åœ°çš„IPåœ°å€èŒƒå›´</span><br><span class="line">home_mailbox = Maildir/  # å–æ¶ˆæ³¨é‡Šï¼Œé‚®ä»¶ä¿å­˜ç›®å½•</span><br><span class="line">smtpd_banner = $myhostname ESMTP $mail_name ($mail_version)  # å–æ¶ˆæ³¨é‡Šï¼Œé‚®ä»¶æœåŠ¡å™¨æ¬¢è¿ä¿¡æ¯</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶æœ€åæ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Setup max mail attachment to 10M</span><br><span class="line">message_size_limit = 10485760</span><br><span class="line"># Setup max capacity of Inbox to 1G</span><br><span class="line">mailbox_size_limit = 1073741824</span><br><span class="line"># SMTP Authentication</span><br><span class="line">smtpd_sasl_type = dovecot</span><br><span class="line">smtpd_sasl_path = private/auth</span><br><span class="line">smtpd_sasl_auth_enable = yes</span><br><span class="line">smtpd_sasl_security_options = noanonymous</span><br><span class="line">smtpd_sasl_local_domain = $myhostname</span><br><span class="line">smtpd_recipient_restrictions = permit_mynetworks,permit_auth_destination,permit_sasl_authenticated,reject</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å¹¶è®¾ç½®è‡ªå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start postfix  //å¯åŠ¨</span></span><br><span class="line"><span class="comment"># systemctl enable postfix  //è‡ªå¯åŠ¨</span></span><br></pre></td></tr></table></figure><h2 id="é…ç½®dovecot"><a href="#é…ç½®dovecot" class="headerlink" title="é…ç½®dovecot"></a>é…ç½®dovecot</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/dovecot/dovecot.conf</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen = *  //å–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/dovecot/conf.d/10-auth.conf</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">disable_plaintext_auth = no  //å–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹</span><br><span class="line">auth_mechanisms = plain login  //ä¿®æ”¹æ·»åŠ login</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/dovecot/conf.d/10-mail.conf</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mail_location = maildir:~/Maildir  //ä¿®æ”¹è®¾ç½®é‚®ä»¶å­˜å‚¨ä½ç½®</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/dovecot/conf.d/10-master.conf</span></span><br></pre></td></tr></table></figure><p>å–æ¶ˆæ³¨é‡Šå¹¶æ·»åŠ userå’Œgroupå±æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">unix_listener /var/spool/postfix/private/auth &#123;</span><br><span class="line">    mode = 0666</span><br><span class="line">    user = postfix</span><br><span class="line">    group = postfix</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å¹¶è®¾ç½®è‡ªå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start dovecot  //å¯åŠ¨</span></span><br><span class="line"><span class="comment"># systemctl enable dovecot  //è‡ªå¯åŠ¨</span></span><br></pre></td></tr></table></figure><h2 id="åŸŸåè§£æ"><a href="#åŸŸåè§£æ" class="headerlink" title="åŸŸåè§£æ"></a>åŸŸåè§£æ</h2><p>æ·»åŠ ä¸€ä¸ªå­åŸŸåmailï¼ŒAè®°å½•è§£æåˆ°æœåŠ¡å™¨IPã€‚</p><p>å†æ·»åŠ ä¸€ä¸ªMXè®°å½•ï¼Œä¸»æœºè®°å½•ä¸ºç©ºï¼Œè®°å½•å€¼ä¸ºä¸Šé¢è§£æçš„äºŒçº§åŸŸåmail.zhanghl.cnï¼Œä¼˜å…ˆçº§10ã€‚</p><p>æ³¨æ„ï¼šè§£æç”Ÿæ•ˆå¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ã€‚</p><p>ä¹Ÿå¯ä»¥ä¿®æ”¹/etc/hostsæ·»åŠ é‚®ä»¶æœåŠ¡å™¨åŸŸåå®ç°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/hosts</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/e2/0e95d3345f60b59bffdf377e55fc3b.jpg" alt></p><h2 id="æµ‹è¯•é‚®ç®±"><a href="#æµ‹è¯•é‚®ç®±" class="headerlink" title="æµ‹è¯•é‚®ç®±"></a>æµ‹è¯•é‚®ç®±</h2><p>é¦–å…ˆå®‰è£…telnetï¼Œç”±äºCentOS 7å·²ç»é»˜è®¤æ²¡æœ‰äº†xinetdå’Œtelnetï¼Œå› æ­¤éœ€è¦å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install xinetd telnet telnet-server</span></span><br></pre></td></tr></table></figure><p>è®¾ç½®xinetdå¯åŠ¨å¹¶è‡ªå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start xinetd</span></span><br><span class="line"><span class="comment"># systemctl enable xinetd</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨telnetæµ‹è¯•é‚®ä»¶æœåŠ¡å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">[zhanghl@centos-7 ~]$ telnet zhanghl.cn 25</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to zhanghl.cn.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">220 mail.zhanghl.cn ESMTP Postfix (2.10.1)</span><br><span class="line">mail from:zhanghl</span><br><span class="line">250 2.1.0 Ok</span><br><span class="line">rcpt to:root</span><br><span class="line">250 2.1.5 Ok</span><br><span class="line">data</span><br><span class="line">354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line">Hello, i<span class="string">'m zhanghl!</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">250 2.0.0 Ok: queued as 731144191B7F</span></span><br><span class="line"><span class="string">quit</span></span><br><span class="line"><span class="string">221 2.0.0 Bye</span></span><br><span class="line"><span class="string">Connection closed by foreign host.</span></span><br><span class="line"><span class="string">[zhanghl@centos-7 ~]$ telnet zhanghl.cn 110</span></span><br><span class="line"><span class="string">Trying 127.0.0.1...</span></span><br><span class="line"><span class="string">Connected to zhanghl.cn.</span></span><br><span class="line"><span class="string">Escape character is '</span>^]<span class="string">'.</span></span><br><span class="line"><span class="string">+OK Dovecot ready.</span></span><br><span class="line"><span class="string">user zhanghl</span></span><br><span class="line"><span class="string">+OK</span></span><br><span class="line"><span class="string">pass 123456</span></span><br><span class="line"><span class="string">+OK Logged in.</span></span><br><span class="line"><span class="string">list</span></span><br><span class="line"><span class="string">+OK 1 messages:</span></span><br><span class="line"><span class="string">1 2381</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">retr 1</span></span><br><span class="line"><span class="string">+OK 2381 octets</span></span><br><span class="line"><span class="string">Return-Path: &lt;&gt;</span></span><br><span class="line"><span class="string">X-Original-To: zhanghl@zhanghl.cn</span></span><br><span class="line"><span class="string">Delivered-To: zhanghl@zhanghl.cn</span></span><br><span class="line"><span class="string">Received: by mail.zhanghl.cn (Postfix)</span></span><br><span class="line"><span class="string">id 61E594191B92; Fri, 19 Oct 2018 22:44:27 +0800 (CST)</span></span><br><span class="line"><span class="string">Date: Fri, 19 Oct 2018 22:44:27 +0800 (CST)</span></span><br><span class="line"><span class="string">From: MAILER-DAEMON@zhanghl.cn (Mail Delivery System)</span></span><br><span class="line"><span class="string">Subject: Undelivered Mail Returned to Sender</span></span><br><span class="line"><span class="string">To: zhanghl@zhanghl.cn</span></span><br><span class="line"><span class="string">Auto-Submitted: auto-replied</span></span><br><span class="line"><span class="string">MIME-Version: 1.0</span></span><br><span class="line"><span class="string">Content-Type: multipart/report; report-type=delivery-status;</span></span><br><span class="line"><span class="string">boundary="731144191B7F.1539960267/mail.zhanghl.cn"</span></span><br><span class="line"><span class="string">Message-Id: &lt;20181019144427.61E594191B92@mail.zhanghl.cn&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a MIME-encapsulated message.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--731144191B7F.1539960267/mail.zhanghl.cn</span></span><br><span class="line"><span class="string">Content-Description: Notification</span></span><br><span class="line"><span class="string">Content-Type: text/plain; charset=us-ascii</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is the mail system at host mail.zhanghl.cn.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">I'</span>m sorry to have to inform you that your message could not</span><br><span class="line">be delivered to one or more recipients. It<span class="string">'s attached below.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For further assistance, please send mail to postmaster.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If you do so, please include this problem report. You can</span></span><br><span class="line"><span class="string">delete your own text from the attached returned message.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                   The mail system</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;root@zhanghl.cn&gt; (expanded from &lt;root&gt;): maildir delivery failed: create</span></span><br><span class="line"><span class="string">    maildir file /root/Maildir/tmp/1539960267.P14995.centos-7.shared:</span></span><br><span class="line"><span class="string">    Permission denied</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--731144191B7F.1539960267/mail.zhanghl.cn</span></span><br><span class="line"><span class="string">Content-Description: Delivery report</span></span><br><span class="line"><span class="string">Content-Type: message/delivery-status</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Reporting-MTA: dns; mail.zhanghl.cn</span></span><br><span class="line"><span class="string">X-Postfix-Queue-ID: 731144191B7F</span></span><br><span class="line"><span class="string">X-Postfix-Sender: rfc822; zhanghl@zhanghl.cn</span></span><br><span class="line"><span class="string">Arrival-Date: Fri, 19 Oct 2018 22:43:58 +0800 (CST)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Final-Recipient: rfc822; root@zhanghl.cn</span></span><br><span class="line"><span class="string">Original-Recipient: rfc822;root</span></span><br><span class="line"><span class="string">Action: failed</span></span><br><span class="line"><span class="string">Status: 5.2.0</span></span><br><span class="line"><span class="string">Diagnostic-Code: X-Postfix; maildir delivery failed: create maildir file</span></span><br><span class="line"><span class="string">    /root/Maildir/tmp/1539960267.P14995.centos-7.shared: Permission denied</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--731144191B7F.1539960267/mail.zhanghl.cn</span></span><br><span class="line"><span class="string">Content-Description: Undelivered Message</span></span><br><span class="line"><span class="string">Content-Type: message/rfc822</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Return-Path: &lt;zhanghl@zhanghl.cn&gt;</span></span><br><span class="line"><span class="string">Received: from mail.zhanghl.cn (mail.zhanghl.cn [127.0.0.1])</span></span><br><span class="line"><span class="string">by mail.zhanghl.cn (Postfix) with SMTP id 731144191B7F</span></span><br><span class="line"><span class="string">for &lt;root&gt;; Fri, 19 Oct 2018 22:43:58 +0800 (CST)</span></span><br><span class="line"><span class="string">Message-Id: &lt;20181019144410.731144191B7F@mail.zhanghl.cn&gt;</span></span><br><span class="line"><span class="string">Date: Fri, 19 Oct 2018 22:43:58 +0800 (CST)</span></span><br><span class="line"><span class="string">From: zhanghl@zhanghl.cn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Hello, i'</span>m zhanghl!</span><br><span class="line"></span><br><span class="line">--731144191B7F.1539960267/mail.zhanghl.cn--</span><br><span class="line">.</span><br><span class="line">quit</span><br><span class="line">+OK Logging out.</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line">[zhanghl@centos-7 ~]$</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨é‚®ç®±"><a href="#ä½¿ç”¨é‚®ç®±" class="headerlink" title="ä½¿ç”¨é‚®ç®±"></a>ä½¿ç”¨é‚®ç®±</h2><p>ä¸€åˆ‡éƒ½å¼„å¥½ä»¥åï¼Œå°±å¯ä»¥ä½¿ç”¨Foxmailç­‰ç¬¬ä¸‰æ–¹è½¯ä»¶æ¥æ”¶å‘é‚®ä»¶äº†ã€‚åœ¨è¿™é‡Œéœ€è¦è¯´ä¸€ä¸‹ï¼Œç³»ç»Ÿç”¨æˆ·å°±æ˜¯é‚®ä»¶çš„ç”¨æˆ·ï¼Œä¾‹å¦‚rootï¼Œå°±æ˜¯ä¸€ä¸ªé‚®ç®±ç”¨æˆ·ï¼Œé‚®ç®±æ˜¯<span class="exturl" data-url="bWFpbHRvOnJvb3RAemhhbmdobC5jbg==" title="mailto:root@zhanghl.cn">root@zhanghl.cn<i class="fa fa-external-link"></i></span>ï¼Œå¯†ç å°±æ˜¯rootçš„å¯†ç ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºç”¨æˆ·ï¼Œåªè¦ä½¿ç”¨useraddåˆ›å»ºç”¨æˆ·ï¼Œå†ä½¿ç”¨passwdè®¾ç½®å¯†ç ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      CentOS 7å®‰è£…éƒ¨ç½²é‚®ä»¶æœåŠ¡å™¨
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/"/>
    
      <category term="Linux" scheme="https://blog.cloudops.ml/categories/%E8%BF%90%E7%BB%B4/Linux/"/>
    
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/tags/%E8%BF%90%E7%BB%B4/"/>
    
      <category term="Linux" scheme="https://blog.cloudops.ml/tags/Linux/"/>
    
      <category term="SMTP" scheme="https://blog.cloudops.ml/tags/SMTP/"/>
    
      <category term="Mail Server" scheme="https://blog.cloudops.ml/tags/Mail-Server/"/>
    
  </entry>
  
  <entry>
    <title>TestLinkå®‰è£…éƒ¨ç½²</title>
    <link href="https://blog.cloudops.ml/TestLink-install-and-deploy.html"/>
    <id>https://blog.cloudops.ml/TestLink-install-and-deploy.html</id>
    <published>2018-08-26T11:51:29.000Z</published>
    <updated>2019-03-11T16:21:49.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><!-- build time:Sun Aug 11 2019 22:11:52 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) --><h1 id="TestLinkå®‰è£…éƒ¨ç½²"><a href="#TestLinkå®‰è£…éƒ¨ç½²" class="headerlink" title="TestLinkå®‰è£…éƒ¨ç½²"></a><center>TestLinkå®‰è£…éƒ¨ç½²</center></h1><h2 id="å®‰è£…MySQL"><a href="#å®‰è£…MySQL" class="headerlink" title="å®‰è£…MySQL"></a>å®‰è£…MySQL</h2><p>MySQLçš„Serveråœ¨CentOS 7ä¸Šä»é»˜è®¤è½¯ä»¶åˆ—è¡¨ä¸­è¢«ç§»é™¤äº†ï¼Œç”¨MariaDBæ¥ä»£æ›¿ï¼Œæ‰€ä»¥è¿™å¯¼è‡´æˆ‘ä»¬å¿…é¡»è¦å»å®˜ç½‘ä¸Šè¿›è¡Œä¸‹è½½ï¼Œæ‰¾åˆ°é“¾æ¥ï¼Œç”¨wgetæ‰“å¼€ï¼Œç„¶åå†å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget http://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span></span><br><span class="line"><span class="comment"># rpm -ivh mysql57-community-release-el7-9.noarch.rpm</span></span><br><span class="line"><span class="comment"># yum -y install mysql mysql-server mysql-devel</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨MySQLæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysqld</span></span><br></pre></td></tr></table></figure><p>è·å–å®‰è£…MySQLæ—¶çš„åˆå§‹å¯†ç å¹¶ç™»å½•MySQL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># grep 'temporary password' /var/log/mysqld.log</span></span><br><span class="line"><span class="comment"># mysql -u root -p</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/4a/a001ae2bae5a494c7329cd78a477a3.jpg" alt></p><p>ç™»å½•æˆåŠŸåä¿®æ”¹å¯†ç ï¼Œé¦–å…ˆä¿®æ”¹å®‰å…¨ç­–ç•¥ä¸º0ï¼Œç„¶åå°†å¯†ç é•¿åº¦é™åˆ¶ä¿®æ”¹ä¸º1ï¼Œæœ€åä¿®æ”¹å¯†ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global validate_password_policy=0;</span><br><span class="line">mysql&gt; set global validate_password_length=1;</span><br><span class="line">mysql&gt; set password for root@localhost=password(&apos;root&apos;);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/a2/0f74ed53f3a426d1fe005228478d8f.jpg" alt></p><p>åˆ›å»ºtestlinkç”¨æˆ·å¹¶åˆ›å»ºtestlinkè¦ç”¨çš„æ•°æ®åº“å¹¶æŠŠtestlinkæ•°æ®åº“çš„æ‰€æœ‰æƒé™èµ‹ç»™testlinkç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE USER &apos;testlink&apos;@&apos;%&apos; IDENTIFIED BY &apos;root&apos;;</span><br><span class="line">mysql&gt; CREATE DATABASE testlink; </span><br><span class="line">mysql&gt; GRANT ALL ON testlink.* TO &apos;testlink&apos;@&apos;%&apos;; </span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><p>è®¾ç½®MySQLå¯åŠ¨ä¸è‡ªå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl enable mysqld    //è‡ªå¯åŠ¨</span></span><br><span class="line"><span class="comment"># systemctl start mysqld     //å¯åŠ¨</span></span><br></pre></td></tr></table></figure><h2 id="å®‰è£…httpd"><a href="#å®‰è£…httpd" class="headerlink" title="å®‰è£…httpd"></a>å®‰è£…httpd</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install httpd</span></span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨è‡ªå¯åŠ¨"><a href="#å¯åŠ¨è‡ªå¯åŠ¨" class="headerlink" title="å¯åŠ¨è‡ªå¯åŠ¨"></a>å¯åŠ¨è‡ªå¯åŠ¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl enable httpd  //è‡ªå¯åŠ¨</span></span><br><span class="line"><span class="comment"># systemctl start httpd   //å¯åŠ¨</span></span><br></pre></td></tr></table></figure><h2 id="å®‰è£…PHP"><a href="#å®‰è£…PHP" class="headerlink" title="å®‰è£…PHP"></a>å®‰è£…PHP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span></span><br><span class="line"><span class="comment"># rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span></span><br><span class="line"><span class="comment"># yum -y install `yum search php | grep php56w | grep -v "===" | grep -v mysqlnd | awk -F '.' '&#123;print $1&#125;'`</span></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ä¸€ä¸‹PHPç¯å¢ƒ"><a href="#æµ‹è¯•ä¸€ä¸‹PHPç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ä¸€ä¸‹PHPç¯å¢ƒ"></a>æµ‹è¯•ä¸€ä¸‹PHPç¯å¢ƒ</h3><p>å†™ä¸€ä¸ªphpinfoæµ‹è¯•phpç¯å¢ƒæ˜¯å¦æ­£å¸¸</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /var/www/html/info.php</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æµè§ˆå™¨æ‰“å¼€<code>http://IP:httpdç«¯å£/info.php</code></p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/bf/a51c4fe3482af30d3b54a102c5a844.jpg" alt></p><p>å¦‚å›¾ï¼ŒPHPç¯å¢ƒå®‰è£…å®Œæˆã€‚</p><p>*<em>Note: *</em><br>PHPæ— æ³•æ­£ç¡®è§£æï¼Œç½‘é¡µæ˜¾ç¤ºæºç çš„è§£å†³æ–¹æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/php.ini</span><br></pre></td></tr></table></figure><p>å°†short_open_tag = Offä¿®æ”¹ä¸ºshort_open_tag = Onï¼Œç„¶åé‡å¯httpdæœåŠ¡å³å¯</p><h2 id="å®‰è£…TestLink"><a href="#å®‰è£…TestLink" class="headerlink" title="å®‰è£…TestLink"></a>å®‰è£…TestLink</h2><h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget https://jaist.dl.sourceforge.net/project/testlink/TestLink%201.9/TestLink%201.9.18/testlink-1.9.18.tar.gz</span></span><br></pre></td></tr></table></figure><h3 id="è§£å‹é‡å‘½å"><a href="#è§£å‹é‡å‘½å" class="headerlink" title="è§£å‹é‡å‘½å"></a>è§£å‹é‡å‘½å</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar zxvf testlink-1.9.18.tar.gz</span></span><br><span class="line"><span class="comment"># mv testlink-1.9.18 testlink</span></span><br><span class="line"><span class="comment"># mv testlink /var/www/html/</span></span><br><span class="line"><span class="comment"># chown -R apache:apache /var/www/html/testlink</span></span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sed -i -e "s/AllowOverride None/AllowOverride All/g" /etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="comment"># sed -i -e "s/DirectoryIndex index.html/DirectoryIndex index.html index.php index.shtm/g" /etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="comment"># sed -i -e "s/session.gc_maxlifetime = 1440/session.gc_maxlifetime = 2400/g" /etc/php.ini</span></span><br><span class="line"><span class="comment"># sed -i -e "s/max_execution_time = 30/max_execution_time = 120/g" /etc/php.ini</span></span><br><span class="line"><span class="comment"># service httpd restart</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/49/3c7f4c9291a6c276e5dad2200d5571.jpg" alt></p><h3 id="æ–°å»ºä¸€äº›PHPç¯å¢ƒè¦æ±‚å¿…å¤‡çš„æ–‡ä»¶å¤¹å¹¶èµ‹äºˆé€‚å½“æƒé™"><a href="#æ–°å»ºä¸€äº›PHPç¯å¢ƒè¦æ±‚å¿…å¤‡çš„æ–‡ä»¶å¤¹å¹¶èµ‹äºˆé€‚å½“æƒé™" class="headerlink" title="æ–°å»ºä¸€äº›PHPç¯å¢ƒè¦æ±‚å¿…å¤‡çš„æ–‡ä»¶å¤¹å¹¶èµ‹äºˆé€‚å½“æƒé™"></a>æ–°å»ºä¸€äº›PHPç¯å¢ƒè¦æ±‚å¿…å¤‡çš„æ–‡ä»¶å¤¹å¹¶èµ‹äºˆé€‚å½“æƒé™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/www/html/testlink/gui/templates_c</span></span><br><span class="line"><span class="comment"># mkdir -p /var/testlink/logs/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/testlink/upload_area/</span></span><br><span class="line"><span class="comment"># chmod 777 /var/www/html/testlink/gui/templates_c</span></span><br><span class="line"><span class="comment"># chmod 777 /var/testlink/logs/</span></span><br><span class="line"><span class="comment"># chmod 777 /var/testlink/upload_area/</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/23/c132221e0b416226f6f7df1e63b12c.jpg" alt></p><h3 id="å®‰è£…-1"><a href="#å®‰è£…-1" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>æµè§ˆå™¨æ‰“å¼€<code>http://IP:port/testlink/install</code>(å°†IPæ¢æˆè‡ªå·±ä¸»æœºIPï¼Œç«¯å£å·æ¢ä¸ºè‡ªå·±ä¸»æœºçš„ApacheæœåŠ¡ç«¯å£å·)ã€‚å¦‚å›¾ï¼Œç‚¹å‡»New installationå¼€å§‹å®‰è£…</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/14/da839143e11bec790a2a77f7247529.jpg" alt></p><p>é€‰ä¸­åŒæ„åè®®ï¼Œcontinue</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/7c/b33fa4f939e6447fa43f36b5577b43.jpg" alt></p><p>è¿›å…¥ç³»ç»Ÿç¯å¢ƒæ£€æµ‹é˜¶æ®µï¼Œè¿™ä¸€æ­¥éœ€è¦æ ¹æ®é”™è¯¯æç¤ºè¿›è¡Œé…ç½®ï¼Œå‰é¢å·²ç»åœ¨å®‰è£…phpå’Œtestlinkæ—¶è§£å†³äº†ï¼Œæ‰€ä»¥ç°åœ¨å·²ç»æ²¡æœ‰é”™è¯¯äº†ï¼Œå›¾ä¸­æ©™è‰²çš„æç¤ºå¯ä»¥å¿½ç•¥ï¼Œç‚¹å‡»continue</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/8c/84dad1406d9a22e95913b060326730.jpg" alt></p><p>å¦‚å›¾ï¼Œè®¾å®šæ•°æ®åº“ç®¡ç†å‘˜ç™»å½•è´¦æˆ·å¯†ç ï¼Œè‡ªå®šä¹‰TestLinkçš„æ•°æ®åº“ç™»å½•è´¦æˆ·å¯†ç ï¼Œå…¶ä½™å‡ä¿æŒé»˜è®¤ï¼Œç‚¹å‡»Process TestLink Setup</p><p><img src="https://raw.githubusercontent.com/athlonreg/BlogImages/master/Images/58/736d782618beafcda69918ffca7749.jpg" alt></p><p><strong>è¿™é‡Œæœ‰ä¸€ç‚¹æç¤ºï¼Œå¦‚ä¸Šå›¾ä¸­é»‘ä½“æ‰€è¯´ ï¼Œéœ€è¦æ‰‹åŠ¨å¯¼å…¥<code>udf0</code>ç»“å°¾çš„<code>sql</code>æ–‡ä»¶ï¼Œåªéœ€åœ¨<code>mysql</code>å‘½ä»¤è¡Œä¸­æ‰§è¡Œ<code>source /var/www/html/testlink/install/sql/mysql/testlink_create_udf0.sql</code>å³å¯ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹å…¶ä¸­çš„<code>use</code>å­—æ®µï¼Œå¦‚ä¸‹å›¾ï¼Œä¿®æ”¹ä¸º<code>mysql</code>æ–°å»ºçš„<code>testlink</code>æ•°æ®åº“å</strong></p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fytosr0ucnj31p818kk2a.jpg" alt></p><p><em>å¦‚æœå®‰è£…åˆ°æœ€åå‡ºç°äº†æ‰“å°æ•°æ®åº“è°ƒè¯•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥<code>php</code>çš„<code>mysql</code>æ¨¡å—ï¼Œå‘½ä»¤æ˜¯<code>php -m | grep mysql</code>ï¼Œå¦‚ä¸‹å›¾åˆ™æ˜¯æ­£å¸¸çš„</em></p><p><img src="https://ws1.sinaimg.cn/large/006dLY5Ily1fytouqtrwgj31p818k7a4.jpg" alt></p><p><em>å¦‚æœæç¤ºåŠ¨æ€åº“æ— æ³•åŠ è½½ä¹‹ç±»çš„é”™è¯¯ï¼Œåªéœ€é‡æ–°å®‰è£…<code>php-mysql</code>ï¼Œç„¶åé‡å¯<code>php-fpm</code>å’Œ<code>httpd</code>å³å¯</em></p><h2 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h2><p>å®‰è£…å®Œæˆç½‘å€è¾“å…¥<span class="exturl" data-url="aHR0cDovL0lQL3Rlc3RsaW5r5Y2z5Y+v6Ieq5Yqo6Lez6L2s5Yiw55m75b2V6aG16Z2i77yM6buY6K6k55So5oi3YWRtaW4vYWRtaW4=" title="http://IP/testlinkå³å¯è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·admin/admin">http://IP/testlinkå³å¯è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œé»˜è®¤ç”¨æˆ·admin/admin<i class="fa fa-external-link"></i></span></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      TestLinkå®‰è£…éƒ¨ç½²
    
    </summary>
    
      <category term="Linux" scheme="https://blog.cloudops.ml/categories/Linux/"/>
    
      <category term="è¿ç»´" scheme="https://blog.cloudops.ml/categories/Linux/%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="TestLink" scheme="https://blog.cloudops.ml/tags/TestLink/"/>
    
  </entry>
  
</feed>
