<!DOCTYPE HTML><html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="keywords" content="MantisBT 整合 LDAP 和 CAS 单点登录, 套陆的博客,套陆的部落阁"><meta name="description" content="套陆的博客"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="baidu_union_verify" content="4e839f89679ffccd45aadacf60546450"><meta name="baidu_ssp_verify" content="c2eae9af68a736e9d71e5d09738fa5ed"><meta name="google-site-verification" content="FKEuCAl5HQr18Iidr3E-u_qde1lEI2R09x5x4IxVITw"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-165042084-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-165042084-1")</script><title>MantisBT 整合 LDAP 和 CAS 单点登录 | 套陆的部落阁</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/awesome/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/materialize/materialize.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/aos/aos.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/animate/animate.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/css/matery.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/css/my.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/live2d/autoload.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/jquery/jquery.min.js"></script><script data-ad-client="ca-pub-7406269002228687" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="套陆的部落阁" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css"><link rel="stylesheet" href="/css/prism-line-numbers.css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/favicon.ico" class="logo-img" alt="LOGO"> <span class="logo-span">套陆的部落阁</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/favicon.ico" class="logo-img circle responsive-img"><div class="logo-name">套陆的部落阁</div><div class="logo-desc">套陆的博客</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/athlonreg" rel="external nofollow noreferrer" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/athlonreg" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/cryptojs/crypto-js.min.js"></script><script>(function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();</script><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/b1/c3e84af9570ae5c9d61d788d482a69.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">MantisBT 整合 LDAP 和 CAS 单点登录</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/CAS/"><span class="chip bg-color">CAS</span></a> <a href="/tags/LDAP/"><span class="chip bg-color">LDAP</span></a> <a href="/tags/MantisBT/"><span class="chip bg-color">MantisBT</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/CI/" class="post-category">CI</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2018-12-03</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i> 更新日期:&nbsp;&nbsp; 2020-04-30</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 2.1k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 11 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i> 阅读次数:&nbsp;&nbsp;<span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><ul><li>MantisBT 版本：2.18</li><li>Mantis URL：<a href="http://devops.iamzhl.top/mantis" target="_blank" rel="noopener external nofollow noreferrer">http://devops.iamzhl.top/mantis</a></li><li>openLDAP 服务：ldap://devops.iamzhl.top:389</li><li>CAS 服务：<a href="http://devops.iamzhl.top:8080/cas" target="_blank" rel="noopener external nofollow noreferrer">http://devops.iamzhl.top:8080/cas</a></li></ul><h2 id="整合-LDAP"><a href="#整合-LDAP" class="headerlink" title="整合 LDAP"></a>整合 LDAP</h2><h3 id="修改MantisBT配置文件"><a href="#修改MantisBT配置文件" class="headerlink" title="修改MantisBT配置文件"></a>修改<code>MantisBT</code>配置文件</h3><blockquote><p>添加以下配置项</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token shell-comment comment"># MantisBT Authentication and LDAP Settings #</span>
<span class="token variable">$g_login_method</span> <span class="token operator">=</span> <span class="token constant">LDAP</span><span class="token punctuation">;</span>
<span class="token variable">$g_reauthentication</span> <span class="token operator">=</span> <span class="token constant">ON</span><span class="token punctuation">;</span>
<span class="token variable">$g_reauthentication_expiry</span> <span class="token operator">=</span> <span class="token constant">TOKEN_EXPIRY_AUTHENTICATED</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_server</span> <span class="token operator">=</span> 'ldap<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//devops.iamzhl.top:389';</span>
<span class="token variable">$g_ldap_root_dn</span> <span class="token operator">=</span> <span class="token string">'ou=People,dc=iamzhl,dc=top'</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_protocol_version</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_organization</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_bind_dn</span> <span class="token operator">=</span> <span class="token string">'cn=Manager,dc=iamzhl,dc=top'</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_bind_passwd</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_uid_field</span> <span class="token operator">=</span> <span class="token string">'uid'</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_realname_field</span> <span class="token operator">=</span> <span class="token string">'cn'</span><span class="token punctuation">;</span>
<span class="token variable">$g_use_ldap_realname</span> <span class="token operator">=</span> <span class="token constant">ON</span><span class="token punctuation">;</span>
<span class="token variable">$g_use_ldap_email</span> <span class="token operator">=</span> <span class="token constant">ON</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打开<code>MantisBT</code>网址，输入用户名密码点击登录</p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/dd/a754582a7218fd2860d31fb543c667.jpg" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/07/158dfd797dce0fa01335dd8d9b5085.jpg" alt=""></p><p>登陆成功后，正常获取用户名</p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/5d/e2fd0f937861208615ce61fae90423.jpg" alt=""></p><p>点击右上角的用户名 -&gt; 注销，会正常退出并跳转到登录界面</p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/5e/e198803ba7693b67b5e6c5fc075ab5.jpg" alt=""></p><p>至此，<code>MantisBT</code>整合<code>LDAP</code>完成。</p><h2 id="整合-CAS-单点登录"><a href="#整合-CAS-单点登录" class="headerlink" title="整合 CAS 单点登录"></a>整合 CAS 单点登录</h2><h3 id="下载phpCAS放到MantisBT下"><a href="#下载phpCAS放到MantisBT下" class="headerlink" title="下载phpCAS放到MantisBT下"></a>下载<code>phpCAS</code>放到<code>MantisBT</code>下</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># wget https://github.com/apereo/phpCAS/archive/1.3.6.tar.gz</span>
<span class="token comment" spellcheck="true"># mv 1.3.6.tar.gz phpCAS-1.3.6.tar.gz</span>
<span class="token comment" spellcheck="true"># tar zxvf phpCAS-1.3.6.tar.gz</span>
<span class="token comment" spellcheck="true"># chown -R apache:apache phpCAS-1.3.6</span>
<span class="token comment" spellcheck="true"># cp -arf phpCAS-1.3.6 /var/www/html/mantis/phpCAS</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改MantisBT配置文件-1"><a href="#修改MantisBT配置文件-1" class="headerlink" title="修改MantisBT配置文件"></a>修改<code>MantisBT</code>配置文件</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/mantis/config/config_inc.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>添加<code>CAS</code>认证需要的变量(请按照自己的<code>LDAP</code>服务器进行修改)</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token shell-comment comment"># MantisBT Authentication With CAS Settings #</span>
<span class="token variable">$g_login_method</span> <span class="token operator">=</span> <span class="token constant">CAS</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_server</span> <span class="token operator">=</span> <span class="token string">'devops.iamzhl.top'</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_port</span> <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_uri</span> <span class="token operator">=</span> <span class="token string">'/cas'</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_validate</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_version</span> <span class="token operator">=</span> <span class="token string">'2.0'</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_debug</span> <span class="token operator">=</span> <span class="token string">'/var/www/html/mantis/cas.log'</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_saml_attributes</span> <span class="token operator">=</span> <span class="token constant">OFF</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_saml_map</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string">'name'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'mail'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_use_ldap</span> <span class="token operator">=</span> <span class="token constant">ON</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_mantis_uid</span>  <span class="token operator">=</span> <span class="token string">'uid'</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_ldap_update</span>  <span class="token operator">=</span> <span class="token constant">OFF</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_ldap_update_fields</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$g_cas_ldap_update_map</span>    <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_language_field</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$g_ldap_language_keys</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改登录页面"><a href="#修改登录页面" class="headerlink" title="修改登录页面"></a>修改登录页面</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/mantis/login_page.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 在文件开头的 require_once 部分增加对 phpCAS 的引入</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span> <span class="token string">'/var/www/html/mantis/phpCAS/login_cas.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 在 $f_username 变量的定义之前添加判断语句，当检测到用户已经认证时，跳转到主页</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">auth_is_user_authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">current_user_is_anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print_header_redirect</span><span class="token punctuation">(</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'default_home_page'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/mantis/login.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 在判断变量 f_install 的判断语句之后添加下面的判断语句来判断验证方式，若为 CAS ，则利用 auth_cas_get_name 函数来处理</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token constant">CAS</span> <span class="token operator">==</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token shell-comment comment"># This will detour to the CAS login page if needed</span>
    <span class="token variable">$f_password</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$f_username</span> <span class="token operator">=</span> <span class="token function">auth_cas_get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token shell-comment comment"># User is always authenticated by this point</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/mantis/login_password_page.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 在 $f_username 变量的定义之前添加判断语句，当检测到用户已经认证时，跳转到主页</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">auth_is_user_authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">current_user_is_anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print_header_redirect</span><span class="token punctuation">(</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'default_home_page'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$f_username</span>              <span class="token operator">=</span> <span class="token function">gpc_get_string</span><span class="token punctuation">(</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token shell-comment comment"># zhanghl start</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$f_username</span> <span class="token operator">==</span> <span class="token string">''</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$f_username</span> <span class="token operator">=</span> <span class="token variable">$staffid</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token shell-comment comment"># zhanghl end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改登出页面"><a href="#修改登出页面" class="headerlink" title="修改登出页面"></a>修改登出页面</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/mantis/logout_page.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 在文件开头的 require_once 部分增加对 phpCAS 的引入</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span> <span class="token string">'/var/www/html/mantis/phpCAS/login_cas.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token shell-comment comment"># Cache the current logout redirect page as it will be cleared by auth_logout()</span>
<span class="token comment" spellcheck="true">//$t_logout_redirect = auth_logout_redirect_page();</span>

<span class="token comment" spellcheck="true">//auth_logout();</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">handleLogoutRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//print_header_redirect( $t_logout_redirect, true, false );</span>
<span class="token function">print_header_redirect</span><span class="token punctuation">(</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'logout_redirect_page'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改验证逻辑"><a href="#修改验证逻辑" class="headerlink" title="修改验证逻辑"></a>修改验证逻辑</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/mantis/core/authentication_api.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 在变量 g_cache_current_user_id 的定义后面添加以下函数，定义 CAS 的登录逻辑</span>
<span class="token comment" spellcheck="true">/**
* Initialize phpCAS.
*/</span>
<span class="token keyword">function</span> <span class="token function">auth_cas_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token shell-comment comment"># phpCAS must be installed in the include path</span>
       <span class="token shell-comment comment"># or in the Mantis directory.</span>
       <span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string">'/var/www/html/mantis/phpCAS/CAS.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">static</span> <span class="token variable">$s_initialized</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$s_initialized</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
               phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setDebug</span><span class="token punctuation">(</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_debug'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token shell-comment comment">## These should be set in config_inc.php</span>
               <span class="token variable">$t_server_version</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_version'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token variable">$t_server_cas_server</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_server'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token variable">$t_server_port</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_port'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token variable">$t_server_uri</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_uri'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token variable">$t_start_session</span> <span class="token operator">=</span> <span class="token punctuation">(</span>boolean<span class="token punctuation">)</span><span class="token constant">FALSE</span><span class="token punctuation">;</span> <span class="token shell-comment comment"># Mantis takes care of its own session</span>

               phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token variable">$t_server_version</span><span class="token punctuation">,</span> <span class="token variable">$t_server_cas_server</span><span class="token punctuation">,</span> <span class="token variable">$t_server_port</span><span class="token punctuation">,</span> <span class="token variable">$t_server_uri</span><span class="token punctuation">,</span> <span class="token variable">$t_start_session</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$t_server_version</span> <span class="token operator">==</span> <span class="token string">"S1"</span><span class="token punctuation">)</span>
                       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setServerSamlValidateURL</span><span class="token punctuation">(</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_validate'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">else</span>
                       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setServerProxyValidateURL</span><span class="token punctuation">(</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_validate'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token string">'phpCAS'</span><span class="token punctuation">,</span> <span class="token string">'setNoCasServerValidation'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token comment" spellcheck="true">// no SSL validation for the CAS server</span>
                       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setNoCasServerValidation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>

               <span class="token variable">$s_initialized</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/**
* Fetches the user's CAS name, authenticating if needed.
* Can translate CAS login name to Mantis username through LDAP.
*/</span>
<span class="token keyword">function</span> <span class="token function">auth_cas_get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
       <span class="token shell-comment comment"># Get CAS username from phpCAS</span>
       <span class="token function">auth_cas_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forceAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_cas_id</span> <span class="token operator">=</span> phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_cas_attribs</span> <span class="token operator">=</span> phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token shell-comment comment"># If needed, translate the CAS username through LDAP</span>
       <span class="token variable">$t_username</span> <span class="token operator">=</span> <span class="token variable">$t_cas_id</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_use_ldap'</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token variable">$t_username</span> <span class="token operator">=</span> <span class="token function">auth_cas_ldap_translate</span><span class="token punctuation">(</span> <span class="token variable">$t_cas_id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_saml_attributes'</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token variable">$t_cas_attribmap</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_saml_map'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token variable">$t_cas_attrib_name</span> <span class="token operator">=</span> <span class="token variable">$t_cas_attribs</span><span class="token punctuation">[</span><span class="token variable">$t_cas_attribmap</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
               <span class="token variable">$t_cas_attrib_mail</span> <span class="token operator">=</span> <span class="token variable">$t_cas_attribs</span><span class="token punctuation">[</span><span class="token variable">$t_cas_attribmap</span><span class="token punctuation">[</span><span class="token string">'mail'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">user_get_id_by_name</span><span class="token punctuation">(</span><span class="token variable">$t_cas_id</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token function">user_create</span><span class="token punctuation">(</span> <span class="token variable">$t_cas_id</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$t_cas_attrib_mail</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$t_cas_attrib_name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">return</span> <span class="token variable">$t_username</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/**
* Takes an ID string, and looks up the LDAP directory to find
* the matching username for Mantis.
*
* Optionally, also update the user information in the Mantis user
* table.
*
* @param $p_cas_id string Typically, the username given by phpCAS.
* @param $p_update_user bool Whether or not to update user details from LDAP.
*/</span>
<span class="token keyword">function</span> <span class="token function">auth_cas_ldap_translate</span><span class="token punctuation">(</span> <span class="token variable">$p_cas_id</span><span class="token punctuation">,</span> <span class="token variable">$p_update_user</span><span class="token operator">=</span><span class="token string">''</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>

       <span class="token shell-comment comment"># Please make sure the Mantis CAS and LDAP settings are set in config_inc.php</span>

       <span class="token variable">$t_ldap_organization</span>    <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'ldap_organization'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_ldap_root_dn</span>         <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'ldap_root_dn'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token shell-comment comment"># Required fields in LDAP for CAS</span>
       <span class="token variable">$t_ldap_language_field</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'ldap_language_field'</span><span class="token punctuation">,</span> <span class="token string">''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_ldap_uid_field</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'ldap_uid_field'</span><span class="token punctuation">,</span> <span class="token string">'uid'</span> <span class="token punctuation">)</span> <span class="token punctuation">;</span>
       <span class="token variable">$t_ldap_mantis_uid</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'ldap_mantis_uid'</span><span class="token punctuation">,</span> <span class="token string">'uid'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_ldap_required</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token variable">$t_ldap_uid_field</span><span class="token punctuation">,</span> <span class="token variable">$t_ldap_mantis_uid</span><span class="token punctuation">,</span> <span class="token string">'dn'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$t_ldap_language_field</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment" spellcheck="true">// Add language field to attributes list only if it is configured.</span>
               <span class="token variable">$t_ldap_required</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$t_ldap_language_field</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token variable">$t_ldap_required</span> <span class="token operator">=</span> <span class="token function">array_combine</span><span class="token punctuation">(</span> <span class="token variable">$t_ldap_required</span><span class="token punctuation">,</span> <span class="token variable">$t_ldap_required</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token shell-comment comment"># User-defined fields to fetch from LDAP...</span>
       <span class="token variable">$t_ldap_fields</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span> <span class="token string">','</span><span class="token punctuation">,</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_ldap_update_fields'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_ldap_fields</span> <span class="token operator">=</span> <span class="token function">array_combine</span><span class="token punctuation">(</span> <span class="token variable">$t_ldap_fields</span><span class="token punctuation">,</span> <span class="token variable">$t_ldap_fields</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token shell-comment comment"># ...which are mapped to Mantis user fields</span>
       <span class="token variable">$t_ldap_map</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span> <span class="token string">','</span><span class="token punctuation">,</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_ldap_update_map'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_ldap_map</span> <span class="token operator">=</span> <span class="token function">array_combine</span><span class="token punctuation">(</span> <span class="token variable">$t_ldap_map</span><span class="token punctuation">,</span> <span class="token variable">$t_ldap_map</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token shell-comment comment"># Build LDAP search filter, attribute list from CAS ID</span>
       <span class="token variable">$t_search_filter</span> <span class="token operator">=</span> <span class="token string">"(&amp;$t_ldap_organization($t_ldap_uid_field=$p_cas_id))"</span><span class="token punctuation">;</span>
       <span class="token variable">$t_search_attrs</span> <span class="token operator">=</span> <span class="token function">array_values</span><span class="token punctuation">(</span><span class="token variable">$t_ldap_required</span> <span class="token operator">+</span> <span class="token variable">$t_ldap_fields</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token shell-comment comment"># array union</span>

       <span class="token shell-comment comment"># Use Mantis ldap_api to connect to LDAP</span>
       <span class="token variable">$t_ds</span> <span class="token operator">=</span> <span class="token function">ldap_connect_bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_sr</span>   <span class="token operator">=</span> <span class="token function">ldap_search</span><span class="token punctuation">(</span> <span class="token variable">$t_ds</span><span class="token punctuation">,</span> <span class="token variable">$t_ldap_root_dn</span><span class="token punctuation">,</span> <span class="token variable">$t_search_filter</span><span class="token punctuation">,</span> <span class="token variable">$t_search_attrs</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$t_info</span> <span class="token operator">=</span> <span class="token function">ldap_get_entries</span><span class="token punctuation">(</span> <span class="token variable">$t_ds</span><span class="token punctuation">,</span> <span class="token variable">$t_sr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token shell-comment comment"># Parse the LDAP entry to find the Mantis username</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$t_info</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token shell-comment comment"># Get Mantis username</span>
               <span class="token variable">$t_username</span> <span class="token operator">=</span> <span class="token variable">$t_info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$t_ldap_mantis_uid</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

               <span class="token shell-comment comment"># @@@ The fact that we got here means the user is authenticated</span>
               <span class="token shell-comment comment"># @@@ by CAS, and has an LDAP entry.</span>
               <span class="token shell-comment comment"># @@@ We might as well update other user details since we are here.</span>

               <span class="token shell-comment comment"># If no argument given, check settings</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token string">''</span> <span class="token operator">==</span> <span class="token variable">$p_update_user</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token variable">$p_update_user</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'cas_ldap_update'</span><span class="token punctuation">,</span> <span class="token constant">FALSE</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token shell-comment comment"># If there's a user record, then update it</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$p_update_user</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token shell-comment comment"># Only proceed if the field map arrays are the same length</span>
                       <span class="token variable">$t_field_map</span> <span class="token operator">=</span> <span class="token function">array_combine</span><span class="token punctuation">(</span> <span class="token variable">$t_ldap_fields</span><span class="token punctuation">,</span> <span class="token variable">$t_ldap_map</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$t_field_map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                               <span class="token shell-comment comment"># If user is new, then we must create their account before updating it</span>
                               <span class="token shell-comment comment"># @@@ ( make sure $g_allow_blank_email == ON )</span>
                               <span class="token variable">$t_userid</span> <span class="token operator">=</span> <span class="token function">user_get_id_by_name</span><span class="token punctuation">(</span><span class="token variable">$t_username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                               <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token boolean">false</span> <span class="token operator">==</span> <span class="token variable">$t_userid</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                       <span class="token function">user_create</span><span class="token punctuation">(</span> <span class="token variable">$t_username</span><span class="token punctuation">,</span> <span class="token string">''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                                       <span class="token shell-comment comment"># @@@ Wow, this is pretty lame</span>
                                       <span class="token variable">$t_userid</span> <span class="token operator">=</span> <span class="token function">user_get_id_by_name</span><span class="token punctuation">(</span><span class="token variable">$t_username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                               <span class="token punctuation">}</span>
                               <span class="token shell-comment comment"># @@@ maybe we can optimize this to write all fields at once?</span>
                             <span class="token keyword">foreach</span> <span class="token punctuation">(</span> <span class="token variable">$t_field_map</span> <span class="token keyword">as</span> <span class="token variable">$key</span><span class="token operator">=</span><span class="token operator">></span><span class="token variable">$t_userfield</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$t_info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                             <span class="token function">user_set_field</span><span class="token punctuation">(</span> <span class="token variable">$t_userid</span><span class="token punctuation">,</span> <span class="token variable">$t_userfield</span><span class="token punctuation">,</span> <span class="token variable">$t_info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                                     <span class="token punctuation">}</span>
                             <span class="token punctuation">}</span>
                       <span class="token punctuation">}</span>

                       <span class="token comment" spellcheck="true">// Update user's overall language preference</span>
                       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$t_ldap_language_field</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                               <span class="token variable">$t_language</span> <span class="token operator">=</span> <span class="token variable">$t_info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$t_ldap_language_field</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                               <span class="token comment" spellcheck="true">// Map the LDAP language field to Mantis' language field if needed</span>
                               <span class="token variable">$t_language_keys</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'ldap_language_keys'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                               <span class="token variable">$t_language_values</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'ldap_language_values'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                               <span class="token variable">$t_language_map</span> <span class="token operator">=</span> <span class="token function">array_combine</span><span class="token punctuation">(</span>
                                       <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token variable">$t_language_keys</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token variable">$t_language_values</span><span class="token punctuation">)</span>
                               <span class="token punctuation">)</span><span class="token punctuation">;</span>
                               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$t_language_map</span><span class="token punctuation">[</span><span class="token variable">$t_language</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                       <span class="token variable">$t_language</span> <span class="token operator">=</span> <span class="token variable">$t_language_map</span><span class="token punctuation">[</span><span class="token variable">$t_language</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                               <span class="token punctuation">}</span>
                               <span class="token function">user_pref_set_pref</span><span class="token punctuation">(</span><span class="token variable">$t_userid</span><span class="token punctuation">,</span> <span class="token string">'language'</span><span class="token punctuation">,</span> <span class="token variable">$t_language</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token function">ldap_free_result</span><span class="token punctuation">(</span> <span class="token variable">$t_sr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">ldap_unbind</span><span class="token punctuation">(</span> <span class="token variable">$t_ds</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> <span class="token variable">$t_username</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/**
* Logs out of CAS, redirecting to Mantis on re-login.
* User should already be logged out of Mantis by the time this is called.
* @see auth_logout()
*/</span>
<span class="token keyword">function</span> <span class="token function">auth_cas_logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
       <span class="token variable">$t_path</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">auth_cas_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">method_Exists</span><span class="token punctuation">(</span><span class="token string">'phpCAS'</span><span class="token punctuation">,</span> <span class="token string">'logoutWithUrl'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">logoutWithUrl</span><span class="token punctuation">(</span><span class="token variable">$t_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token variable">$t_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// zhanghl end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// 修改 auth_auto_create_user 函数实现 CAS 自动创建用户</span>
<span class="token keyword">function</span> <span class="token function">auth_auto_create_user</span><span class="token punctuation">(</span> <span class="token variable">$p_username</span><span class="token punctuation">,</span> <span class="token variable">$p_password</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$t_login_method</span> <span class="token operator">=</span> <span class="token function">config_get_global</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// if( $t_login_method == BASIC_AUTH ) {</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">in_array</span><span class="token punctuation">(</span> <span class="token variable">$t_login_method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token constant">BASIC_AUTH</span><span class="token punctuation">,</span> <span class="token constant">CAS</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token shell-comment comment"># attempt to create the user if using BASIC_AUTH or CAS</span>
        <span class="token variable">$t_auto_create</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$t_login_method</span> <span class="token operator">==</span> <span class="token constant">LDAP</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ldap_authenticate_by_username</span><span class="token punctuation">(</span> <span class="token variable">$p_username</span><span class="token punctuation">,</span> <span class="token variable">$p_password</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$t_auto_create</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$t_auto_create</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token constant">CAS</span> <span class="token operator">==</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token shell-comment comment"># Redirect to CAS page to logout</span>
        <span class="token function">auth_cas_logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$t_auto_create</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token shell-comment comment"># attempt to create the user</span>
        <span class="token variable">$t_cookie_string</span> <span class="token operator">=</span> <span class="token function">user_create</span><span class="token punctuation">(</span> <span class="token variable">$p_username</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$p_password</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$t_cookie_string</span> <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token shell-comment comment"># it didn't work</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token shell-comment comment"># ok, we created the user, get the row again</span>
        <span class="token keyword">return</span> <span class="token function">user_get_id_by_name</span><span class="token punctuation">(</span> <span class="token variable">$p_username</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">session_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">auth_attempt_login</span><span class="token punctuation">(</span> <span class="token variable">$p_username</span><span class="token punctuation">,</span> <span class="token variable">$p_password</span><span class="token punctuation">,</span> <span class="token variable">$p_perm_login</span> <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$t_user_id</span> <span class="token operator">=</span> <span class="token function">auth_get_user_id_from_login_name</span><span class="token punctuation">(</span> <span class="token variable">$p_username</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$t_login_method</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span> <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">in_array</span><span class="token punctuation">(</span> <span class="token variable">$t_login_method</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token constant">BASIC_AUTH</span><span class="token punctuation">,</span> <span class="token constant">CAS</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token shell-comment comment"># attempt to create the user if using BASIC_AUTH or CAS</span>
            <span class="token shell-comment comment"># ( note: CAS must have $g_allow_blank_email == ON )</span>
             <span class="token variable">$t_auto_create</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$t_user_id</span> <span class="token operator">=</span> <span class="token function">auth_auto_create_user</span><span class="token punctuation">(</span> <span class="token variable">$p_username</span><span class="token punctuation">,</span> <span class="token variable">$p_password</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span> <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token shell-comment comment"># max. failed login attempts achieved...</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">user_is_login_request_allowed</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token shell-comment comment"># check for anonymous login</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">user_is_anonymous</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token shell-comment comment"># anonymous login didn't work, so check the password</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">auth_does_password_match</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span><span class="token punctuation">,</span> <span class="token variable">$p_password</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">user_increment_failed_login_count</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">auth_login_user</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span><span class="token punctuation">,</span> <span class="token variable">$p_perm_login</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">auth_logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">global</span> <span class="token variable">$g_cache_current_user_id</span><span class="token punctuation">,</span> <span class="token variable">$g_cache_cookie_valid</span><span class="token punctuation">;</span>

    <span class="token shell-comment comment"># clear cached userid</span>
    <span class="token function">user_clear_cache</span><span class="token punctuation">(</span> <span class="token variable">$g_cache_current_user_id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">current_user_set</span><span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$g_cache_cookie_valid</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token shell-comment comment"># clear cookies, if they were set</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">auth_clear_cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">helper_clear_pref_cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">HTTP_AUTH</span> <span class="token operator">==</span> <span class="token function">config_get_global</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">auth_http_set_logout_pending</span><span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">elseif</span> <span class="token punctuation">(</span> <span class="token constant">CAS</span> <span class="token operator">==</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token shell-comment comment"># Redirect to CAS page to logout</span>
            <span class="token function">auth_cas_logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">session_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">auth_automatic_logon_bypass_form</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span> <span class="token function">config_get</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">HTTP_AUTH</span><span class="token punctuation">:</span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">CAS</span><span class="token punctuation">:</span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//return config_get_global( 'login_method' ) == HTTP_AUTH;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">auth_does_password_match</span><span class="token punctuation">(</span> <span class="token variable">$p_user_id</span><span class="token punctuation">,</span> <span class="token variable">$p_test_password</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$t_configured_login_method</span> <span class="token operator">=</span> <span class="token function">config_get_global</span><span class="token punctuation">(</span> <span class="token string">'login_method'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">LDAP</span> <span class="token operator">==</span> <span class="token variable">$t_configured_login_method</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ldap_authenticate</span><span class="token punctuation">(</span> <span class="token variable">$p_user_id</span><span class="token punctuation">,</span> <span class="token variable">$p_test_password</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">elseif</span> <span class="token punctuation">(</span> <span class="token constant">CAS</span> <span class="token operator">==</span> <span class="token variable">$t_configured_login_method</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">auth_can_use_standard_login</span><span class="token punctuation">(</span> <span class="token variable">$p_user_id</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$t_password</span> <span class="token operator">=</span> <span class="token function">user_get_field</span><span class="token punctuation">(</span> <span class="token variable">$p_user_id</span><span class="token punctuation">,</span> <span class="token string">'password'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$t_login_methods</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token constant">MD5</span><span class="token punctuation">,</span>
        <span class="token constant">CRYPT</span><span class="token punctuation">,</span>
        <span class="token constant">PLAIN</span><span class="token punctuation">,</span>
        <span class="token constant">BASIC_AUTH</span><span class="token punctuation">,</span>
        <span class="token constant">CAS</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span><span class="token punctuation">(</span> <span class="token variable">$t_login_methods</span> <span class="token keyword">as</span> <span class="token variable">$t_login_method</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token shell-comment comment"># pass the stored password in as the salt</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">auth_process_plain_password</span><span class="token punctuation">(</span> <span class="token variable">$p_test_password</span><span class="token punctuation">,</span> <span class="token variable">$t_password</span><span class="token punctuation">,</span> <span class="token variable">$t_login_method</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token variable">$t_password</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token shell-comment comment"># Do not support migration to PLAIN, since this would be a crazy thing to do.</span>
            <span class="token shell-comment comment"># Also if we do, then a user will be able to login by providing the MD5 value</span>
            <span class="token shell-comment comment"># that is copied from the database.  See #8467 for more details.</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$t_configured_login_method</span> <span class="token operator">!=</span> <span class="token constant">PLAIN</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$t_login_method</span> <span class="token operator">==</span> <span class="token constant">PLAIN</span> <span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span> <span class="token variable">$t_configured_login_method</span> <span class="token operator">!=</span> <span class="token constant">BASIC_AUTH</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$t_login_method</span> <span class="token operator">==</span> <span class="token constant">BASIC_AUTH</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token shell-comment comment"># Check for migration to another login method and test whether the password was encrypted</span>
            <span class="token shell-comment comment"># with our previously insecure implementation of the CRYPT method</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$t_login_method</span> <span class="token operator">!=</span> <span class="token variable">$t_configured_login_method</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token constant">CRYPT</span> <span class="token operator">==</span> <span class="token variable">$t_configured_login_method</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span> <span class="token variable">$t_password</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span> <span class="token variable">$p_test_password</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">user_set_password</span><span class="token punctuation">(</span> <span class="token variable">$p_user_id</span><span class="token punctuation">,</span> <span class="token variable">$p_test_password</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">auth_reauthenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//if( !auth_reauthentication_enabled() || BASIC_AUTH == config_get_global( 'login_method' ) || HTTP_AUTH == config_get_global( 'login_method' ) ) {</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">auth_reauthentication_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token function">config_get</span><span class="token punctuation">(</span><span class="token string">'login_method'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token constant">BASIC_AUTH</span><span class="token punctuation">,</span> <span class="token constant">HTTP_AUTH</span><span class="token punctuation">,</span> <span class="token constant">CAS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$t_auth_token</span> <span class="token operator">=</span> <span class="token function">token_get</span><span class="token punctuation">(</span> <span class="token constant">TOKEN_AUTHENTICATED</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token operator">!=</span> <span class="token variable">$t_auth_token</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">token_touch</span><span class="token punctuation">(</span> <span class="token variable">$t_auth_token</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">auth_reauthentication_expiry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$t_anon_account</span> <span class="token operator">=</span> <span class="token function">auth_anonymous_account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$t_anon_allowed</span> <span class="token operator">=</span> <span class="token function">auth_anonymous_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$t_user_id</span> <span class="token operator">=</span> <span class="token function">auth_get_current_user_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$t_username</span> <span class="token operator">=</span> <span class="token function">user_get_username</span><span class="token punctuation">(</span> <span class="token variable">$t_user_id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token shell-comment comment"># check for anonymous login</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">ON</span> <span class="token operator">==</span> <span class="token variable">$t_anon_allowed</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$t_anon_account</span> <span class="token operator">==</span> <span class="token variable">$t_username</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$t_request_uri</span> <span class="token operator">=</span> <span class="token function">string_url</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_URI'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$t_query_params</span> <span class="token operator">=</span> <span class="token function">http_build_query</span><span class="token punctuation">(</span>
            <span class="token keyword">array</span><span class="token punctuation">(</span>
                <span class="token string">'reauthenticate'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">'username'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$t_username</span><span class="token punctuation">,</span>
                <span class="token string">'return'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$t_request_uri</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'&amp;'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token shell-comment comment"># redirect to login page</span>
        <span class="token function">print_header_redirect</span><span class="token punctuation">(</span> <span class="token function">auth_credential_page</span><span class="token punctuation">(</span> <span class="token variable">$t_query_params</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="新建login-cas-php处理拦截利用CAS认证登录"><a href="#新建login-cas-php处理拦截利用CAS认证登录" class="headerlink" title="新建login_cas.php处理拦截利用CAS认证登录"></a>新建<code>login_cas.php</code>处理拦截利用<code>CAS</code>认证登录</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#  vi /var/www/html/mantis/phpCAS/login_cas.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span> <span class="token string">'CAS.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'CAS_ENABLE'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$cas_host</span> <span class="token operator">=</span> <span class="token string">'devops.iamzhl.top'</span><span class="token punctuation">;</span>
<span class="token variable">$cas_context</span> <span class="token operator">=</span> <span class="token string">'/cas'</span><span class="token punctuation">;</span>
<span class="token variable">$cas_port</span> <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>
<span class="token variable">$cas_real_hosts</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
    <span class="token string">'devops.iamzhl.top'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token constant">CAS_VERSION_2_0</span><span class="token punctuation">,</span> <span class="token variable">$cas_host</span><span class="token punctuation">,</span> <span class="token variable">$cas_port</span><span class="token punctuation">,</span> <span class="token variable">$cas_context</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setNoCasServerValidation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">handleLogoutRequests</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$cas_real_hosts</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forceAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改CAS的Client-php启用http连接-根据个人CAS服务器来定"><a href="#修改CAS的Client-php启用http连接-根据个人CAS服务器来定" class="headerlink" title="修改CAS的Client.php启用http连接(根据个人CAS服务器来定)"></a>修改<code>CAS</code>的<code>Client.php</code>启用<code>http</code>连接(根据个人<code>CAS</code>服务器来定)</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/mantis/phpCAS/source/CAS/Client.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>将如下几个函数中的https改为http即可</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">_getServerBaseURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// the URL is build only when needed</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//$this->_server['base_url'] = 'https://' . $this->_getServerHostname();</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> 'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//' . $this->_getServerHostname();</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getServerPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">443</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">':'</span>
                <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getServerPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getServerURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">_getCallbackURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// the URL is built when needed only</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_callback_url</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$final_uri</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// remove the ticket if present in the URL</span>
            <span class="token comment" spellcheck="true">//$final_uri = 'https://';</span>
            <span class="token variable">$final_uri</span> <span class="token operator">=</span> 'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//';</span>
            <span class="token variable">$final_uri</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getClientUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$request_uri</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$request_uri</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/\?.*$/'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$request_uri</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$final_uri</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$request_uri</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_callback_url</span> <span class="token operator">=</span> <span class="token variable">$final_uri</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_callback_url</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>public function getURL()
    {
        phpCAS::traceBegin();
        // the URL is built when needed only
        if ( empty($this-&gt;_url) ) {
            $final_uri = '';
            // remove the ticket if present in the URL
            //$final_uri = ($this-&gt;_isHttps()) ? 'https' : 'http';
            $final_uri = ($this-&gt;_isHttps()) ? 'http' : 'http';
            $final_uri .= '://';

            $final_uri .= $this-&gt;_getClientUrl();
            $request_uri        = explode('?', $_SERVER['REQUEST_URI'], 2);
            $final_uri          .= $request_uri[0];

            if (isset($request_uri[1]) &amp;&amp; $request_uri[1]) {
                $query_string= $this-&gt;_removeParameterFromQueryString('ticket', $request_uri[1]);

                // If the query string still has anything left,
                // append it to the final URI
                if ($query_string !== '') {
                    $final_uri  .= "?$query_string";
                }
            }

            phpCAS::trace("Final URI: $final_uri");
            $this-&gt;setURL($final_uri);
        }
        phpCAS::traceEnd($this-&gt;_url);
        return $this-&gt;_url;
    }</code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><blockquote><p>新建<code>log</code>目录</p></blockquote><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># mkdir /var/log/mantis</span>
<span class="token comment" spellcheck="true"># chown -R apache:apache /var/log/mantis</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>打开<code>MantisBT</code>网址，正常跳转至<code>CAS</code>登录界面，网址是<code>http://devops.iamzhl.top:8080/cas/login?service=http%3A%2F%2Fdevops.iamzhl.top%2Fmantis%2Flogin_page.php</code></p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/fa/f707556ce41d95b71052d07834f5d8.jpg" alt=""></p><p>如图，输入用户名密码后点击登录，正常登陆后跳转至<code>MantisBT</code>主页，并且正常获取用户名</p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/49/1365298ec15c90fbf95612a38606ed.jpg" alt=""></p><p>点击右上角的用户名 -&gt; 注销，会正常退出并跳转到<code>CAS</code>的登出界面</p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/85/2d25e40bdf97b6f06dad6239cf3167.jpg" alt=""></p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="https://blog.tlhub.cn" rel="external nofollow noreferrer">套陆</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://blog.tlhub.cn/MantisBT-integrate-with-ldap-and-CAS.html">https://blog.tlhub.cn/MantisBT-integrate-with-ldap-and-CAS.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.tlhub.cn" target="_blank">套陆</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/CAS/"><span class="chip bg-color">CAS</span></a> <a href="/tags/LDAP/"><span class="chip bg-color">LDAP</span></a> <a href="/tags/MantisBT/"><span class="chip bg-color">MantisBT</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/medias/reward/wechatpay.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/gitalk/gitalk.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/css/my-gitalk.css"><div class="card gitalk-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="gitalk-container" class="card-content"></div></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/gitalk/gitalk.min.js"></script><script>let gitalk = new Gitalk({
        clientID: 'ae84231acb9f9d755d64',
        clientSecret: '999406dd97c504a700abe350a711868e1000fcec',
        repo: 'athlonreg.github.io',
        owner: 'athlonreg',
        admin: "athlonreg",
        id: '2018-12-03T15-07-11',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/TestLink-integrate-with-ldap-and-CAS.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/14/da839143e11bec790a2a77f7247529.jpg" class="responsive-img" alt="TestLink 整合 LDAP 和 CAS 单点登录"> <span class="card-title">TestLink 整合 LDAP 和 CAS 单点登录</span></div></a><div class="card-content article-content"><div class="summary block-with-text">TestLink 整合 LDAP 和 CAS 单点登录</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2018-12-04</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/CI/" class="post-category">CI</a></span></div></div><div class="card-action article-tags"><a href="/tags/CAS/"><span class="chip bg-color">CAS</span></a> <a href="/tags/LDAP/"><span class="chip bg-color">LDAP</span></a> <a href="/tags/TestLink/"><span class="chip bg-color">TestLink</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/Gerrit-integrate-with-ldap-and-CAS.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/79/114d466e1f80823db828265ede65ee.jpg" class="responsive-img" alt="Gerrit 整合 ldap 和 CAS 单点登录"> <span class="card-title">Gerrit 整合 ldap 和 CAS 单点登录</span></div></a><div class="card-content article-content"><div class="summary block-with-text">Gerrit 整合 ldap 和 CAS 单点登录</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2018-12-03</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Linux/" class="post-category">Linux</a></span></div></div><div class="card-action article-tags"><a href="/tags/CAS/"><span class="chip bg-color">CAS</span></a> <a href="/tags/Gerrit/"><span class="chip bg-color">Gerrit</span></a> <a href="/tags/ldap/"><span class="chip bg-color">ldap</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if(void 0!==window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("60"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: 套陆的部落阁<br />文章作者: 套陆<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/codeBlock/codeBlockFuction.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/codeBlock/codeLang.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/codeBlock/codeCopy.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('2'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#b7daff}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="327690691" fixed="true" autoplay theme="#b7daff" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2017</span> <a href="/about" target="_blank">套陆</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">108.3k</span>&nbsp;字 <span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次</span> <span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><script>$(document).ready(function(){var e=setInterval(function(){"none"!=document.getElementById("busuanzi_container_site_pv").style.display&&($("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html())+n),clearInterval(e));"none"!=$("#busuanzi_container_site_pv").css("display")&&($("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html())+n),clearInterval(e))},50),n=2e5})</script><br><span id="sitetime">载入运行时间...</span><script>function siteTime(){var e=36e5,t=24*e,n=new Date,o="2017",r=n.getFullYear(),a=n.getMonth()+1,i=n.getDate(),l=n.getHours(),m=n.getMinutes(),M=n.getSeconds(),g=Date.UTC(o,"6","30","0","0","0"),d=Date.UTC(r,a,i,l,m,M)-g,s=Math.floor(d/31536e6),u=Math.floor(d/t-365*s),T=Math.floor((d-(365*s+u)*t)/e),c=Math.floor((d-(365*s+u)*t-T*e)/6e4),f=Math.floor((d-(365*s+u)*t-T*e-6e4*c)/1e3);o==r?(document.getElementById("year").innerHTML=r,document.getElementById("sitetime").innerHTML="本站已安全运行 "+u+" 天 "+T+" 小时 "+c+" 分钟 "+f+" 秒"):(document.getElementById("year").innerHTML=o+" - "+r,document.getElementById("sitetime").innerHTML="本站已安全运行 "+s+" 年 "+u+" 天 "+T+" 小时 "+c+" 分钟 "+f+" 秒")}setInterval(siteTime,1e3)</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/athlonreg" rel="external nofollow noreferrer" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:1143991340@qq.com" rel="external nofollow noreferrer" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1143991340" rel="external nofollow noreferrer" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1143991340" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/js/search.js"></script><script>$(function(){searchFunc("https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/js/matery.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?849cf4fa113bc36fac5697a548d0e27c";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/others/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/instantpage/instantpage.js" type="module"></script></body></html>