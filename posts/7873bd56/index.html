<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="TestLink,CAS,LDAP"><meta name="description" content=""><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><script data-ad-client="ca-pub-7406269002228687" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><title>TestLink 整合 LDAP 和 CAS 单点登录 | 套陆的博客</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/awesome/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/materialize/materialize.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/aos/aos.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/animate/animate.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/css/matery.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/css/my.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/live2d/autoload.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="套陆的博客" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css"><link rel="stylesheet" href="/css/prism-line-numbers.css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/favicon.ico" class="logo-img" alt="LOGO"> <span class="logo-span">套陆的博客</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/favicon.ico" class="logo-img circle responsive-img"><div class="logo-name">套陆的博客</div><div class="logo-desc">Never really desperate, only the lost of the soul.</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/athlonreg" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/athlonreg" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/cryptojs/crypto-js.min.js"></script><script>(function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();</script><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/medias/featureimages/6.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">TestLink 整合 LDAP 和 CAS 单点登录</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/CAS/"><span class="chip bg-color">CAS</span></a> <a href="/tags/LDAP/"><span class="chip bg-color">LDAP</span></a> <a href="/tags/TestLink/"><span class="chip bg-color">TestLink</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/CI/" class="post-category">CI</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2018-12-04</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i> 更新日期:&nbsp;&nbsp; 2020-04-16</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 1.7k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 9 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i> 阅读次数:&nbsp;&nbsp;<span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><ul><li>TestLink 版本：2.18</li><li>TestLink URL：<a href="http://devops.iamzhl.top/testlink" target="_blank" rel="noopener">http://devops.iamzhl.top/testlink</a></li><li>openLDAP 服务：ldap://devops.iamzhl.top:389</li><li>CAS 服务：<a href="http://devops.iamzhl.top:8080/cas" target="_blank" rel="noopener">http://devops.iamzhl.top:8080/cas</a></li></ul><h2 id="整合-LDAP"><a href="#整合-LDAP" class="headerlink" title="整合 LDAP"></a>整合 LDAP</h2><h3 id="修改TestLink配置文件"><a href="#修改TestLink配置文件" class="headerlink" title="修改TestLink配置文件"></a>修改<code>TestLink</code>配置文件</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/testlink/custom_config.inc.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>添加<code>LDAP</code>配置文件</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'LDAP'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_server'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'devops.iamzhl.top'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'389'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_version'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'3'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_root_dn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'dc=iamzhl,dc=top'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_bind_dn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'cn=Manager,dc=iamzhl,dc=top'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_bind_passwd'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_tls'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_organization'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_uid_field'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'uid'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_email_field'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'mail'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_firstname_field'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'givenname'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ldap_surname_field'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'sn'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap_automatic_user_creation'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap_email_field'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'mail'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap_firstname_field'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'givenname'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'ldap_surname_field'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'sn'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><blockquote><p>打开<code>TestLink</code>网址<code>http://devops.iamzhl.top/testlink</code></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/006dLY5Ily1fxvp6j1abej328s1f8qb2.jpg" alt=""></p><p>如图，正常跳转到<code>TestLink</code>登录界面，输入<code>LDAP</code>服务器中的用户名密码后点击<code>Log in</code></p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/006dLY5Ily1fxvuh6h46uj328s1f8k01.jpg" alt=""></p><p>如图所示，登陆成功后正常的获取到了用户名，点击左上角的登出按钮，正常退出后跳转到了<code>TestLink</code>的登录界面</p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/006dLY5Ily1fxvuj3kqkjj328s1f8gtv.jpg" alt=""></p><p>至此，<code>TestLink</code>整合<code>LDAP</code>完成。</p><h2 id="整合CAS单点登录"><a href="#整合CAS单点登录" class="headerlink" title="整合CAS单点登录"></a>整合<code>CAS</code>单点登录</h2><h3 id="添加依赖的phpCAS库文件"><a href="#添加依赖的phpCAS库文件" class="headerlink" title="添加依赖的phpCAS库文件"></a>添加依赖的<code>phpCAS</code>库文件</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># wget https://github.com/apereo/phpCAS/archive/1.3.6.tar.gz</span>
<span class="token comment" spellcheck="true"># mv 1.3.6.tar.gz phpCAS-1.3.6.tar.gz</span>
<span class="token comment" spellcheck="true"># tar zxvf phpCAS-1.3.6.tar.gz</span>
<span class="token comment" spellcheck="true"># chown -R apache:apache phpCAS-1.3.6</span>
<span class="token comment" spellcheck="true"># cp -arf phpCAS-1.3.6/source/CAS.php /var/www/html/testlink/lib/functions/</span>
<span class="token comment" spellcheck="true"># cp -arf phpCAS-1.3.6/source/CAS /var/www/html/testlink/lib/functions/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改TestLink配置文件-1"><a href="#修改TestLink配置文件-1" class="headerlink" title="修改TestLink配置文件"></a>修改<code>TestLink</code>配置文件</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/testlink/custom_config.inc.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>添加<code>CAS</code>配置项</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">/** CAS server parameters */</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'devops.iamzhl.top'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'cas'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_debug_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_debug_file'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'/var/logs/testlink/phpCAS.log'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_protocol'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'2.0'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改登录界面"><a href="#修改登录界面" class="headerlink" title="修改登录界面"></a>修改登录界面</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/testlink/login.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>在<code>switch($args-&gt;action)</code>分支选择语句段内找到<code>case 'loginform'</code>部分，添加<code>CAS</code>的认证</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">action</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">'doLogin'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'ajaxlogin'</span><span class="token punctuation">:</span>
    <span class="token function">doSessionStart</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// When doing ajax login we need to skip control regarding session already open</span>
    <span class="token comment" spellcheck="true">// that we use when doing normal login.</span>
    <span class="token comment" spellcheck="true">// If we do not proceed this way we will enter an infinite loop</span>
    <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'doSessionExistsCheck'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">action</span><span class="token operator">==</span><span class="token string">'doLogin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token function">doAuthorize</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">login</span><span class="token punctuation">,</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">pwd</span><span class="token punctuation">,</span><span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$doAuthPostProcess</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">draw</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> <span class="token string">'ajaxcheck'</span><span class="token punctuation">:</span>
    <span class="token function">processAjaxCheck</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>


  <span class="token keyword">case</span> <span class="token string">'oauth'</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">//If code is empty then break</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">renderLoginScreen</span><span class="token punctuation">(</span><span class="token variable">$gui</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//Switch between oauth providers</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">include_once</span><span class="token punctuation">(</span><span class="token string">'lib/functions/oauth_providers/'</span><span class="token punctuation">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'oauth'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">'.php'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Oauth client doesn't exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$oau</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span><span class="token string">'OAuthServers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$oau</span> <span class="token keyword">as</span> <span class="token variable">$oprov</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token variable">$oprov</span><span class="token punctuation">[</span><span class="token string">'oauth_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'oauth'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$oauth_params</span> <span class="token operator">=</span> <span class="token variable">$oprov</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$user_token</span> <span class="token operator">=</span> <span class="token function">oauth_get_token</span><span class="token punctuation">(</span><span class="token variable">$oauth_params</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user_token</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">status</span><span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span> <span class="token operator">==</span> tl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">doSessionStart</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token function">doAuthorize</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span><span class="token variable">$user_token</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">options</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">user</span><span class="token punctuation">,</span><span class="token string">'oauth'</span><span class="token punctuation">,</span><span class="token variable">$user_token</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$doAuthPostProcess</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span> <span class="token operator">=</span> <span class="token variable">$user_token</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">status</span><span class="token punctuation">[</span><span class="token string">'msg'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">renderLoginScreen</span><span class="token punctuation">(</span><span class="token variable">$gui</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> <span class="token string">'loginform'</span><span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true">//zhanghl start</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_enable'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>    
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_debug_enable'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
       <span class="token punctuation">{</span>
          phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setDebug</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_debug_file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment" spellcheck="true">// Initialize phpCAS</span>
       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_protocol'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">// For production use set the CA certificate that is the issuer of the cert</span>
       <span class="token comment" spellcheck="true">// on the CAS server and uncomment the line below</span>
       <span class="token comment" spellcheck="true">// phpCAS::setCasServerCACert($cas_server_ca_cert_path);</span>

       <span class="token comment" spellcheck="true">// For quick testing you can disable SSL validation of the CAS server.</span>
       <span class="token comment" spellcheck="true">// THIS SETTING IS NOT RECOMMENDED FOR PRODUCTION.</span>
       <span class="token comment" spellcheck="true">// VALIDATING THE CAS SERVER IS CRUCIAL TO THE SECURITY OF THE CAS PROTOCOL!</span>
       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setNoCasServerValidation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true">// Override the validation url for any (ST and PT) CAS 2.0 validation</span>
       <span class="token comment" spellcheck="true">//phpCAS::setServerProxyValidateURL('http://devops.iamzhl.top:8080/cas/proxyValidate');</span>

       <span class="token comment" spellcheck="true">// Override the validation url for any CAS 1.0 validation</span>
       <span class="token comment" spellcheck="true">//phpCAS::setServerServiceValidateURL('http://devops.iamzhl.top:8080/cas/serviceValidate');</span>

       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">handleLogoutRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forceAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'doSessionExistsCheck'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">action</span><span class="token operator">==</span><span class="token string">'doLogin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token function">doCASAuthorize</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span><span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$doAuthPostProcess</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//zhanghl end</span>
        <span class="token variable">$doRenderLoginScreen</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">draw</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// unfortunatelly we use $args->note in order to do some logic.</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span><span class="token operator">=</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authCfg</span><span class="token punctuation">[</span><span class="token string">'SSO_enabled'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            <span class="token function">doSessionStart</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$doAuthPostProcess</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authCfg</span><span class="token punctuation">[</span><span class="token string">'SSO_method'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
            <span class="token punctuation">{</span>
              <span class="token keyword">case</span> <span class="token string">'CLIENT_CERTIFICATE'</span><span class="token punctuation">:</span>
                <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token function">doSSOClientCertificate</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span><span class="token variable">$_SERVER</span><span class="token punctuation">,</span><span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authCfg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>

              <span class="token keyword">case</span> <span class="token string">'WEBSERVER_VAR'</span><span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true">//DEBUGsyslogOnCloud('Trying to execute SSO using SAML');</span>
                <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token function">doSSOWebServerVar</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span><span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authCfg</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//zhanghl start</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//zhanghl end</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>在<code>init_gui</code>函数内找到<code>switch($args-&gt;note)</code>分支语句，在<code>expired</code>分支下添加一行重定向调用</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'expired'</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">session_unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">session_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span> <span class="token operator">=</span> <span class="token function">lang_get</span><span class="token punctuation">(</span><span class="token string">'session_expired'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">reqURI</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 添加重定向调用</span>
      <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token constant">TL_BASE_HREF</span> <span class="token punctuation">.</span><span class="token string">"login.php?destination="</span><span class="token punctuation">.</span><span class="token variable">$args</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">destination</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">'first'</span><span class="token punctuation">:</span>
      <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span> <span class="token operator">=</span> <span class="token function">lang_get</span><span class="token punctuation">(</span><span class="token string">'your_first_login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">reqURI</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">'lost'</span><span class="token punctuation">:</span>
      <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span> <span class="token operator">=</span> <span class="token function">lang_get</span><span class="token punctuation">(</span><span class="token string">'passwd_lost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">reqURI</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token variable">$gui</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">note</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改登出界面"><a href="#修改登出界面" class="headerlink" title="修改登出界面"></a>修改登出界面</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># /var/www/html/testlink/logout.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>在<code>$authCfg = config_get('authentication');</code>语句之后添加<code>CAS</code>的登出处理</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_enable'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_debug_enable'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
      phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setDebug</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_debug_file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment" spellcheck="true">// Initialize phpCAS</span>
   phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_protocol'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_server_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"login.php?note=logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改common-php全局引用文件"><a href="#修改common-php全局引用文件" class="headerlink" title="修改common.php全局引用文件"></a>修改<code>common.php</code>全局引用文件</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/testlink/lib/functions/common.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>在<code>require_once('tlsmarty.inc.php');</code>引用的前面增加对<code>CAS</code>的引用</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">/** TestLink CAS Authentication Ref */</span>
<span class="token variable">$authCfg</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span><span class="token string">'authentication'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$authCfg</span><span class="token punctuation">[</span><span class="token string">'cas_enable'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">// Load the CAS lib</span>
   <span class="token keyword">require_once</span> <span class="token string">'CAS.php'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/006dLY5Ily1fxvnthnmyaj31p818kn8o.jpg" alt=""></p><h3 id="修改认证函数"><a href="#修改认证函数" class="headerlink" title="修改认证函数"></a>修改认证函数</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/testlink/lib/functions/doAuthorize.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>在开头<code>require_once</code>语句的后面添加<code>CAS</code>认证函数</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">// zhanghl start</span>
<span class="token keyword">function</span> <span class="token function">doCASAuthorize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$db</span><span class="token punctuation">,</span><span class="token variable">$options</span><span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">global</span> <span class="token variable">$g_tlLogger</span><span class="token punctuation">;</span>
   <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'status'</span> <span class="token operator">=</span><span class="token operator">></span> tl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ERROR</span><span class="token punctuation">,</span> <span class="token string">'msg'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">tlUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">login</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'phpCAS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token variable">$login_exists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">readFromDB</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span>tlUser<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">USER_O_SEARCH_BYLOGIN</span><span class="token punctuation">)</span> <span class="token operator">>=</span> tl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$login_exists</span><span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
      <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">tlUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">login</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'phpCAS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">isActive</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span> <span class="token operator">=</span> <span class="token string">'LDAP'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// force for auth_does_password_match</span>
      <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">login</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// write password on DB anyway</span>
   <span class="token punctuation">}</span>
   <span class="token comment" spellcheck="true">//$user->emailAddress = $_SESSION['phpCAS']['attributes']['mail'];</span>
   <span class="token comment" spellcheck="true">//$user->firstName = $_SESSION['phpCAS']['attributes']['sn'];</span>
   <span class="token comment" spellcheck="true">//$user->lastName = $_SESSION['phpCAS']['attributes']['givenName'];</span>
   <span class="token variable">$doLogin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">writeToDB</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">)</span> <span class="token operator">==</span> tl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$doLogin</span> <span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Need to do set COOKIE following Mantis model</span>
      <span class="token variable">$auth_cookie_name</span> <span class="token operator">=</span> <span class="token function">config_get</span><span class="token punctuation">(</span><span class="token string">'auth_cookie'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$expireOnBrowserClose</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token variable">$auth_cookie_name</span><span class="token punctuation">,</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getSecurityCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$expireOnBrowserClose</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// Disallow two sessions within one browser</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'currentUser'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'currentUser'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
         <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">'msg'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">lang_get</span><span class="token punctuation">(</span><span class="token string">'login_msg_session_exists1'</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>
            <span class="token string">' &lt;a style="color:white;" href="logout.php">'</span> <span class="token punctuation">.</span>
            <span class="token function">lang_get</span><span class="token punctuation">(</span><span class="token string">'logout_link'</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/a>'</span> <span class="token punctuation">.</span> <span class="token function">lang_get</span><span class="token punctuation">(</span><span class="token string">'login_msg_session_exists2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">// Setting user's session information</span>
         <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'currentUser'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
         <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'lastActivity'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token variable">$g_tlLogger</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">endTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token variable">$g_tlLogger</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">setUserSession</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">login</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">dbID</span><span class="token punctuation">,</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">globalRoleID</span><span class="token punctuation">,</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">emailAddress</span><span class="token punctuation">,</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">locale</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tl<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OK</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// zhanghl end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改全局配置文件-可选"><a href="#修改全局配置文件-可选" class="headerlink" title="修改全局配置文件 (可选)"></a>修改全局配置文件 (可选)</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/testlink/config.inc.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>增加<code>CAS</code>认证属性</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">/** CAS server properties */</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'cas'</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_debug_enable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_debug_file'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$tlCfg</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">authentication</span><span class="token punctuation">[</span><span class="token string">'cas_server_protocol'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><em>Note：此选项用以设置默认属性值，主要用来日后查阅，可以不写，<code>/var/www/html/testlink/custom_config.inc.php</code>文件相同的属性配置会覆盖生效。</em></strong></p><h3 id="修改CAS的Client-php启用http连接-根据个人CAS服务器来定"><a href="#修改CAS的Client-php启用http连接-根据个人CAS服务器来定" class="headerlink" title="修改CAS的Client.php启用http连接(根据个人CAS服务器来定)"></a>修改<code>CAS</code>的<code>Client.php</code>启用<code>http</code>连接(根据个人<code>CAS</code>服务器来定)</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># vi /var/www/html/testlink/lib/functions/CAS/Client.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>将如下几个函数中的<code>https</code>改为<code>http</code>即可</p></blockquote><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">_getServerBaseURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// the URL is build only when needed</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// $this->_server['base_url'] = 'https://' . $this->_getServerHostname();</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> 'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//' . $this->_getServerHostname();</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getServerPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">443</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">':'</span>
                <span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getServerPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getServerURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_server</span><span class="token punctuation">[</span><span class="token string">'base_url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">_getCallbackURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// the URL is built when needed only</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_callback_url</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$final_uri</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// remove the ticket if present in the URL</span>
        <span class="token comment" spellcheck="true">// $final_uri = 'https://';</span>
        <span class="token variable">$final_uri</span> <span class="token operator">=</span> 'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//';</span>
        <span class="token variable">$final_uri</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getClientUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$request_uri</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$request_uri</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/\?.*$/'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$request_uri</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$final_uri</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$request_uri</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_callback_url</span> <span class="token operator">=</span> <span class="token variable">$final_uri</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_callback_url</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// the URL is built when needed only</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_url</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$final_uri</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// remove the ticket if present in the URL</span>
        <span class="token comment" spellcheck="true">// $final_uri = ($this->_isHttps()) ? 'https' : 'http';</span>
        <span class="token variable">$final_uri</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_isHttps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'http'</span> <span class="token punctuation">:</span> <span class="token string">'http'</span><span class="token punctuation">;</span>
        <span class="token variable">$final_uri</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//';</span>

        <span class="token variable">$final_uri</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_getClientUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$request_uri</span>    <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$final_uri</span>        <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$request_uri</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$request_uri</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$request_uri</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$query_string</span><span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">_removeParameterFromQueryString</span><span class="token punctuation">(</span><span class="token string">'ticket'</span><span class="token punctuation">,</span> <span class="token variable">$request_uri</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// If the query string still has anything left,</span>
            <span class="token comment" spellcheck="true">// append it to the final URI</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$query_string</span> <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$final_uri</span>    <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"?$query_string"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Final URI: $final_uri"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setURL</span><span class="token punctuation">(</span><span class="token variable">$final_uri</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    phpCAS<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_url</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><blockquote><p>新建<code>debug</code>调试目录</p></blockquote><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># mkdir /var/log/testlink</span>
<span class="token comment" spellcheck="true"># chown -R apache:apache /var/log/testlink</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>打开<code>TestLink</code>网址<code>http://devops.iamzhl.top/testlink</code></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/006dLY5Ily1fxvougi1woj32221fcdv4.jpg" alt=""></p><p>如图所示，正常跳转到<code>CAS</code>的登录界面，地址变成了<code>http://devops.iamzhl.top:8080/cas/login?service=http%3A%2F%2Fdevops.iamzhl.top%2Ftestlink%2Flogin.php</code>，输入用户名密码后点击登录</p><p><img src="https://cdn.jsdelivr.net/gh/athlonreg/BlogImages/Images/006dLY5Ily1fxvuh6h46uj328s1f8k01.jpg" alt=""></p><p>如图登陆成功后正常获取用户名，点击左上角的登出按钮后，正常退出到<code>CAS</code>登出页面</p><p>![image-20181205173735167](/Users/canvas/Library/Application Support/typora-user-images/image-20181205173735167.png)</p><p>至此，<code>TestLink</code>整合<code>CAS</code>单点登录完成。</p><script>document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });</script></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="https://blog.cloudops.ml" rel="external nofollow noreferrer">套陆</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://blog.cloudops.ml/posts/7873bd56/">https://blog.cloudops.ml/posts/7873bd56/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.cloudops.ml" target="_blank">套陆</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/CAS/"><span class="chip bg-color">CAS</span></a> <a href="/tags/LDAP/"><span class="chip bg-color">LDAP</span></a> <a href="/tags/TestLink/"><span class="chip bg-color">TestLink</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/medias/reward/wechatpay.jpg" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/gitalk/gitalk.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/css/my-gitalk.css"><div class="card gitalk-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="gitalk-container" class="card-content"></div></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/gitalk/gitalk.min.js"></script><script>let gitalk = new Gitalk({
        clientID: 'ae84231acb9f9d755d64',
        clientSecret: '999406dd97c504a700abe350a711868e1000fcec',
        repo: 'gittalk',
        owner: 'athlonreg',
        admin: "athlonreg",
        id: '2018-12-04T14-55-56',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/posts/e7c2bc73/"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/medias/featureimages/4.jpg" class="responsive-img" alt="高效利用有道云笔记"> <span class="card-title">高效利用有道云笔记</span></div></a><div class="card-content article-content"><div class="summary block-with-text">前言先说几个博主和其他的码字农民工比较头疼的问题 云同步 现在是云的时代，没有云同步的码文环境不是一个好的环境，可能每个人都有不止一个码文平台，比如工作配的机器和私人的机器，我在其中一台机器写好的文章还要再写一份到另外的机器。。。简直不</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2019-01-20</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Study/" class="post-category">Study</a></span></div></div><div class="card-action article-tags"><a href="/tags/%E5%9B%BE%E5%BA%8A/"><span class="chip bg-color">图床</span></a> <a href="/tags/%E6%9C%89%E9%81%93%E4%BA%91%E7%AC%94%E8%AE%B0/"><span class="chip bg-color">有道云笔记</span></a> <a href="/tags/Picbed/"><span class="chip bg-color">Picbed</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/4b6afd89/"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/medias/featureimages/20.jpg" class="responsive-img" alt="MantisBT 整合 LDAP 和 CAS 单点登录"> <span class="card-title">MantisBT 整合 LDAP 和 CAS 单点登录</span></div></a><div class="card-content article-content"><div class="summary block-with-text">背景介绍 MantisBT 版本：2.18 Mantis URL：http://devops.iamzhl.top/mantis openLDAP 服务：ldap://devops.iamzhl.top:389 CAS 服务：http://</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2018-12-03</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/CI/" class="post-category">CI</a></span></div></div><div class="card-action article-tags"><a href="/tags/CAS/"><span class="chip bg-color">CAS</span></a> <a href="/tags/LDAP/"><span class="chip bg-color">LDAP</span></a> <a href="/tags/MantisBT/"><span class="chip bg-color">MantisBT</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if(void 0!==window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: 套陆的博客<br />文章作者: 套陆<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/codeBlock/codeBlockFuction.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/codeBlock/codeLang.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/codeBlock/codeCopy.js"></script><style>code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:0!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2017</span> <a href="https://blog.cloudops.ml" target="_blank">套陆</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">68.9k</span>&nbsp;字 <span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次</span> <span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/athlonreg" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:1143991340@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1143991340" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1143991340" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/js/search.js"></script><script>$(function(){searchFunc("https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/js/matery.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/others/busuanzi.pure.mini.js"></script><script color="0,0,255" pointcolor="0,0,255" opacity="0.7" zindex="-1" count="99" src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/background/canvas-nest.js"></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/background/ribbon-dynamic.js" async></script><script src="https://cdn.jsdelivr.net/gh/athlonreg/athlonreg.github.io/libs/instantpage/instantpage.js" type="module"></script></body></html>